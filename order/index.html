<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobix | ثبت سفارش و پیگیری</title>

  <meta name="description" content="موبیکس؛ ثبت سفارش تعمیر موبایل، پیگیری مرحله‌ای، اعلام قیمت و تأیید دو مرحله‌ای." />
  <meta name="theme-color" content="#1F6AFF" />
  <link rel="icon" href="../assets/logo.png" />

  <!-- Vazirmatn -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F6F8FC;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#5B6B84;
      --line:rgba(15,23,42,.08);

      --shadow: 0 14px 36px rgba(15,23,42,.10);
      --shadow2: 0 8px 18px rgba(15,23,42,.08);

      --radius:20px;

      --primary:#1F6AFF;
      --primary2:#3B82F6;
      --success:#10B981;
      --danger:#EF4444;
      --warn:#F59E0B;

      --max:1160px;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:"Vazirmatn", system-ui, sans-serif;
      background:
        radial-gradient(1000px 500px at 80% -10%, rgba(31,106,255,.16), transparent 55%),
        radial-gradient(900px 600px at 20% 10%, rgba(59,130,246,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{text-decoration:none;color:inherit}
    img{max-width:100%;display:block}

    .container{
      max-width:var(--max);
      margin:auto;
      padding:14px 16px 56px;
    }

    /* TOP BAR */
    .topbar{
      position:sticky;top:0;z-index:50;
      padding:10px 0;
      backdrop-filter: blur(12px);
    }
    .topbar-inner{
      display:flex;align-items:center;justify-content:space-between;
      background:rgba(246,248,252,.86);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      gap:10px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{width:72px;height:auto}
    .brand-title{
      display:flex;flex-direction:column;gap:2px;min-width:0
    }
    .brand-title b{
      font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .brand-title span{
      font-weight:800;font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }

    .nav{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      padding:10px 16px;
      border-radius:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-family:inherit;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;
      border:none;
    }
    .btn.ghost{
      background:rgba(255,255,255,.72);
    }
    .btn.danger{
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      color:#7F1D1D;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .hero{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:980px){.hero{grid-template-columns:1fr}}

    h1{
      font-size:38px;
      font-weight:900;
      margin:0 0 6px;
      letter-spacing:-.3px;
      line-height:1.25;
    }
    @media(max-width:520px){h1{font-size:30px}}

    .sub{
      color:var(--muted);
      font-size:15px;
      line-height:1.9;
      margin:0;
    }

    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:900;
      font-size:12.8px;
      white-space:nowrap;
    }
    .status.ok{border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.08);color:#0B3A2C}
    .status.err{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:#7F1D1D}
    .status.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:#78350F}

    .divider{height:1px;background:var(--line);margin:12px 0}

    /* GRID */
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media(max-width:980px){.grid-2{grid-template-columns:1fr}}

    /* FORMS */
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
    }
    .label{
      font-size:13px;
      font-weight:900;
      color:var(--muted);
    }
    .input{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:800;
      outline:none;
    }
    .textarea{
      width:100%;
      min-height:110px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:800;
      outline:none;
      resize:vertical;
      line-height:1.9;
    }
    .formrow{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
    }
    @media(max-width:520px){.formrow{grid-template-columns:1fr}}

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.75;
      white-space:pre-line;
    }

    /* OTP box */
    .otp-box{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      box-shadow:var(--shadow2);
    }
    .timerbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-top:8px;
    }

    /* Terms checkbox */
    .checkrow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      box-shadow:var(--shadow2);
      margin-top:10px;
    }
    .checkrow input{
      margin-top:2px;
      width:18px;height:18px;
      accent-color: var(--primary);
      flex:0 0 auto;
    }
    .checkrow b{
      font-weight:900;
      font-size:13.5px;
      display:block;
      margin-bottom:2px;
    }
    .checkrow span{
      color:var(--muted);
      font-size:12.8px;
      line-height:1.7;
      display:block;
    }

    /* Quick issues */
    .quick-issues{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .qchip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.72);
      font-weight:900;
      font-size:12.8px;
      cursor:pointer;
      box-shadow:var(--shadow2);
      user-select:none;
    }

    /* Replacement phone line */
    .replacement-note{
      margin-top:8px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(245,158,11,.25);
      background:rgba(245,158,11,.10);
      color:#78350F;
      font-weight:900;
      line-height:1.8;
    }

    /* Orders */
    .orders{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .order-item{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .order-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .order-top b{font-weight:900}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(31,106,255,.10);
      border:1px solid rgba(31,106,255,.18);
      color:#0B2A6A;
      font-weight:900;
      font-size:12.5px;
      white-space:nowrap;
    }
    .muted{color:var(--muted);font-size:13.2px;line-height:1.9}

    /* Tracking */
    .track{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      margin-top:4px;
    }
    .track-step{
      display:flex;
      align-items:flex-start;
      gap:10px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:16px;
      padding:10px;
    }
    .track-bullet{
      width:28px;height:28px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }
    .track-step.done .track-bullet{
      background:rgba(16,185,129,.10);
      border-color:rgba(16,185,129,.25);
      color:#0B3A2C;
    }
    .track-step.active .track-bullet{
      background:rgba(31,106,255,.10);
      border-color:rgba(31,106,255,.25);
      color:#0B2A6A;
    }
    .track-step .tt b{display:block;font-weight:900}
    .track-step .tt span{display:block;color:var(--muted);font-size:13px;line-height:1.85;margin-top:3px}

    /* Footer (simple here; you said later it should match home - we keep clean now) */
    .footer{
      margin-top:18px;
      padding-top:14px;
      border-top:1px solid var(--line);
      font-size:13px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .enamad{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .enamad img{width:110px;height:auto}

    @media (max-width: 520px){
      .topbar-inner{border-radius:22px;padding:10px 10px}
      .brand img{width:60px}
      h1{font-size:28px}
      .card{padding:14px}
      .container{padding-bottom:40px}
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- HEADER -->
    <div class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="../">
          <img src="../assets/logo.png" alt="Mobix">
          <div class="brand-title">
            <b>موبیکس</b>
            <span>سرویس تخصصی تعمیر موبایل</span>
          </div>
        </a>

        <div class="nav">
          <a class="btn primary" href="./" id="navOrderBtn">ثبت سفارش</a>
          <button class="btn danger" type="button" id="navLogoutBtn" style="display:none">خروج</button>
        </div>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero">
      <div class="card">
        <h1>ورود، ثبت سفارش و پیگیری</h1>
        <p class="sub">با کد پیامکی وارد شوید و وضعیت سفارش را مرحله‌به‌مرحله ببینید.</p>
        <div class="divider"></div>
        <div id="sessionBadge" class="status warn">وارد نشده‌اید</div>
      </div>

      <div class="card" id="guideCard">
        <h1 style="font-size:22px;margin:0 0 6px;font-weight:900">راهنما</h1>
        <p class="sub" style="margin-top:6px">
          ورود با کد پیامکی، ثبت درخواست، پیگیری مرحله‌ای، اعلام قیمت و تأیید دو مرحله‌ای.
        </p>
        <div class="divider"></div>
        <div class="muted">
          • بعد از ورود، نام شما یک‌بار ثبت می‌شود و برای سفارش‌های بعدی نیاز نیست دوباره وارد کنید.<br>
          • هر زمان قیمت اعلام شود، داخل همین صفحه در سفارش‌های شما نمایش داده می‌شود.
        </div>
      </div>
    </section>

    <div class="grid-2">

      <!-- AUTH CARD -->
      <div class="card" id="authCard">
        <h1 style="font-size:20px;margin:0 0 6px;font-weight:900">ورود با کد پیامکی</h1>
        <p class="sub" style="font-size:14.5px">کد یکبار مصرف ارسال می‌شود.</p>

        <div class="field">
          <div class="label">شماره موبایل</div>
          <input id="authPhone" class="input" inputmode="numeric" placeholder="مثلاً 0912xxxxxxx" />
        </div>

        <div class="checkrow">
          <input id="termsAccepted" type="checkbox" />
          <div>
            <b>قوانین موبیکس پذیرفته می‌شود</b>
            <span>با ارسال کد، قوانین و شرایط سرویس موبیکس را می‌پذیرید.</span>
          </div>
        </div>

        <div class="formrow">
          <button id="sendOtpBtn" class="btn primary" type="button">ارسال کد</button>
          <button id="logoutBtn" class="btn danger" type="button" style="display:none">خروج</button>
        </div>

        <div id="otpWrap" class="otp-box" style="display:none">
          <div class="field" style="margin-top:0">
            <div class="label">کد پیامکی</div>
            <input id="authCode" class="input" inputmode="numeric" placeholder="کد ۶ رقمی" />
          </div>

          <div class="timerbar">
            <div id="timerPill" class="status warn">02:00</div>
            <button id="resendBtn" class="btn ghost" type="button" disabled>ارسال مجدد</button>
          </div>

          <div class="formrow">
            <button id="verifyOtpBtn" class="btn primary" type="button">تایید و ورود</button>
            <span class="status" id="otpHint" style="justify-self:start">پس از ورود، نام شما پرسیده می‌شود</span>
          </div>
        </div>

        <div id="authMsg" class="hint" aria-live="polite"></div>
      </div>

      <!-- RIGHT COLUMN: PROFILE + ORDER + ORDERS -->
      <div class="card" id="mainCard">

        <!-- Greeting -->
        <div class="order-top">
          <h1 style="font-size:20px;margin:0;font-weight:900">ثبت سفارش</h1>
          <div id="helloBadge" class="status" style="display:none"></div>
        </div>
        <p class="sub" style="margin-top:6px">بعد از ورود، سفارش ثبت کنید و سفارش‌های قبلی را ببینید.</p>

        <div class="divider"></div>

        <!-- Profile (ask name after login) -->
        <div id="profileCard" style="display:none">
          <div class="order-top">
            <b style="font-weight:900">تکمیل مشخصات</b>
            <span class="status warn">یک‌بار برای همیشه</span>
          </div>

          <div class="field">
            <div class="label">نام و نام خانوادگی</div>
            <!-- FIX #1: do NOT use Kamyar or any personal name -->
            <input id="fullName" class="input" placeholder="نام و نام خانوادگی" value="" />
          </div>

          <div class="formrow">
            <button id="saveProfileBtn" class="btn primary" type="button">ذخیره</button>
            <span class="status" id="profileMsg" style="display:none"></span>
          </div>

          <div class="divider"></div>
        </div>

        <!-- Order form -->
        <div id="orderFormWrap">
          <div class="order-top">
            <b style="font-weight:900">اطلاعات سفارش</b>
            <span id="orderGate" class="status warn">برای ارسال نهایی باید وارد شوید</span>
          </div>

          <div class="field">
            <div class="label">مدل گوشی</div>
            <input id="deviceModel" class="input" placeholder="مثلاً iPhone 13 / Galaxy A52" />
          </div>

          <div class="checkrow" aria-label="گوشی جایگزین">
            <input id="replacementPhone" type="checkbox" />
            <div>
              <b>نیاز به گوشی جایگزین دارم</b>
              <span>اگر در زمان تعمیر نیاز دارید، این گزینه را فعال کنید.</span>
            </div>
          </div>

          <div class="field">
            <div class="label">مشکل دستگاه</div>
            <textarea id="problemDesc" class="textarea" placeholder="مثلاً شکستگی ال‌سی‌دی / مشکل شارژ / خاموشی ..."></textarea>
            <div class="quick-issues" aria-label="مشکلات رایج">
              <div class="qchip" data-issue="شکستگی/خط روی ال‌سی‌دی">شکستگی LCD</div>
              <div class="qchip" data-issue="مشکل شارژ/سوکت شارژ">مشکل شارژ</div>
              <div class="qchip" data-issue="باتری ضعیف/زود خالی می‌کند">باتری</div>
              <div class="qchip" data-issue="آب‌خوردگی">آب‌خوردگی</div>
              <div class="qchip" data-issue="خاموشی/ریست شدن">خاموشی/ریست</div>
              <div class="qchip" data-issue="مشکل صدا/میکروفن">صدا/میکروفن</div>
            </div>
          </div>

          <div class="field">
            <div class="label">آدرس برای دریافت با پیک</div>
            <textarea id="address" class="textarea" placeholder="آدرس دقیق + پلاک + واحد"></textarea>
          </div>

          <div class="field">
            <div class="label">زمان پیشنهادی برای دریافت</div>
            <input id="pickupTime" class="input" placeholder="مثلاً امروز ۱۸ تا ۲۰ / فردا صبح" />
          </div>

          <div class="formrow">
            <button id="createOrderBtn" class="btn primary" type="button">ثبت سفارش</button>
            <button id="refreshOrdersBtn" class="btn ghost" type="button">به‌روزرسانی</button>
          </div>

          <div id="orderMsg" class="hint" aria-live="polite"></div>

          <div class="divider"></div>
        </div>

        <!-- Orders -->
        <div class="order-top">
          <b style="font-weight:900">سفارش‌های من</b>
          <span id="ordersCount" class="status">0</span>
        </div>

        <div id="ordersWrap" class="orders">
          <div class="muted">بعد از ورود، سفارش‌های شما اینجا نمایش داده می‌شود.</div>
        </div>

      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      <span>© Mobix</span>
      <div class="enamad">
        <!-- Enamad -->
        <a referrerpolicy="origin" target="_blank" href="https://trustseal.enamad.ir/?id=5414923&Code=DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf">
          <img referrerpolicy="origin" src="https://trustseal.enamad.ir/logo.aspx?id=5414923&Code=DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf" alt="اینماد" style="cursor:pointer" code="DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf">
        </a>
      </div>
      <span></span>
    </div>

  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    (function(){
      // =========================
      // Supabase Config
      // =========================
      const SUPABASE_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyeGZoZmtubXhtZWF0bmZ6cGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTg2MjksImV4cCI6MjA4MTgzNDYyOX0.iANOG9-g9GnVl58KDYI0A-oYNwfbL3oh2NBddZ2sLLs";

      const OTP_REQUEST_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/request-otp";
      const OTP_VERIFY_URL  = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/verify-otp";

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // =========================
      // Helpers
      // =========================
      function normalizeDigits(s){
        return (s || "")
          .replace(/[۰-۹]/g, d => "۰۱۲۳۴۵۶۷۸۹".indexOf(d))
          .replace(/[^\d]/g, "");
      }
      function isValidIranMobile(d){
        if(!d) return false;
        if(d.length === 11 && d.startsWith("09")) return true;
        if(d.length === 10 && d.startsWith("9")) return true;
        return false;
      }
      function to09(d){
        if(!d) return null;
        if(d.length === 11 && d.startsWith("09")) return d;
        if(d.length === 10 && d.startsWith("9")) return "0" + d;
        return null;
      }
      function fmtDate(iso){
        try{
          const dt = new Date(iso);
          if(isNaN(dt.getTime())) return iso || "";
          return dt.toLocaleString("fa-IR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        }catch(e){ return iso || ""; }
      }
      function esc(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      async function safeJson(res){
        try{ return await res.json(); }catch(e){ return null; }
      }
      function extractErrorMessage(obj){
        if(!obj) return null;
        if(typeof obj === "string") return obj;
        return obj.message || obj.error || (obj.errors && obj.errors[0] && (obj.errors[0].message || obj.errors[0])) || null;
      }
      function formatToman(n){
        const x = Number(n || 0);
        if(!Number.isFinite(x) || x <= 0) return null;
        return x.toLocaleString("fa-IR") + " تومان";
      }

      // ✅ order_no: MCC-YYMMDD-XXXX
      function genOrderNo(){
        const d = new Date();
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const rand = String(Math.floor(1000 + Math.random()*9000));
        return `MCC-${yy}${mm}${dd}-${rand}`;
      }

      // =========================
      // UI Elements
      // =========================
      const sessionBadge = document.getElementById("sessionBadge");

      const guideCard = document.getElementById("guideCard");

      const authCard = document.getElementById("authCard");
      const authPhone = document.getElementById("authPhone");
      const authCode = document.getElementById("authCode");
      const termsAccepted = document.getElementById("termsAccepted");
      const sendOtpBtn = document.getElementById("sendOtpBtn");
      const verifyOtpBtn = document.getElementById("verifyOtpBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const resendBtn = document.getElementById("resendBtn");
      const otpWrap = document.getElementById("otpWrap");
      const authMsg = document.getElementById("authMsg");
      const timerPill = document.getElementById("timerPill");

      const navLogoutBtn = document.getElementById("navLogoutBtn");

      const profileCard = document.getElementById("profileCard");
      const fullName = document.getElementById("fullName");
      const saveProfileBtn = document.getElementById("saveProfileBtn");
      const profileMsg = document.getElementById("profileMsg");
      const helloBadge = document.getElementById("helloBadge");

      const orderGate = document.getElementById("orderGate");
      const deviceModel = document.getElementById("deviceModel");
      const replacementPhone = document.getElementById("replacementPhone");
      const problemDesc = document.getElementById("problemDesc");
      const address = document.getElementById("address");
      const pickupTime = document.getElementById("pickupTime");
      const createOrderBtn = document.getElementById("createOrderBtn");
      const refreshOrdersBtn = document.getElementById("refreshOrdersBtn");
      const orderMsg = document.getElementById("orderMsg");

      const ordersWrap = document.getElementById("ordersWrap");
      const ordersCount = document.getElementById("ordersCount");

      // =========================
      // State
      // =========================
      const LS_LOGIN = "mobix_site_login";
      const LS_PROFILE = "mobix_site_profile";
      const DRAFT_KEY = "mobix_site_order_draft";

      let loginState = null;   // { phone09 }
      let profileState = null; // { full_name }

      let lastPhone09 = null;
      let timerId = null;
      let remaining = 0;

      // =========================
      // UI Helpers
      // =========================
      function setStatus(el, type, text){
        el.classList.remove("ok","err","warn");
        if(type) el.classList.add(type);
        el.textContent = text;
      }
      function setMsg(el, type, text){
        if(!text){
          el.textContent = "";
          el.style.color = "var(--muted)";
          return;
        }
        if(type === "ok") el.style.color = "var(--success)";
        else if(type === "err") el.style.color = "var(--danger)";
        else if(type === "warn") el.style.color = "var(--warn)";
        else el.style.color = "var(--muted)";
        el.textContent = text;
      }

      function loggedIn(){
        return !!(loginState && loginState.phone09);
      }
      function hasProfileName(){
        const n = (profileState && profileState.full_name) ? String(profileState.full_name).trim() : "";
        return n.length >= 2;
      }

      // =========================
      // Draft
      // =========================
      function saveDraft(){
        const draft = {
          device_model: (deviceModel.value || "").trim(),
          wants_replacement_phone: !!(replacementPhone && replacementPhone.checked),
          issue: (problemDesc.value || "").trim(),
          pickup_address: (address.value || "").trim(),
          pickup_time_text: (pickupTime.value || "").trim()
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      }
      function loadDraft(){
        try{
          const raw = localStorage.getItem(DRAFT_KEY);
          if(!raw) return;
          const d = JSON.parse(raw);
          if(d && typeof d === "object"){
            if(d.device_model != null) deviceModel.value = d.device_model;
            if(d.wants_replacement_phone != null && replacementPhone) replacementPhone.checked = !!d.wants_replacement_phone;
            if(d.issue != null) problemDesc.value = d.issue;
            if(d.pickup_address != null) address.value = d.pickup_address;
            if(d.pickup_time_text != null) pickupTime.value = d.pickup_time_text;
          }
        }catch(_e){}
      }

      // =========================
      // Timer (120s)
      // =========================
      function formatMMSS(sec){
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
      }
      function stopTimer(){
        if(timerId) clearInterval(timerId);
        timerId = null;
      }
      function startTimer(seconds){
        stopTimer();
        remaining = seconds;
        resendBtn.disabled = true;
        setStatus(timerPill, "warn", formatMMSS(remaining));

        timerId = setInterval(() => {
          remaining -= 1;
          if(remaining <= 0){
            stopTimer();
            setStatus(timerPill, "ok", "00:00");
            resendBtn.disabled = false;
            return;
          }
          setStatus(timerPill, "warn", formatMMSS(remaining));
        }, 1000);
      }

      // =========================
      // Edge calls
      // =========================
      async function requestOtpEdge(phone09){
        const res = await fetch(OTP_REQUEST_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09 })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "ارسال کد ناموفق بود");
        }
        return json || { ok: true, expires_in_seconds: 120 };
      }

      async function verifyOtpEdge(phone09, code){
        const res = await fetch(OTP_VERIFY_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09, code })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "ورود ناموفق بود");
        }
        return json || { ok: true };
      }

      // =========================
      // Status mapping (FIX #4)
      // =========================
      const STATUS_FA = {
        requested: "ثبت شده",
        received: "دریافت شده",
        picked_up: "دریافت با پیک",
        courier_pickup: "دریافت با پیک",
        quoted: "اعلام قیمت",
        repairing: "در حال تعمیر",
        delivering: "در مسیر تحویل",
        delivered: "تحویل شده",
        rejected: "رد شده",
        canceled: "لغو شده"
      };

      const TRACK_STEPS = [
        { key:"requested", title:"ثبت درخواست", desc:"درخواست شما ثبت شد و در حال بررسی است." },
        { key:"picked_up", title:"دریافت با پیک", desc:"پیک موبیکس دستگاه را دریافت کرد." },
        { key:"quoted", title:"اعلام/تأیید هزینه", desc:"هزینه اعلام شد و منتظر تایید شماست." },
        { key:"repairing", title:"در حال تعمیر", desc:"تکنسین موبیکس در حال انجام تعمیر است." },
        { key:"delivering", title:"ارسال برای تحویل", desc:"دستگاه آماده شده و در مسیر تحویل است." },
        { key:"delivered", title:"تحویل به شما", desc:"دستگاه تحویل داده شد ✅" }
      ];

      function normalizeStatus(raw){
        const s = (raw || "").toString().trim().toLowerCase();
        if(["new","created","request","requested","pending"].includes(s)) return "requested";
        if(["pickup","pickedup","picked_up","courier_pickup","received"].includes(s)) return s === "received" ? "picked_up" : "picked_up";
        if(["quote","quoted","price","awaiting_approval","approved_pending"].includes(s)) return "quoted";
        if(["repair","repairing","in_repair","fixing"].includes(s)) return "repairing";
        if(["deliver","delivering","shipping","on_the_way"].includes(s)) return "delivering";
        if(["done","delivered","completed","complete"].includes(s)) return "delivered";
        if(["reject","rejected","declined"].includes(s)) return "rejected";
        if(["cancel","canceled","cancelled"].includes(s)) return "canceled";
        return s || "requested";
      }

      function statusLabelFa(raw){
        const k = normalizeStatus(raw);
        return STATUS_FA[k] || k;
      }

      function stepIndex(key){
        const idx = TRACK_STEPS.findIndex(x => x.key === key);
        return idx < 0 ? 0 : idx;
      }

      function renderTrack(statusKey){
        const norm = normalizeStatus(statusKey);
        const activeIdx = stepIndex(norm);
        return `
          <div class="track">
            ${TRACK_STEPS.map((s, i) => {
              const cls = i < activeIdx ? "done" : (i === activeIdx ? "active" : "");
              const bullet = i < activeIdx ? "✓" : (i === activeIdx ? "•" : (i+1));
              return `
                <div class="track-step ${cls}">
                  <div class="track-bullet">${bullet}</div>
                  <div class="tt">
                    <b>${esc(s.title)}</b>
                    <span>${esc(s.desc)}</span>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }

      // =========================
      // UI Apply (FIX #3: guide only before login)
      // =========================
      function applyLoginUI(){
        const li = loggedIn();

        if(li){
          setStatus(sessionBadge, "ok", "وارد شده‌اید ✅");
          if(authCard) authCard.style.display = "none";
          if(navLogoutBtn) navLogoutBtn.style.display = "";
          setStatus(orderGate, "ok", "می‌توانید سفارش را ارسال کنید");

          // FIX #3: show guide before login, after login remove/hide it
          if(guideCard){
            guideCard.style.display = "none";
          }

          // show greeting if name exists
          if(hasProfileName()){
            helloBadge.style.display = "";
            helloBadge.className = "status ok";
            helloBadge.textContent = "سلام، " + profileState.full_name;
          }else{
            helloBadge.style.display = "none";
          }

          // show profile card if name missing
          profileCard.style.display = hasProfileName() ? "none" : "";

        }else{
          setStatus(sessionBadge, "warn", "وارد نشده‌اید");
          if(authCard) authCard.style.display = "";
          if(navLogoutBtn) navLogoutBtn.style.display = "none";
          setStatus(orderGate, "warn", "برای ارسال نهایی باید وارد شوید");

          // FIX #3: guide visible before login
          if(guideCard){
            guideCard.style.display = "";
          }

          profileCard.style.display = "none";
          helloBadge.style.display = "none";

          ordersWrap.innerHTML = '<div class="muted">بعد از ورود، سفارش‌های شما اینجا نمایش داده می‌شود.</div>';
          ordersCount.textContent = "0";
        }
      }

      // =========================
      // Actions: Auth
      // =========================
      async function sendOtp(){
        setMsg(authMsg, "", "");

        if(!termsAccepted.checked){
          setMsg(authMsg, "err", "برای ادامه، باید قوانین موبیکس را بپذیرید.");
          return;
        }

        const d = normalizeDigits(authPhone.value);
        if(!isValidIranMobile(d)){
          setMsg(authMsg, "err", "شماره موبایل درست نیست. مثل 0912xxxxxxx وارد کنید.");
          return;
        }
        const phone09 = to09(d);
        if(!phone09){
          setMsg(authMsg, "err", "شماره قابل تبدیل نیست. لطفاً دوباره تلاش کنید.");
          return;
        }

        sendOtpBtn.disabled = true;
        resendBtn.disabled = true;
        setMsg(authMsg, "warn", "در حال ارسال کد…");

        try{
          const out = await requestOtpEdge(phone09);
          lastPhone09 = phone09;

          otpWrap.style.display = "";
          setMsg(authMsg, "ok", "کد ارسال شد ✅");

          const secs = Number(out?.expires_in_seconds ?? 120);
          startTimer(Number.isFinite(secs) ? secs : 120);

          authCode.focus();
        }catch(err){
          setMsg(authMsg, "err", "ارسال کد ناموفق بود: " + (err?.message || "خطای نامشخص"));
          otpWrap.style.display = "none";
          stopTimer();
        }finally{
          sendOtpBtn.disabled = false;
        }
      }

      async function verifyOtp(){
        setMsg(authMsg, "", "");
        const code = normalizeDigits(authCode.value);

        if(!lastPhone09){
          setMsg(authMsg, "err", "اول شماره را وارد کنید و کد را ارسال کنید.");
          return;
        }
        if(!code || code.length < 4){
          setMsg(authMsg, "err", "کد پیامکی را درست وارد کنید.");
          return;
        }

        verifyOtpBtn.disabled = true;
        setMsg(authMsg, "warn", "در حال تایید کد…");

        try{
          await verifyOtpEdge(lastPhone09, code);

          loginState = { phone09: lastPhone09 };
          localStorage.setItem(LS_LOGIN, JSON.stringify(loginState));

          authCode.value = "";
          setMsg(authMsg, "ok", "ورود انجام شد ✅");

          applyLoginUI();
          loadDraft();
          await loadOrders();
        }catch(err){
          setMsg(authMsg, "err", "ورود ناموفق بود: " + (err?.message || "خطای نامشخص"));
        }finally{
          verifyOtpBtn.disabled = false;
        }
      }

      async function resend(){
        if(resendBtn.disabled) return;
        if(!lastPhone09){
          setMsg(authMsg, "err", "اول شماره را وارد کنید.");
          return;
        }
        authPhone.value = lastPhone09;
        await sendOtp();
      }

      function logout(){
        setMsg(authMsg, "", "");
        loginState = null;
        localStorage.removeItem(LS_LOGIN);
        lastPhone09 = null;

        otpWrap.style.display = "none";
        stopTimer();

        setMsg(authMsg, "ok", "خارج شدید.");
        applyLoginUI();
      }

      // =========================
      // Profile (ask name after login)
      // =========================
      function loadProfile(){
        try{
          const raw = localStorage.getItem(LS_PROFILE);
          profileState = raw ? JSON.parse(raw) : null;
          if(!profileState || typeof profileState !== "object") profileState = null;
        }catch(_e){
          profileState = null;
        }
      }

      function saveProfile(){
        const n = (fullName.value || "").trim();
        if(n.length < 2){
          profileMsg.style.display = "";
          profileMsg.className = "status err";
          profileMsg.textContent = "نام و نام خانوادگی را درست وارد کنید.";
          return false;
        }
        profileState = { full_name: n };
        localStorage.setItem(LS_PROFILE, JSON.stringify(profileState));

        profileMsg.style.display = "";
        profileMsg.className = "status ok";
        profileMsg.textContent = "ذخیره شد ✅";

        helloBadge.style.display = "";
        helloBadge.className = "status ok";
        helloBadge.textContent = "سلام، " + profileState.full_name;

        profileCard.style.display = "none";
        return true;
      }

      // =========================
      // Order create
      // =========================
      function buildIssueWithExtras(baseIssue){
        const wants = !!(replacementPhone && replacementPhone.checked);
        if(!wants) return baseIssue;
        const suffix = "نیاز به گوشی جایگزین: بله";
        const cur = (baseIssue || "").trim();
        if(!cur) return suffix;
        if(cur.includes(suffix)) return cur;
        return cur + (cur.endsWith("،") || cur.endsWith(",") ? " " : "، ") + suffix;
      }

      async function createOrder(){
        setMsg(orderMsg, "", "");

        const dm = (deviceModel.value || "").trim();
        const issueRaw = (problemDesc.value || "").trim();
        const issue = buildIssueWithExtras(issueRaw);
        const addr = (address.value || "").trim();
        const pt = (pickupTime.value || "").trim();

        if(!loggedIn()){
          setMsg(orderMsg, "warn", "برای ارسال نهایی باید وارد شوید.");
          return;
        }
        if(!hasProfileName()){
          setMsg(orderMsg, "warn", "اول نام و نام خانوادگی را ذخیره کنید.");
          profileCard.style.display = "";
          fullName.focus();
          return;
        }

        if(!dm || !issue || !addr){
          setMsg(orderMsg, "err", "مدل گوشی، مشکل و آدرس را کامل وارد کنید.");
          return;
        }

        createOrderBtn.disabled = true;
        setMsg(orderMsg, "warn", "در حال ثبت سفارش…");

        const payload = {
          order_no: genOrderNo(),
          customer_phone: loginState.phone09,
          customer_name: profileState.full_name,
          device_model: dm,
          issue: issue,
          pickup_address: addr,
          pickup_time_text: pt || null,
          delivery_method: "courier",
          needs_issue_photo: false,
          stage: "requested",
          quoted_price_toman: 0,
          price_approved: false,
          price_approved: false,
          // your table has: needs_loaner_phone (boolean)
          needs_loaner_phone: !!(replacementPhone && replacementPhone.checked)
        };

        try{
          const { data, error } = await supabase
            .from("orders")
            .insert(payload)
            .select("*")
            .single();

          if(error){
            console.error("Insert error:", error);
            setMsg(orderMsg, "err", "ثبت سفارش ناموفق بود: " + (error.message || "خطای نامشخص"));
            return;
          }

          if(!data){
            setMsg(orderMsg, "warn", "سفارش ثبت شد ولی پاسخی برنگشت. لطفاً «به‌روزرسانی» را بزنید.");
          }else{
            setMsg(orderMsg, "ok", "سفارش ثبت شد ✅");
          }

          deviceModel.value = "";
          if(replacementPhone) replacementPhone.checked = false;
          problemDesc.value = "";
          address.value = "";
          pickupTime.value = "";
          localStorage.removeItem(DRAFT_KEY);

          await loadOrders();
        }catch(e){
          console.error("Create order exception:", e);
          setMsg(orderMsg, "err", "ثبت سفارش ناموفق بود: " + (e?.message || "خطای نامشخص"));
        }finally{
          createOrderBtn.disabled = false;
        }
      }

      // =========================
      // Load orders (FIX #4 and FIX #5)
      // =========================
      async function loadOrders(){
        if(!loggedIn()){
          ordersCount.textContent = "0";
          return;
        }

        ordersWrap.innerHTML = '<div class="muted">در حال دریافت سفارش‌ها…</div>';

        const { data, error } = await supabase
          .from("orders")
          .select("*")
          .eq("customer_phone", loginState.phone09)
          .order("created_at", { ascending:false });

        if(error){
          console.error("Load orders error:", error);
          ordersWrap.innerHTML = `
            <div class="status err">خواندن سفارش‌ها ناموفق بود</div>
            <div class="hint" style="color:var(--danger)">${esc(error.message || "خطای نامشخص")}</div>
          `;
          ordersCount.textContent = "0";
          return;
        }

        const list = data || [];
        ordersCount.textContent = String(list.length);

        if(list.length === 0){
          ordersWrap.innerHTML = '<div class="muted">هنوز سفارشی ثبت نکرده‌اید.</div>';
          return;
        }

        ordersWrap.innerHTML = list.map(o => {
          const id = o.order_no ?? o.id ?? "";
          const created = o.created_at ? fmtDate(o.created_at) : "";
          const rawStage = (o.stage ?? o.status ?? o.state ?? "requested");
          const stNorm = normalizeStatus(rawStage);

          const dm = o.device_model ?? o.model ?? "";
          const pr = o.issue ?? o.problem ?? "";
          const ad = o.pickup_address ?? o.address ?? "";
          const pt = o.pickup_time_text ?? o.pickup_time ?? "";

          // FIX #5: price display from quoted_price_toman
          const priceText = formatToman(o.quoted_price_toman);

          const needsLoaner = !!(o.needs_loaner_phone);

          return `
            <div class="order-item">
              <div class="order-top">
                <b>سفارش #${esc(id)}</b>
                <!-- FIX #4: Persian status -->
                <span class="pill">وضعیت: ${esc(statusLabelFa(stNorm))}</span>
              </div>

              <div class="muted">
                <b>مدل:</b> ${esc(dm)}<br>
                <b>مشکل:</b> ${esc(pr)}<br>
                <b>آدرس:</b> ${esc(ad)}
                ${pt ? `<br><b>زمان دریافت:</b> ${esc(pt)}` : ""}
                ${created ? `<br><b>ثبت:</b> ${esc(created)}` : ""}
              </div>

              ${needsLoaner ? `<div class="replacement-note">نیاز به گوشی جایگزین: بله</div>` : ""}

              <div class="divider"></div>

              <div class="order-top">
                <b style="font-weight:900">قیمت</b>
                <span class="status ${priceText ? "ok" : "warn"}">
                  ${priceText ? esc(priceText) : "در انتظار اعلام قیمت"}
                </span>
              </div>

              ${renderTrack(stNorm)}
            </div>
          `;
        }).join("");
      }

      // =========================
      // Init
      // =========================
      try{
        const raw = localStorage.getItem(LS_LOGIN);
        loginState = raw ? JSON.parse(raw) : null;
      }catch(_e){
        loginState = null;
      }

      loadProfile();

      // Ensure name input is never prefilled with personal name
      if(fullName){
        fullName.value = hasProfileName() ? String(profileState.full_name) : "";
        if(!hasProfileName()){
          // FIX #1: keep placeholder generic; value empty
          fullName.setAttribute("placeholder", "نام و نام خانوادگی");
        }
      }

      applyLoginUI();
      loadDraft();
      if(loggedIn()){
        loadOrders();
      }

      // =========================
      // Events
      // =========================
      sendOtpBtn.addEventListener("click", sendOtp);
      verifyOtpBtn.addEventListener("click", verifyOtp);
      resendBtn.addEventListener("click", resend);

      if(navLogoutBtn) navLogoutBtn.addEventListener("click", logout);
      if(logoutBtn) logoutBtn.addEventListener("click", logout);

      if(saveProfileBtn) saveProfileBtn.addEventListener("click", () => {
        const ok = saveProfile();
        if(ok){
          applyLoginUI();
        }
      });

      createOrderBtn.addEventListener("click", createOrder);
      refreshOrdersBtn.addEventListener("click", loadOrders);

      // Save draft on input changes
      [deviceModel, problemDesc, address, pickupTime, replacementPhone].forEach(el => {
        if(!el) return;
        el.addEventListener("input", () => saveDraft());
        el.addEventListener("change", () => saveDraft());
      });

      // Quick issue chips
      document.querySelectorAll(".qchip").forEach(btn => {
        btn.addEventListener("click", () => {
          const val = (btn.getAttribute("data-issue") || "").trim();
          if(!val) return;
          const cur = (problemDesc.value || "").trim();
          const next = cur ? (cur + (cur.endsWith("،") || cur.endsWith(",") ? " " : "، ") + val) : val;
          problemDesc.value = next;
          problemDesc.focus();
          saveDraft();
        });
      });

    })();
  </script>
</body>
</html>
