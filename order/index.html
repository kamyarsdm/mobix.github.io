<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobix | Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</title>

  <meta name="description" content="Ù…ÙˆØ¨ÛŒÚ©Ø³Ø› Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ ØªØ¹Ù…ÛŒØ± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ. ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒØŒ Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ Ø§Ø¹Ù„Ø§Ù… Ù‚ÛŒÙ…ØªØŒ ØªØ§ÛŒÛŒØ¯ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ùˆ Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ)ØŒ Ùˆ Ú†Øª Ø³ÙØ§Ø±Ø´." />
  <meta name="theme-color" content="#1F6AFF" />
  <link rel="icon" href="../assets/logo.png" />

  <!-- Vazirmatn -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F6F8FC;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#5B6B84;
      --line:rgba(15,23,42,.08);

      --shadow: 0 14px 36px rgba(15,23,42,.10);
      --shadow2: 0 8px 18px rgba(15,23,42,.08);

      --radius:20px;

      --primary:#1F6AFF;
      --primary2:#3B82F6;
      --success:#10B981;
      --danger:#EF4444;
      --warn:#F59E0B;

      --max:1160px;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:"Vazirmatn", system-ui, sans-serif;
      background:
        radial-gradient(1000px 500px at 80% -10%, rgba(31,106,255,.16), transparent 55%),
        radial-gradient(900px 600px at 20% 10%, rgba(59,130,246,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    a{text-decoration:none;color:inherit}
    img{max-width:100%;display:block}

    .container{
      max-width:var(--max);
      margin:auto;
      padding:14px 16px 64px;
    }

    /* TOP BAR */
    .topbar{
      position:sticky;top:0;z-index:50;
      padding:10px 0;
      backdrop-filter: blur(12px);
    }
    .topbar-inner{
      display:flex;align-items:center;justify-content:space-between;
      background:rgba(246,248,252,.86);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      gap:10px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{width:56px;height:auto}
    .brand-col{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand-title{font-weight:900;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand-sub{color:var(--muted);font-weight:800;font-size:12.8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .nav{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      padding:10px 16px;
      border-radius:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-family:inherit;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;
      border:none;
    }
    .btn.ghost{
      background:rgba(255,255,255,.72);
    }
    .btn.danger{
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      color:#7F1D1D;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* LAYOUT */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .hero{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:980px){.hero{grid-template-columns:1fr}}

    h1{
      font-size:34px;
      font-weight:900;
      margin:0 0 8px;
      letter-spacing:-.3px;
      line-height:1.25;
    }
    @media(max-width:520px){h1{font-size:28px}}

    .sub{
      color:var(--muted);
      font-size:15px;
      line-height:1.9;
      margin:0;
    }

    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:900;
      font-size:12.8px;
      white-space:nowrap;
    }
    .status.ok{border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.08);color:#0B3A2C}
    .status.err{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:#7F1D1D}
    .status.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:#78350F}

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.75;
      white-space:pre-line;
    }

    .divider{height:1px;background:var(--line);margin:12px 0}

    /* FORMS */
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .label{font-size:13px;font-weight:900;color:var(--muted)}
    .input{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:800;
      outline:none;
    }
    .textarea{
      width:100%;
      min-height:110px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:800;
      outline:none;
      resize:vertical;
      line-height:1.9;
    }
    .formrow{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    @media(max-width:520px){.formrow{grid-template-columns:1fr}}

    .checkrow{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      box-shadow:var(--shadow2);
      margin-top:10px;
    }
    .checkrow input{width:18px;height:18px;accent-color: var(--primary)}
    .checkrow b{font-weight:900;font-size:13.5px}
    .checkrow span{color:var(--muted);font-size:12.8px;line-height:1.6}

    .quick-issues{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .qchip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.72);
      font-weight:900;
      font-size:12.8px;
      cursor:pointer;
      box-shadow:var(--shadow2);
      user-select:none;
    }

    /* SECTIONS / GRID */
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:980px){.grid-2{grid-template-columns:1fr}}

    /* ORDERS LIST */
    .orders{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .order-item{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .order-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .order-top b{font-weight:900}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(31,106,255,.10);
      border:1px solid rgba(31,106,255,.18);
      color:#0B2A6A;
      font-weight:900;
      font-size:12.5px;
      white-space:nowrap;
    }

    .muted{color:var(--muted);font-size:13.2px;line-height:1.9}

    /* TRACK */
    .track{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      margin-top:4px;
    }
    .track-step{
      display:flex;
      align-items:flex-start;
      gap:10px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:16px;
      padding:10px;
    }
    .track-bullet{
      width:28px;height:28px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }
    .track-step.done .track-bullet{
      background:rgba(16,185,129,.10);
      border-color:rgba(16,185,129,.25);
      color:#0B3A2C;
    }
    .track-step.active .track-bullet{
      background:rgba(31,106,255,.10);
      border-color:rgba(31,106,255,.25);
      color:#0B2A6A;
    }
    .track-step .tt b{display:block;font-weight:900}
    .track-step .tt span{display:block;color:var(--muted);font-size:13px;line-height:1.8;margin-top:3px}

    /* PRICE ACTIONS */
    .price-box{
      border:1px solid rgba(31,106,255,.18);
      background:rgba(31,106,255,.06);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .price-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .price-row b{font-weight:900}
    .price-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn.warn{
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.30);
      color:#78350F;
    }

    /* CHAT */
    .chat-wrap{
      border:1px solid var(--line);
      background:#fff;
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
    }
    .chat-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .chat-head b{font-weight:900}
    .chat-list{
      border:1px solid var(--line);
      background:rgba(246,248,252,.45);
      border-radius:16px;
      padding:10px;
      max-height:260px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .msg{
      max-width:92%;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      line-height:1.85;
      font-size:13.3px;
      font-weight:800;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .msg.me{align-self:flex-start;border-color:rgba(31,106,255,.18);background:rgba(31,106,255,.06)}
    .msg.other{align-self:flex-end}
    .msg-meta{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .chat-compose{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
    }
    @media(max-width:520px){.chat-compose{grid-template-columns:1fr}}
    .chat-input{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:800;
      outline:none;
    }

    /* MODALS */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(11,18,32,.42);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:14px;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modal-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modal-top b{font-weight:900;font-size:16px}
    .modal-x{
      width:40px;height:40px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.65);
      cursor:pointer;
      font-weight:900;
      display:flex;align-items:center;justify-content:center;
      box-shadow:var(--shadow2);
    }
    .modal-body{padding:2px 0 10px}
    .modal-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }

    .mini-note{
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:16px;
      padding:10px;
      line-height:1.85;
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }

    /* FOOTER (LIKE HOME) */
    .footer{
      margin-top:22px;
      padding:16px;
      border:1px solid var(--line);
      border-radius:22px;
      background:rgba(255,255,255,.86);
      box-shadow:var(--shadow);
      display:grid;
      grid-template-columns: 1.1fr .9fr .9fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:980px){.footer{grid-template-columns:1fr}}
    .fcol b{display:block;font-weight:900;margin-bottom:8px}
    .fcol p{margin:0;color:var(--muted);line-height:1.9;font-size:13.3px}
    .flinks{display:flex;flex-direction:column;gap:8px}
    .flinks a{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:14px;
      border:1px solid var(--line); background:#fff;
      box-shadow:var(--shadow2);
      font-weight:900; font-size:13px;
      width:fit-content;
    }
    .enamad{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .enamad img{width:110px;height:auto}
    .copyright{
      margin-top:10px;
      color:var(--muted);
      font-size:12.8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* MOBILE */
    @media (max-width:520px){
      .brand img{width:52px}
      .card{padding:14px}
      .topbar-inner{border-radius:22px}
      .btn{padding:10px 14px;border-radius:14px}
      .container{padding-bottom:56px}
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- HEADER (Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ / ØªÙ…Ø§Ø³) -->
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <img src="../assets/logo.png" alt="Mobix">
          <div class="brand-col">
            <div class="brand-title">Ù…ÙˆØ¨ÛŒÚ©Ø³</div>
            <div class="brand-sub">Ø³Ø±ÙˆÛŒØ³ ØªØ®ØµØµÛŒ ØªØ¹Ù…ÛŒØ± Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
          </div>
        </div>

        <div class="nav">
          <a class="btn ghost" href="../">Ø®Ø§Ù†Ù‡</a>
          <a class="btn primary" href="#orderForm" id="goOrderBtn">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</a>
          <a class="btn ghost" href="#myOrders" id="goMyOrdersBtn">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</a>
          <button class="btn danger" type="button" id="logoutTopBtn" style="display:none">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero">
      <div class="card">
        <h1>Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</h1>
        <p class="sub">
          ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒØŒ Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒØŒ Ø§Ø¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª Ùˆ ØªØ£ÛŒÛŒØ¯ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ.
        </p>
        <div class="divider"></div>
        <div id="sessionBadge" class="status warn">ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯</div>
      </div>

      <div class="card">
        <b style="font-weight:900;font-size:15px">Ø±Ø§Ù‡Ù†Ù…Ø§</b>
        <div class="hint" style="margin-top:8px">
- Ø§Ø¨ØªØ¯Ø§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯.
- Ù‚Ø¨Ù„ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ØŒ Ù¾Ø°ÛŒØ±Ø´ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ù„Ø§Ø²Ù… Ø§Ø³Øª.
- Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ø§Ú¯Ø± Ù†Ø§Ù… Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ ÛŒÚ©Ø¨Ø§Ø± Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÙ¾Ø±Ø³ÛŒÙ….
- Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ù‡Ù†Ú¯Ø§Ù… Â«Ø§Ø¹Ù„Ø§Ù… Ù‚ÛŒÙ…ØªÂ»ØŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ£ÛŒÛŒØ¯/Ø±Ø¯ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
        </div>
      </div>
    </section>

    <!-- MAIN -->
    <section class="card" style="margin-top:12px">
      <div class="grid-2">

        <!-- AUTH -->
        <div class="card" id="authCard" style="padding:16px;box-shadow:var(--shadow2)">
          <h2 style="margin:0 0 8px;font-weight:900;font-size:18px">ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ</h2>
          <p class="sub" style="font-size:14.5px">Ú©Ø¯ ÛŒÚ©Ø¨Ø§Ø± Ù…ØµØ±Ù Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>

          <div class="field">
            <div class="label">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
            <input id="authPhone" class="input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§ 0912xxxxxxx" />
          </div>

          <div class="formrow">
            <button id="sendOtpBtn" class="btn primary" type="button">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯</button>
            <button id="logoutBtn" class="btn danger" type="button" style="display:none">Ø®Ø±ÙˆØ¬</button>
          </div>

          <div id="otpBox" style="display:none">
            <div class="field">
              <div class="label">Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ</div>
              <input id="authCode" class="input" inputmode="numeric" placeholder="Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ" />
            </div>

            <div class="field" style="margin-top:8px">
              <div id="timerPill" class="status warn">02:00</div>
            </div>

            <!-- Ù‚ÙˆØ§Ù†ÛŒÙ† Ù‚Ø¨Ù„ Ø§Ø² ØªØ§ÛŒÛŒØ¯ -->
            <div class="checkrow" style="margin-top:10px">
              <input id="acceptRules" type="checkbox" />
              <div style="display:flex;flex-direction:column;gap:2px">
                <b>Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù…</b>
                <span>Ø¨Ø§ ØªØ£ÛŒÛŒØ¯ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯. (Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¯Ø± ÙÙˆØªØ±)</span>
              </div>
            </div>

            <div class="formrow" style="grid-template-columns:1fr 1fr">
              <button id="verifyOtpBtn" class="btn primary" type="button" disabled>ØªØ§ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
              <button id="resendBtn" class="btn ghost" type="button" disabled>Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯</button>
            </div>
          </div>

          <div id="authMsg" class="hint" aria-live="polite"></div>
        </div>

        <!-- ORDER + MY ORDERS -->
        <div class="card" style="padding:16px;box-shadow:var(--shadow2)">
          <div class="order-top" style="align-items:center">
            <h2 style="margin:0;font-weight:900;font-size:18px">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</h2>
            <span id="helloBar" class="status" style="display:none"></span>
          </div>

          <div id="orderForm" style="margin-top:10px">
            <div class="field">
              <div class="label">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</div>
              <input id="customerName" class="input" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" />
            </div>

            <div class="field">
              <div class="label">Ù…Ø¯Ù„ Ú¯ÙˆØ´ÛŒ</div>
              <input id="deviceModel" class="input" placeholder="Ù…Ø«Ù„Ø§ iPhone 13 / Galaxy A52" />
            </div>

            <div class="checkrow" aria-label="Ú¯ÙˆØ´ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†">
              <input id="replacementPhone" type="checkbox" />
              <div style="display:flex;flex-direction:column;gap:2px">
                <b>Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú¯ÙˆØ´ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¯Ø§Ø±Ù…</b>
                <span>Ø§Ú¯Ø± Ø¯Ø± Ø²Ù…Ø§Ù† ØªØ¹Ù…ÛŒØ± Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.</span>
              </div>
            </div>

            <div class="field">
              <div class="label">Ù…Ø´Ú©Ù„ Ø¯Ø³ØªÚ¯Ø§Ù‡</div>
              <textarea id="problemDesc" class="textarea" placeholder="Ù…Ø«Ù„Ø§ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù‡ / Ø´Ú©Ø³ØªÚ¯ÛŒ Ø§Ù„â€ŒØ³ÛŒâ€ŒØ¯ÛŒ / Ù…Ø´Ú©Ù„ Ø´Ø§Ø±Ú˜ ..."></textarea>
              <div class="quick-issues" aria-label="Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ÛŒØ¬">
                <div class="qchip" data-issue="Ø´Ú©Ø³ØªÚ¯ÛŒ/Ø®Ø· Ø±ÙˆÛŒ Ø§Ù„â€ŒØ³ÛŒâ€ŒØ¯ÛŒ">Ø´Ú©Ø³ØªÚ¯ÛŒ LCD</div>
                <div class="qchip" data-issue="Ù…Ø´Ú©Ù„ Ø´Ø§Ø±Ú˜/Ø³ÙˆÚ©Øª Ø´Ø§Ø±Ú˜">Ù…Ø´Ú©Ù„ Ø´Ø§Ø±Ú˜</div>
                <div class="qchip" data-issue="Ø¨Ø§ØªØ±ÛŒ Ø¶Ø¹ÛŒÙ/Ø²ÙˆØ¯ Ø®Ø§Ù„ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯">Ø¨Ø§ØªØ±ÛŒ</div>
                <div class="qchip" data-issue="Ø¢Ø¨â€ŒØ®ÙˆØ±Ø¯Ú¯ÛŒ">Ø¢Ø¨â€ŒØ®ÙˆØ±Ø¯Ú¯ÛŒ</div>
                <div class="qchip" data-issue="Ø®Ø§Ù…ÙˆØ´ÛŒ/Ø±ÛŒØ³Øª Ø´Ø¯Ù†">Ø®Ø§Ù…ÙˆØ´ÛŒ/Ø±ÛŒØ³Øª</div>
                <div class="qchip" data-issue="Ù…Ø´Ú©Ù„ ØµØ¯Ø§/Ù…ÛŒÚ©Ø±ÙˆÙÙ†">ØµØ¯Ø§/Ù…ÛŒÚ©Ø±ÙˆÙÙ†</div>
              </div>
            </div>

            <div class="field">
              <div class="label">Ø¢Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§ Ù¾ÛŒÚ©</div>
              <textarea id="address" class="textarea" placeholder="Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚ + Ù¾Ù„Ø§Ú© + ÙˆØ§Ø­Ø¯"></textarea>
            </div>

            <div class="field">
              <div class="label">Ø²Ù…Ø§Ù† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª</div>
              <input id="pickupTime" class="input" placeholder="Ù…Ø«Ù„Ø§ Ø§Ù…Ø±ÙˆØ² Û±Û¸ ØªØ§ Û²Û° / ÙØ±Ø¯Ø§ ØµØ¨Ø­" />
            </div>

            <div class="formrow">
              <button id="createOrderBtn" class="btn primary" type="button">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
              <button id="refreshOrdersBtn" class="btn ghost" type="button">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
            </div>

            <div id="orderMsg" class="hint" aria-live="polite"></div>
          </div>

          <div class="divider"></div>

          <div class="order-top" id="myOrders" style="align-items:center">
            <h2 style="margin:0;font-weight:900;font-size:18px">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h2>
            <span id="ordersCount" class="status">0</span>
          </div>

          <div id="ordersWrap" class="orders">
            <div class="muted">Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>
        </div>

      </div>
    </section>

    <!-- FOOTER (Ù…Ø«Ù„ Ù‡ÙˆÙ…) -->
    <section class="footer" id="rules">
      <div class="fcol">
        <b>Ù…ÙˆØ¨ÛŒÚ©Ø³</b>
        <p>
          Ø³Ø±ÙˆÛŒØ³ ØªØ®ØµØµÛŒ ØªØ¹Ù…ÛŒØ± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø´ÙØ§Ù Ùˆ Ù‚Ø§Ø¨Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ.
          Ø¯Ø±ÛŒØ§ÙØª Ùˆ ØªØ­ÙˆÛŒÙ„ Ø¨Ø§ Ù¾ÛŒÚ©ØŒ Ø§Ø¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ Ø§Ø² Ø§Ù‚Ø¯Ø§Ù…ØŒ Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø§Ø®Ù„ Ø³ÙØ§Ø±Ø´.
        </p>
        <div class="copyright">
          <span>Â© Mobix â€” Ù‡Ù…Ù‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª</span>
          <span id="footerPhone"></span>
        </div>
      </div>

      <div class="fcol">
        <b>Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹</b>
        <div class="flinks">
          <a href="#orderForm">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</a>
          <a href="#myOrders">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</a>
          <a href="../">Ø®Ø§Ù†Ù‡</a>
        </div>
      </div>

      <div class="fcol">
        <b>Ø§Ø¹ØªÙ…Ø§Ø¯ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ†</b>
        <p>
          Ø¨Ø§ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ØŒ Ø´Ù…Ø§ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±ÛŒØ¯:
          Ø§Ø¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ Ø§Ø² Ø§Ù‚Ø¯Ø§Ù…ØŒ Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§ØŒ Ùˆ Ø§Ù…Ú©Ø§Ù† Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ.
        </p>
        <div class="enamad">
          <a referrerpolicy="origin" target="_blank" href="https://trustseal.enamad.ir/?id=5414923&Code=DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf">
            <img referrerpolicy="origin" src="https://trustseal.enamad.ir/logo.aspx?id=5414923&Code=DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf" alt="Ø§ÛŒÙ†Ù…Ø§Ø¯" style="cursor:pointer" code="DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf">
          </a>
        </div>
      </div>
    </section>

  </div>

  <!-- MODALS -->
  <div class="modal-backdrop" id="nameModalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <b>Ù†Ø§Ù… Ø´Ù…Ø§</b>
        <button class="modal-x" type="button" id="nameModalClose">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="mini-note">Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ù…Ø±ØªØ¨ Ø¨Ø§Ø´Ø¯ØŒ ÛŒÚ©Ø¨Ø§Ø± Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ø«Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….</div>
        <div class="field">
          <div class="label">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</div>
          <input id="profileFullName" class="input" placeholder="Ù…Ø«Ù„Ø§ Ú©Ø§Ù…ÛŒØ§Ø± Ø³Ø§Ø¯Ù‡Ù…ÛŒØ±ÛŒ" />
        </div>
        <div id="nameModalMsg" class="hint"></div>
      </div>
      <div class="modal-actions">
        <button class="btn primary" type="button" id="saveNameBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
        <button class="btn ghost" type="button" id="skipNameBtn">Ø¨Ø¹Ø¯Ø§Ù‹</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="priceModalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <b id="priceModalTitle">ØªØ£ÛŒÛŒØ¯ Ù‚ÛŒÙ…Øª</b>
        <button class="modal-x" type="button" id="priceModalClose">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="mini-note" id="priceModalInfo"></div>

        <div id="priceStep1" style="margin-top:10px">
          <div class="checkrow">
            <input id="priceConfirm1" type="checkbox" />
            <div style="display:flex;flex-direction:column;gap:2px">
              <b>Ù‚ÛŒÙ…Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù…</b>
              <span>Ø¨Ø¹Ø¯ Ø§Ø² ØªØ£ÛŒÛŒØ¯ØŒ ÙˆØ§Ø±Ø¯ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯.</span>
            </div>
          </div>
        </div>

        <div id="priceStep2" style="display:none;margin-top:10px">
          <div class="mini-note">
            Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…: ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯ Ùˆ Ø³Ù¾Ø³ ØµÙØ­Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. (Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ)
          </div>
          <div class="checkrow" style="margin-top:10px">
            <input id="priceConfirm2" type="checkbox" />
            <div style="display:flex;flex-direction:column;gap:2px">
              <b>ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ù‚ÛŒÙ…Øª</b>
              <span>Ø¨Ø§ Ø§ÛŒÙ† ØªØ£ÛŒÛŒØ¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ù‡ ØµÙØ­Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.</span>
            </div>
          </div>
        </div>

        <div id="priceModalMsg" class="hint"></div>
      </div>
      <div class="modal-actions" id="priceModalActions">
        <button class="btn primary" type="button" id="priceNextBtn">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        <button class="btn ghost" type="button" id="priceCancelBtn">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="rejectModalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <b>Ø±Ø¯ Ù‚ÛŒÙ…Øª</b>
        <button class="modal-x" type="button" id="rejectModalClose">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="mini-note" id="rejectModalInfo"></div>
        <div id="rejectStep1" style="margin-top:10px">
          <div class="checkrow">
            <input id="rejectConfirm1" type="checkbox" />
            <div style="display:flex;flex-direction:column;gap:2px">
              <b>Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ù… Ù‚ÛŒÙ…Øª Ø±Ø§ Ø±Ø¯ Ú©Ù†Ù…</b>
              <span>Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ Ø±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.</span>
            </div>
          </div>
        </div>
        <div id="rejectStep2" style="display:none;margin-top:10px">
          <div class="checkrow">
            <input id="rejectConfirm2" type="checkbox" />
            <div style="display:flex;flex-direction:column;gap:2px">
              <b>Ø±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ù‚ÛŒÙ…Øª</b>
              <span>Ù¾Ø³ Ø§Ø² Ø±Ø¯ØŒ ØªÛŒÙ… Ù…ÙˆØ¨ÛŒÚ©Ø³ Ù…ÙˆØ¶ÙˆØ¹ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</span>
            </div>
          </div>
        </div>
        <div id="rejectModalMsg" class="hint"></div>
      </div>
      <div class="modal-actions">
        <button class="btn danger" type="button" id="rejectNextBtn">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        <button class="btn ghost" type="button" id="rejectCancelBtn">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>
  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    (function(){
      // =========================
      // Supabase Config
      // =========================
      const SUPABASE_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyeGZoZmtubXhtZWF0bmZ6cGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTg2MjksImV4cCI6MjA4MTgzNDYyOX0.iANOG9-g9GnVl58KDYI0A-oYNwfbL3oh2NBddZ2sLLs";

      const OTP_REQUEST_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/request-otp";
      const OTP_VERIFY_URL  = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/verify-otp";

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // =========================
      // Helpers
      // =========================
      function normalizeDigits(s){
        return (s || "")
          .replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d))
          .replace(/[^\d]/g, "");
      }
      function isValidIranMobile(d){
        if(!d) return false;
        if(d.length === 11 && d.startsWith("09")) return true;
        if(d.length === 10 && d.startsWith("9")) return true;
        return false;
      }
      function to09(d){
        if(!d) return null;
        if(d.length === 11 && d.startsWith("09")) return d;
        if(d.length === 10 && d.startsWith("9")) return "0" + d;
        return null;
      }
      function fmtDate(iso){
        try{
          const dt = new Date(iso);
          if(isNaN(dt.getTime())) return iso || "";
          return dt.toLocaleString("fa-IR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        }catch(e){ return iso || ""; }
      }
      function esc(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      async function safeJson(res){
        try{ return await res.json(); }catch(e){ return null; }
      }
      function extractErrorMessage(obj){
        if(!obj) return null;
        if(typeof obj === "string") return obj;
        return obj.message || obj.error || (obj.errors && obj.errors[0] && (obj.errors[0].message || obj.errors[0])) || null;
      }
      function setStatus(el, type, text){
        el.classList.remove("ok","err","warn");
        if(type) el.classList.add(type);
        el.textContent = text;
      }
      function setMsg(el, type, text){
        if(!text){
          el.textContent = "";
          el.style.color = "var(--muted)";
          return;
        }
        if(type === "ok") el.style.color = "var(--success)";
        else if(type === "err") el.style.color = "var(--danger)";
        else if(type === "warn") el.style.color = "var(--warn)";
        else el.style.color = "var(--muted)";
        el.textContent = text;
      }

      // âœ… generate order_no like MCC-YYMMDD-XXXX
      function genOrderNo(){
        const d = new Date();
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const rand = String(Math.floor(1000 + Math.random()*9000));
        return `MCC-${yy}${mm}${dd}-${rand}`;
      }

      // =========================
      // UI Elements
      // =========================
      const sessionBadge = document.getElementById("sessionBadge");

      const authCard = document.getElementById("authCard");
      const authPhone = document.getElementById("authPhone");
      const authCode = document.getElementById("authCode");
      const sendOtpBtn = document.getElementById("sendOtpBtn");
      const verifyOtpBtn = document.getElementById("verifyOtpBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const logoutTopBtn = document.getElementById("logoutTopBtn");

      const resendBtn = document.getElementById("resendBtn");
      const otpBox = document.getElementById("otpBox");
      const authMsg = document.getElementById("authMsg");
      const timerPill = document.getElementById("timerPill");
      const acceptRules = document.getElementById("acceptRules");

      const helloBar = document.getElementById("helloBar");

      const customerName = document.getElementById("customerName");
      const deviceModel = document.getElementById("deviceModel");
      const replacementPhone = document.getElementById("replacementPhone");
      const problemDesc = document.getElementById("problemDesc");
      const address = document.getElementById("address");
      const pickupTime = document.getElementById("pickupTime");
      const createOrderBtn = document.getElementById("createOrderBtn");
      const refreshOrdersBtn = document.getElementById("refreshOrdersBtn");
      const orderMsg = document.getElementById("orderMsg");

      const ordersWrap = document.getElementById("ordersWrap");
      const ordersCount = document.getElementById("ordersCount");

      const footerPhone = document.getElementById("footerPhone");

      // Name modal
      const nameModalBack = document.getElementById("nameModalBack");
      const nameModalClose = document.getElementById("nameModalClose");
      const profileFullName = document.getElementById("profileFullName");
      const saveNameBtn = document.getElementById("saveNameBtn");
      const skipNameBtn = document.getElementById("skipNameBtn");
      const nameModalMsg = document.getElementById("nameModalMsg");

      // Price approve modal
      const priceModalBack = document.getElementById("priceModalBack");
      const priceModalClose = document.getElementById("priceModalClose");
      const priceModalTitle = document.getElementById("priceModalTitle");
      const priceModalInfo = document.getElementById("priceModalInfo");
      const priceModalMsg = document.getElementById("priceModalMsg");
      const priceConfirm1 = document.getElementById("priceConfirm1");
      const priceConfirm2 = document.getElementById("priceConfirm2");
      const priceStep1 = document.getElementById("priceStep1");
      const priceStep2 = document.getElementById("priceStep2");
      const priceNextBtn = document.getElementById("priceNextBtn");
      const priceCancelBtn = document.getElementById("priceCancelBtn");

      // Reject modal
      const rejectModalBack = document.getElementById("rejectModalBack");
      const rejectModalClose = document.getElementById("rejectModalClose");
      const rejectModalInfo = document.getElementById("rejectModalInfo");
      const rejectModalMsg = document.getElementById("rejectModalMsg");
      const rejectConfirm1 = document.getElementById("rejectConfirm1");
      const rejectConfirm2 = document.getElementById("rejectConfirm2");
      const rejectStep1 = document.getElementById("rejectStep1");
      const rejectStep2 = document.getElementById("rejectStep2");
      const rejectNextBtn = document.getElementById("rejectNextBtn");
      const rejectCancelBtn = document.getElementById("rejectCancelBtn");

      // =========================
      // State
      // =========================
      const LS_KEY = "mobix_site_login";
      const DRAFT_KEY = "mobix_site_order_draft";
      const PROFILE_KEY = "mobix_site_profile"; // { [phone09]: { full_name } }

      let loginState = null; // { phone09 }
      let lastPhone09 = null;

      let timerId = null;
      let remaining = 0;

      // For modals
      let pendingApprove = null; // { order_no, quoted_price_toman }
      let pendingReject = null;  // { order_no, quoted_price_toman }
      let approveStep = 1;
      let rejectStep = 1;

      // Chat cache / state
      const chatState = {
        openOrderNo: null,
        loading: false,
        map: {} // { order_no: messages[] }
      };

      // =========================
      // Timer
      // =========================
      function formatMMSS(sec){
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
      }
      function stopTimer(){
        if(timerId) clearInterval(timerId);
        timerId = null;
      }
      function startTimer(seconds){
        stopTimer();
        remaining = seconds;
        resendBtn.disabled = true;
        setStatus(timerPill, "warn", formatMMSS(remaining));

        timerId = setInterval(() => {
          remaining -= 1;
          if(remaining <= 0){
            stopTimer();
            setStatus(timerPill, "ok", "00:00");
            resendBtn.disabled = false;
            return;
          }
          setStatus(timerPill, "warn", formatMMSS(remaining));
        }, 1000);
      }

      // =========================
      // Draft
      // =========================
      function saveDraft(){
        const draft = {
          customer_name: (customerName.value || "").trim(),
          device_model: (deviceModel.value || "").trim(),
          wants_replacement_phone: !!(replacementPhone && replacementPhone.checked),
          issue: (problemDesc.value || "").trim(),
          pickup_address: (address.value || "").trim(),
          pickup_time_text: (pickupTime.value || "").trim()
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      }
      function loadDraft(){
        try{
          const raw = localStorage.getItem(DRAFT_KEY);
          if(!raw) return;
          const d = JSON.parse(raw);
          if(d && typeof d === "object"){
            if(d.customer_name != null) customerName.value = d.customer_name;
            if(d.device_model != null) deviceModel.value = d.device_model;
            if(d.wants_replacement_phone != null && replacementPhone) replacementPhone.checked = !!d.wants_replacement_phone;
            if(d.issue != null) problemDesc.value = d.issue;
            if(d.pickup_address != null) address.value = d.pickup_address;
            if(d.pickup_time_text != null) pickupTime.value = d.pickup_time_text;
          }
        }catch(_e){}
      }

      // =========================
      // Profile (Full Name) per phone
      // =========================
      function readProfiles(){
        try{
          const raw = localStorage.getItem(PROFILE_KEY);
          const o = raw ? JSON.parse(raw) : {};
          return (o && typeof o === "object") ? o : {};
        }catch(_e){ return {}; }
      }
      function writeProfiles(obj){
        try{ localStorage.setItem(PROFILE_KEY, JSON.stringify(obj || {})); }catch(_e){}
      }
      function getProfileName(phone09){
        const profiles = readProfiles();
        return (profiles[phone09] && profiles[phone09].full_name) ? String(profiles[phone09].full_name) : null;
      }
      function setProfileName(phone09, fullName){
        const profiles = readProfiles();
        profiles[phone09] = { full_name: fullName };
        writeProfiles(profiles);
      }

      function openNameModal(){
        setMsg(nameModalMsg, "", "");
        profileFullName.value = "";
        nameModalBack.style.display = "flex";
        setTimeout(()=> profileFullName.focus(), 200);
      }
      function closeNameModal(){
        nameModalBack.style.display = "none";
      }

      // =========================
      // Auth state + UI
      // =========================
      function loggedIn(){
        return !!(loginState && loginState.phone09);
      }

      function applyLoginUI(){
        const li = loggedIn();
        if(li){
          setStatus(sessionBadge, "ok", "ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ âœ…");
          authCard.style.display = "none"; // Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ Ø¯ÛŒØ¯Ù‡ Ù†Ø´Ù‡
          logoutTopBtn.style.display = "";
          footerPhone.textContent = "Ø´Ù…Ø§Ø±Ù‡: " + loginState.phone09;

          const fullName = getProfileName(loginState.phone09);
          if(fullName){
            helloBar.style.display = "";
            helloBar.textContent = "Ø³Ù„Ø§Ù… " + fullName + " ğŸ‘‹";
            customerName.value = fullName; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
          }else{
            helloBar.style.display = "none";
          }
        }else{
          setStatus(sessionBadge, "warn", "ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯");
          authCard.style.display = "";
          logoutTopBtn.style.display = "none";
          footerPhone.textContent = "";
          helloBar.style.display = "none";
          ordersWrap.innerHTML = '<div class="muted">Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>';
          ordersCount.textContent = "0";
        }
      }

      // =========================
      // Edge calls
      // =========================
      async function requestOtpEdge(phone09){
        const res = await fetch(OTP_REQUEST_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09 })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");
        }
        return json || { ok: true, expires_in_seconds: 120 };
      }

      async function verifyOtpEdge(phone09, code){
        const res = await fetch(OTP_VERIFY_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09, code })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");
        }
        return json || { ok: true };
      }

      // =========================
      // Status mapping (FA)
      // =========================
      const TRACK_STEPS = [
        { key:"requested", title:"Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª", desc:"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³Øª." },
        { key:"picked_up", title:"Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§ Ù¾ÛŒÚ©", desc:"Ù¾ÛŒÚ© Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯." },
        { key:"quoted", title:"Ø§Ø¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª", desc:"Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø¹Ù„Ø§Ù… Ø´Ø¯ Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§Ø³Øª." },
        { key:"repairing", title:"Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±", desc:"ØªÚ©Ù†Ø³ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… ØªØ¹Ù…ÛŒØ± Ø§Ø³Øª." },
        { key:"delivering", title:"Ø¯Ø± Ù…Ø³ÛŒØ± ØªØ­ÙˆÛŒÙ„", desc:"Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ù…Ø³ÛŒØ± ØªØ­ÙˆÛŒÙ„ Ø§Ø³Øª." },
        { key:"delivered", title:"ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ø´Ù…Ø§", desc:"Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ âœ…" }
      ];

      function normalizeStatus(raw){
        const s = (raw || "").toString().trim().toLowerCase();
        if(["new","created","request","requested","pending"].includes(s)) return "requested";
        if(["pickup","pickedup","picked_up","courier_pickup"].includes(s)) return "picked_up";
        if(["quote","quoted","price","awaiting_approval","approved_pending"].includes(s)) return "quoted";
        if(["repair","repairing","in_repair","fixing"].includes(s)) return "repairing";
        if(["deliver","delivering","shipping","on_the_way"].includes(s)) return "delivering";
        if(["done","delivered","completed","complete"].includes(s)) return "delivered";
        return s || "requested";
      }
      function statusLabel(key){
        const k = normalizeStatus(key);
        const m = {
          requested: "Ø«Ø¨Øª Ø´Ø¯Ù‡",
          picked_up: "Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§ Ù¾ÛŒÚ©",
          quoted: "Ø§Ø¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª",
          repairing: "Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±",
          delivering: "Ø¯Ø± Ù…Ø³ÛŒØ± ØªØ­ÙˆÛŒÙ„",
          delivered: "ØªØ­ÙˆÛŒÙ„ Ø´Ø¯"
        };
        return m[k] || k;
      }
      function stepIndex(key){
        const idx = TRACK_STEPS.findIndex(x => x.key === key);
        return idx < 0 ? 0 : idx;
      }
      function renderTrack(statusKey){
        const norm = normalizeStatus(statusKey);
        const activeIdx = stepIndex(norm);
        return `
          <div class="track">
            ${TRACK_STEPS.map((s, i) => {
              const cls = i < activeIdx ? "done" : (i === activeIdx ? "active" : "");
              const bullet = i < activeIdx ? "âœ“" : (i === activeIdx ? "â€¢" : (i+1));
              return `
                <div class="track-step ${cls}">
                  <div class="track-bullet">${bullet}</div>
                  <div class="tt">
                    <b>${esc(s.title)}</b>
                    <span>${esc(s.desc)}</span>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }

      // =========================
      // Orders: fetch updates + chat counts (best-effort)
      // =========================
      async function fetchLatestUpdates(orderNos){
        const out = {};
        if(!orderNos || orderNos.length === 0) return out;

        // best-effort: order_updates table columns unknown, so select("*") and read message-like fields
        const { data, error } = await supabase
          .from("order_updates")
          .select("*")
          .in("order_no", orderNos)
          .order("created_at", { ascending:false });

        if(error || !data) return out;

        for(const row of data){
          const ono = row.order_no;
          if(!ono) continue;
          if(out[ono]) continue; // first is latest due to descending
          const msg =
            row.message ?? row.note ?? row.text ?? row.description ?? row.details ?? row.title ?? null;
          const created = row.created_at ?? row.inserted_at ?? null;
          out[ono] = {
            message: msg ? String(msg) : null,
            created_at: created ? String(created) : null
          };
        }
        return out;
      }

      // =========================
      // Chat
      // =========================
      async function loadChat(orderNo){
        if(!orderNo) return;
        chatState.loading = true;

        const { data, error } = await supabase
          .from("chat_messages")
          .select("*")
          .eq("order_no", orderNo)
          .order("created_at", { ascending:true });

        chatState.loading = false;

        if(error){
          chatState.map[orderNo] = { error: error.message || "Ø®Ø·Ø§", messages: [] };
          return;
        }

        chatState.map[orderNo] = { error: null, messages: data || [] };
      }

      async function sendChat(orderNo, text){
        const t = (text || "").trim();
        if(!t) return { ok:false, error:"Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª" };

        const payload = {
          order_no: orderNo,
          sender: "customer",
          text: t
        };

        const { error } = await supabase.from("chat_messages").insert(payload);
        if(error) return { ok:false, error: error.message || "Ø®Ø·Ø§" };

        await loadChat(orderNo);
        return { ok:true };
      }

      // =========================
      // Price approval (two-step)
      // =========================
      function openPriceModal(orderNo, priceToman){
        pendingApprove = { order_no: orderNo, quoted_price_toman: priceToman };
        approveStep = 1;

        priceModalTitle.textContent = "ØªØ£ÛŒÛŒØ¯ Ù‚ÛŒÙ…Øª";
        priceModalInfo.textContent = `Ø³ÙØ§Ø±Ø´ ${orderNo} â€” Ù…Ø¨Ù„Øº Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡: ${Number(priceToman || 0).toLocaleString("fa-IR")} ØªÙˆÙ…Ø§Ù†`;
        setMsg(priceModalMsg, "", "");

        priceConfirm1.checked = false;
        priceConfirm2.checked = false;
        priceStep1.style.display = "";
        priceStep2.style.display = "none";

        priceNextBtn.textContent = "Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯";
        priceModalBack.style.display = "flex";
      }

      function closePriceModal(){
        priceModalBack.style.display = "none";
        pendingApprove = null;
        approveStep = 1;
      }

      async function approvePriceFinal(){
        if(!pendingApprove) return;

        const orderNo = pendingApprove.order_no;

        // update orders: price_approved=true, price_approval='approved'
        const { error } = await supabase
          .from("orders")
          .update({ price_approved: true, price_approval: "approved" })
          .eq("order_no", orderNo);

        if(error){
          setMsg(priceModalMsg, "err", "Ø«Ø¨Øª ØªØ£ÛŒÛŒØ¯ Ù‚ÛŒÙ…Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (error.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
          return;
        }

        // go to pay page (Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ)
        const url = `./pay/?order_no=${encodeURIComponent(orderNo)}`;
        window.location.href = url;
      }

      // Reject price (two-step)
      function openRejectModal(orderNo, priceToman){
        pendingReject = { order_no: orderNo, quoted_price_toman: priceToman };
        rejectStep = 1;

        rejectModalInfo.textContent = `Ø³ÙØ§Ø±Ø´ ${orderNo} â€” Ù…Ø¨Ù„Øº Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡: ${Number(priceToman || 0).toLocaleString("fa-IR")} ØªÙˆÙ…Ø§Ù†`;
        setMsg(rejectModalMsg, "", "");

        rejectConfirm1.checked = false;
        rejectConfirm2.checked = false;
        rejectStep1.style.display = "";
        rejectStep2.style.display = "none";

        rejectNextBtn.textContent = "Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯";
        rejectModalBack.style.display = "flex";
      }

      function closeRejectModal(){
        rejectModalBack.style.display = "none";
        pendingReject = null;
        rejectStep = 1;
      }

      async function rejectPriceFinal(){
        if(!pendingReject) return;

        const orderNo = pendingReject.order_no;

        const { error } = await supabase
          .from("orders")
          .update({ price_approved: false, price_approval: "rejected" })
          .eq("order_no", orderNo);

        if(error){
          setMsg(rejectModalMsg, "err", "Ø«Ø¨Øª Ø±Ø¯ Ù‚ÛŒÙ…Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (error.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
          return;
        }

        setMsg(rejectModalMsg, "ok", "Ø±Ø¯ Ù‚ÛŒÙ…Øª Ø«Ø¨Øª Ø´Ø¯ âœ…");
        setTimeout(async () => {
          closeRejectModal();
          await loadOrders();
        }, 450);
      }

      // =========================
      // Actions
      // =========================
      function showOtpBox(show){
        otpBox.style.display = show ? "" : "none";
      }

      function refreshVerifyButtonState(){
        const ok = !!acceptRules.checked;
        verifyOtpBtn.disabled = !ok;
      }

      async function sendOtp(){
        setMsg(authMsg, "", "");

        const d = normalizeDigits(authPhone.value);
        if(!isValidIranMobile(d)){
          setMsg(authMsg, "err", "Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø±Ø³Øª Ù†ÛŒØ³Øª. Ù…Ø«Ù„ 0912xxxxxxx ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }
        const phone09 = to09(d);
        if(!phone09){
          setMsg(authMsg, "err", "Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø§Ø¨Ù„ ØªØ¨Ø¯ÛŒÙ„ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
          return;
        }

        sendOtpBtn.disabled = true;
        resendBtn.disabled = true;
        setMsg(authMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯â€¦");

        try{
          const out = await requestOtpEdge(phone09);
          lastPhone09 = phone09;

          showOtpBox(true);
          setMsg(authMsg, "ok", "Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ…");

          // Ù‚ÙˆØ§Ù†ÛŒÙ†: Ù‡Ø± Ø¨Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§ÛŒØ¯ ØªÛŒÚ© Ø¨Ø®ÙˆØ±Ù‡
          acceptRules.checked = false;
          refreshVerifyButtonState();

          const secs = Number(out?.expires_in_seconds ?? 120);
          startTimer(Number.isFinite(secs) ? secs : 120);

          authCode.focus();
        }catch(err){
          setMsg(authMsg, "err", "Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (err?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
          showOtpBox(false);
          stopTimer();
        }finally{
          sendOtpBtn.disabled = false;
        }
      }

      async function verifyOtp(){
        setMsg(authMsg, "", "");
        const code = normalizeDigits(authCode.value);

        if(!lastPhone09){
          setMsg(authMsg, "err", "Ø§ÙˆÙ„ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú©Ø¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.");
          return;
        }
        if(!acceptRules.checked){
          setMsg(authMsg, "err", "Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ±ÛŒØ¯.");
          return;
        }
        if(!code || code.length < 4){
          setMsg(authMsg, "err", "Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }

        verifyOtpBtn.disabled = true;
        setMsg(authMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ú©Ø¯â€¦");

        try{
          await verifyOtpEdge(lastPhone09, code);

          loginState = { phone09: lastPhone09 };
          localStorage.setItem(LS_KEY, JSON.stringify(loginState));

          authCode.value = "";
          setMsg(authMsg, "ok", "ÙˆØ±ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…");

          applyLoginUI();
          loadDraft();

          // Ø§Ú¯Ø± Ù†Ø§Ù… Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ Ø¨Ù¾Ø±Ø³
          const fullName = getProfileName(loginState.phone09);
          if(!fullName){
            openNameModal();
          }else{
            customerName.value = fullName;
          }

          await loadOrders();
        }catch(err){
          setMsg(authMsg, "err", "ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (err?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
          refreshVerifyButtonState();
        }finally{
          verifyOtpBtn.disabled = !acceptRules.checked;
        }
      }

      async function resend(){
        if(resendBtn.disabled) return;
        if(!lastPhone09){
          setMsg(authMsg, "err", "Ø§ÙˆÙ„ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }
        authPhone.value = lastPhone09;
        await sendOtp();
      }

      async function logout(){
        setMsg(authMsg, "", "");
        loginState = null;
        localStorage.removeItem(LS_KEY);
        lastPhone09 = null;
        showOtpBox(false);
        stopTimer();
        setMsg(authMsg, "ok", "Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.");
        applyLoginUI();
      }

      function buildIssueWithExtras(baseIssue){
        const wants = !!(replacementPhone && replacementPhone.checked);
        if(!wants) return baseIssue;
        const suffix = "Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú¯ÙˆØ´ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: Ø¨Ù„Ù‡";
        const cur = (baseIssue || "").trim();
        if(!cur) return suffix;
        if(cur.includes(suffix)) return cur;
        return cur + (cur.endsWith("ØŒ") || cur.endsWith(",") ? " " : "ØŒ ") + suffix;
      }

      async function createOrder(){
        setMsg(orderMsg, "", "");

        const cn = (customerName.value || "").trim();
        const dm = (deviceModel.value || "").trim();
        const issueRaw = (problemDesc.value || "").trim();
        const issue = buildIssueWithExtras(issueRaw);
        const addr = (address.value || "").trim();
        const pt = (pickupTime.value || "").trim();

        if(!cn || !dm || !issue || !addr){
          setMsg(orderMsg, "err", "Ù†Ø§Ù…ØŒ Ù…Ø¯Ù„ Ú¯ÙˆØ´ÛŒØŒ Ù…Ø´Ú©Ù„ Ùˆ Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }

        if(!loggedIn()){
          setMsg(orderMsg, "warn", "Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ØŒ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
          document.getElementById("authCard").scrollIntoView({ behavior:"smooth", block:"start" });
          setTimeout(() => authPhone && authPhone.focus(), 350);
          saveDraft();
          return;
        }

        createOrderBtn.disabled = true;
        setMsg(orderMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´â€¦");

        const payload = {
          order_no: genOrderNo(),
          customer_phone: loginState.phone09,
          customer_name: cn,
          device_model: dm,
          issue: issue,
          delivery_method: "in_person",
          pickup_address: addr,
          pickup_time_text: pt || null,

          needs_loaner_phone: !!(replacementPhone && replacementPhone.checked),

          stage: "requested",
          status: "requested",

          quoted_price_toman: 0,
          price_approval: "not_needed",
          price_approved: false,

          needs_issue_photo: false
        };

        try{
          const { data, error } = await supabase
            .from("orders")
            .insert(payload)
            .select("*")
            .single();

          if(error){
            console.error("Insert error:", error);
            setMsg(orderMsg, "err", "Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (error.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
            return;
          }

          if(!data){
            setMsg(orderMsg, "warn", "Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯ ÙˆÙ„ÛŒ Ù¾Ø§Ø³Ø®ÛŒ Ø¨Ø±Ù†Ú¯Ø´Øª. Ù„Ø·ÙØ§Ù‹ Â«Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
          }else{
            setMsg(orderMsg, "ok", "Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯ âœ…");
          }

          // Ø§Ú¯Ø± Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯ Ùˆ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ØŒ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
          const existingName = getProfileName(loginState.phone09);
          if(!existingName && cn){
            setProfileName(loginState.phone09, cn);
            helloBar.style.display = "";
            helloBar.textContent = "Ø³Ù„Ø§Ù… " + cn + " ğŸ‘‹";
          }

          deviceModel.value = "";
          if(replacementPhone) replacementPhone.checked = false;
          problemDesc.value = "";
          address.value = "";
          pickupTime.value = "";
          localStorage.removeItem(DRAFT_KEY);

          await loadOrders();
        }catch(e){
          console.error("Create order exception:", e);
          setMsg(orderMsg, "err", "Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (e?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
        }finally{
          createOrderBtn.disabled = false;
        }
      }

      // =========================
      // Render: orders + actions (approve/reject + chat + dashboard note)
      // =========================
      function formatToman(n){
        const v = Number(n || 0);
        if(!Number.isFinite(v)) return "0";
        return v.toLocaleString("fa-IR");
      }

      function renderChatBlock(orderNo){
        const cache = chatState.map[orderNo];
        const hasCache = !!cache;
        const err = hasCache ? cache.error : null;
        const msgs = hasCache ? (cache.messages || []) : [];
        const open = chatState.openOrderNo === orderNo;

        if(!open) return "";

        return `
          <div class="chat-wrap" data-chat="${esc(orderNo)}">
            <div class="chat-head">
              <b>Ú†Øª Ø³ÙØ§Ø±Ø´</b>
              <span class="status">Ø³ÙØ§Ø±Ø´: ${esc(orderNo)}</span>
            </div>

            ${err ? `<div class="status err">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú†Øª: ${esc(err)}</div>` : ""}

            <div class="chat-list" id="chatList_${esc(orderNo)}">
              ${msgs.length === 0
                ? `<div class="muted">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>`
                : msgs.map(m => {
                    const sender = (m.sender || "").toString().toLowerCase();
                    const mine = sender === "customer" || sender === "me";
                    const cls = mine ? "me" : "other";
                    const text = m.text ?? m.message ?? "";
                    const dt = m.created_at ? fmtDate(m.created_at) : "";
                    return `
                      <div class="msg ${cls}">
                        ${esc(text)}
                        <div class="msg-meta">${dt ? esc(dt) : ""}</div>
                      </div>
                    `;
                  }).join("")
              }
            </div>

            <div class="chat-compose">
              <input class="chat-input" id="chatInput_${esc(orderNo)}" placeholder="Ù¾ÛŒØ§Ù… Ø´Ù…Ø§â€¦" />
              <button class="btn primary" data-send-chat="${esc(orderNo)}" type="button">Ø§Ø±Ø³Ø§Ù„</button>
            </div>

            <div class="hint" id="chatMsg_${esc(orderNo)}"></div>
          </div>
        `;
      }

      function renderPriceBox(o){
        const orderNo = o.order_no ?? o.id ?? "";
        const stage = normalizeStatus(o.stage ?? o.status ?? "requested");

        const price = Number(o.quoted_price_toman || 0);
        const approved = !!o.price_approved;
        const approval = (o.price_approval || "").toString().toLowerCase();

        const isQuoted = stage === "quoted";
        const canAct = isQuoted && !approved && (approval !== "approved");
        const show = isQuoted;

        if(!show) return "";

        if(approved || approval === "approved"){
          return `
            <div class="price-box">
              <div class="price-row">
                <b>Ù‚ÛŒÙ…Øª Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡</b>
                <span class="status ok">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ âœ…</span>
              </div>
              <div class="muted">
                Ù…Ø¨Ù„Øº: <b>${formatToman(price)}</b> ØªÙˆÙ…Ø§Ù†
              </div>
              <div class="price-actions">
                <a class="btn primary" href="./pay/?order_no=${encodeURIComponent(orderNo)}">Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ)</a>
              </div>
            </div>
          `;
        }

        if(approval === "rejected"){
          return `
            <div class="price-box">
              <div class="price-row">
                <b>Ù‚ÛŒÙ…Øª Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡</b>
                <span class="status warn">Ø±Ø¯ Ø´Ø¯Ù‡</span>
              </div>
              <div class="muted">
                Ù…Ø¨Ù„Øº: <b>${formatToman(price)}</b> ØªÙˆÙ…Ø§Ù†
              </div>
              <div class="muted">ØªÛŒÙ… Ù…ÙˆØ¨ÛŒÚ©Ø³ Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</div>
            </div>
          `;
        }

        return `
          <div class="price-box">
            <div class="price-row">
              <b>Ù‚ÛŒÙ…Øª Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡</b>
              <span class="status warn">Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØµÙ…ÛŒÙ… Ø´Ù…Ø§</span>
            </div>
            <div class="muted">
              Ù…Ø¨Ù„Øº: <b>${formatToman(price)}</b> ØªÙˆÙ…Ø§Ù†
            </div>
            <div class="price-actions">
              <button class="btn primary" type="button" data-approve="${esc(orderNo)}" data-price="${esc(String(price))}" ${canAct ? "" : "disabled"}>ØªØ£ÛŒÛŒØ¯ Ù‚ÛŒÙ…Øª</button>
              <button class="btn danger" type="button" data-reject="${esc(orderNo)}" data-price="${esc(String(price))}" ${canAct ? "" : "disabled"}>Ø±Ø¯ Ù‚ÛŒÙ…Øª</button>
            </div>
            <div class="muted">ØªØ£ÛŒÛŒØ¯ Ù‚ÛŒÙ…Øª Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª.</div>
          </div>
        `;
      }

      async function loadOrders(){
        if(!loggedIn()){
          ordersCount.textContent = "0";
          return;
        }

        ordersWrap.innerHTML = '<div class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§â€¦</div>';

        // Fetch orders (from main table)
        const { data, error } = await supabase
          .from("orders")
          .select("*")
          .eq("customer_phone", loginState.phone09)
          .order("created_at", { ascending:false });

        if(error){
          console.error("Load orders error:", error);
          ordersWrap.innerHTML = `
            <div class="status err">Ø®ÙˆØ§Ù†Ø¯Ù† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</div>
            <div class="hint" style="color:var(--danger)">${esc(error.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ")}</div>
          `;
          ordersCount.textContent = "0";
          return;
        }

        const list = data || [];
        ordersCount.textContent = String(list.length);

        if(list.length === 0){
          ordersWrap.innerHTML = '<div class="muted">Ù‡Ù†ÙˆØ² Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</div>';
          return;
        }

        // Latest dashboard updates (best-effort)
        const orderNos = list.map(o => o.order_no).filter(Boolean);
        const latestUpdates = await fetchLatestUpdates(orderNos);

        ordersWrap.innerHTML = list.map(o => {
          const orderNo = o.order_no ?? o.id ?? "";
          const created = o.created_at ? fmtDate(o.created_at) : "";
          const stRaw = o.stage ?? o.status ?? "requested";
          const st = normalizeStatus(stRaw);
          const dm = o.device_model ?? o.model ?? "";
          const pr = o.issue ?? o.problem ?? "";
          const ad = o.pickup_address ?? o.address ?? "";
          const pt = o.pickup_time_text ?? o.pickup_time ?? "";

          const wantsLoaner = !!o.needs_loaner_phone;

          const upd = latestUpdates[orderNo] || null;
          const updText = upd && upd.message ? String(upd.message) : null;
          const updTime = upd && upd.created_at ? fmtDate(upd.created_at) : null;

          const chatOpen = (chatState.openOrderNo === orderNo);
          const chatBtnText = chatOpen ? "Ø¨Ø³ØªÙ† Ú†Øª" : "Ú†Øª Ø³ÙØ§Ø±Ø´";

          return `
            <div class="order-item" data-order="${esc(orderNo)}">
              <div class="order-top">
                <b>Ø³ÙØ§Ø±Ø´ #${esc(orderNo)}</b>
                <span class="pill">ÙˆØ¶Ø¹ÛŒØª: ${esc(statusLabel(st))}</span>
              </div>

              <div class="muted">
                <b>Ù…Ø¯Ù„:</b> ${esc(dm)}<br>
                <b>Ù…Ø´Ú©Ù„:</b> ${esc(pr)}<br>
                <b>Ø¢Ø¯Ø±Ø³:</b> ${esc(ad)}
                ${pt ? `<br><b>Ø²Ù…Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª:</b> ${esc(pt)}` : ""}
                ${created ? `<br><b>Ø«Ø¨Øª:</b> ${esc(created)}</b>` : ""}
                ${wantsLoaner ? `<br><b style="color:var(--text);font-weight:900">Ú¯ÙˆØ´ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: Ø¨Ù„Ù‡</b>` : ""}
              </div>

              ${updText ? `
                <div class="mini-note">
                  <b style="color:var(--text)">Ù¾ÛŒØ§Ù… ØªÛŒÙ… Ù…ÙˆØ¨ÛŒÚ©Ø³:</b>
                  ${esc(updText)}${updTime ? `\n(${esc(updTime)})` : ""}
                </div>
              ` : ""}

              ${renderPriceBox(o)}

              <div class="price-actions" style="justify-content:flex-start">
                <button class="btn ghost" type="button" data-toggle-chat="${esc(orderNo)}">${chatBtnText}</button>
                <button class="btn ghost" type="button" data-refresh-chat="${esc(orderNo)}" ${chatOpen ? "" : "style='display:none'"}>Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú†Øª</button>
              </div>

              ${renderTrack(st)}
              ${renderChatBlock(orderNo)}
            </div>
          `;
        }).join("");

        // bind dynamic buttons after render
        bindOrderButtons();
      }

      function bindOrderButtons(){
        // Approve price
        ordersWrap.querySelectorAll("[data-approve]").forEach(btn => {
          btn.addEventListener("click", () => {
            const orderNo = btn.getAttribute("data-approve");
            const price = Number(btn.getAttribute("data-price") || 0);
            openPriceModal(orderNo, price);
          });
        });

        // Reject price
        ordersWrap.querySelectorAll("[data-reject]").forEach(btn => {
          btn.addEventListener("click", () => {
            const orderNo = btn.getAttribute("data-reject");
            const price = Number(btn.getAttribute("data-price") || 0);
            openRejectModal(orderNo, price);
          });
        });

        // Toggle chat
        ordersWrap.querySelectorAll("[data-toggle-chat]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const orderNo = btn.getAttribute("data-toggle-chat");
            if(chatState.openOrderNo === orderNo){
              chatState.openOrderNo = null;
              await loadOrders();
              return;
            }
            chatState.openOrderNo = orderNo;
            await loadChat(orderNo);
            await loadOrders();
            // scroll chat into view
            const card = ordersWrap.querySelector(`[data-order="${CSS.escape(orderNo)}"]`);
            if(card) card.scrollIntoView({ behavior:"smooth", block:"nearest" });
          });
        });

        // Refresh chat
        ordersWrap.querySelectorAll("[data-refresh-chat]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const orderNo = btn.getAttribute("data-refresh-chat");
            await loadChat(orderNo);
            await loadOrders();
          });
        });

        // Send chat
        ordersWrap.querySelectorAll("[data-send-chat]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const orderNo = btn.getAttribute("data-send-chat");
            const input = document.getElementById("chatInput_" + orderNo);
            const msgEl = document.getElementById("chatMsg_" + orderNo);
            if(!input || !msgEl) return;

            setMsg(msgEl, "", "");
            btn.disabled = true;

            const text = (input.value || "").trim();
            const res = await sendChat(orderNo, text);

            if(!res.ok){
              setMsg(msgEl, "err", "Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (res.error || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
              btn.disabled = false;
              return;
            }

            input.value = "";
            setMsg(msgEl, "ok", "Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ…");
            btn.disabled = false;

            await loadOrders();
          });
        });
      }

      // =========================
      // Init: load login
      // =========================
      try{
        const raw = localStorage.getItem(LS_KEY);
        loginState = raw ? JSON.parse(raw) : null;
      }catch(_e){ loginState = null; }

      applyLoginUI();
      loadDraft();

      if(loggedIn()){
        const fullName = getProfileName(loginState.phone09);
        if(fullName){
          helloBar.style.display = "";
          helloBar.textContent = "Ø³Ù„Ø§Ù… " + fullName + " ğŸ‘‹";
          customerName.value = fullName;
        }
        loadOrders();
      }

      // =========================
      // Events
      // =========================
      sendOtpBtn.addEventListener("click", sendOtp);
      verifyOtpBtn.addEventListener("click", verifyOtp);
      resendBtn.addEventListener("click", resend);

      acceptRules.addEventListener("change", refreshVerifyButtonState);

      createOrderBtn.addEventListener("click", createOrder);
      refreshOrdersBtn.addEventListener("click", loadOrders);

      if(logoutBtn) logoutBtn.addEventListener("click", logout);
      if(logoutTopBtn) logoutTopBtn.addEventListener("click", logout);

      // Save draft on input changes
      [customerName, deviceModel, problemDesc, address, pickupTime, replacementPhone].forEach(el => {
        if(!el) return;
        el.addEventListener("input", () => saveDraft());
        el.addEventListener("change", () => saveDraft());
      });

      // Quick issue chips -> append to textarea
      document.querySelectorAll(".qchip").forEach(btn => {
        btn.addEventListener("click", () => {
          const val = (btn.getAttribute("data-issue") || "").trim();
          if(!val) return;
          const cur = (problemDesc.value || "").trim();
          const next = cur ? (cur + (cur.endsWith("ØŒ") || cur.endsWith(",") ? " " : "ØŒ ") + val) : val;
          problemDesc.value = next;
          problemDesc.focus();
          saveDraft();
        });
      });

      // =========================
      // Name modal events
      // =========================
      nameModalClose.addEventListener("click", closeNameModal);
      nameModalBack.addEventListener("click", (e) => {
        if(e.target === nameModalBack) closeNameModal();
      });

      saveNameBtn.addEventListener("click", async () => {
        setMsg(nameModalMsg, "", "");
        if(!loggedIn()){
          setMsg(nameModalMsg, "err", "ÙˆØ¶Ø¹ÛŒØª ÙˆØ±ÙˆØ¯ Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª.");
          return;
        }
        const fullName = (profileFullName.value || "").trim();
        if(!fullName || fullName.length < 3){
          setMsg(nameModalMsg, "err", "Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }

        setProfileName(loginState.phone09, fullName);

        helloBar.style.display = "";
        helloBar.textContent = "Ø³Ù„Ø§Ù… " + fullName + " ğŸ‘‹";
        customerName.value = fullName;

        setMsg(nameModalMsg, "ok", "Ø«Ø¨Øª Ø´Ø¯ âœ…");
        setTimeout(() => closeNameModal(), 350);
      });

      skipNameBtn.addEventListener("click", () => {
        closeNameModal();
      });

      // =========================
      // Price modal events (two-step)
      // =========================
      function resetApproveModal(){
        approveStep = 1;
        priceConfirm1.checked = false;
        priceConfirm2.checked = false;
        priceStep1.style.display = "";
        priceStep2.style.display = "none";
        priceNextBtn.textContent = "Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯";
        setMsg(priceModalMsg, "", "");
      }

      priceModalClose.addEventListener("click", () => { closePriceModal(); });
      priceModalBack.addEventListener("click", (e) => { if(e.target === priceModalBack) closePriceModal(); });
      priceCancelBtn.addEventListener("click", () => { closePriceModal(); });

      priceNextBtn.addEventListener("click", async () => {
        setMsg(priceModalMsg, "", "");

        if(!pendingApprove){
          setMsg(priceModalMsg, "err", "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.");
          return;
        }

        if(approveStep === 1){
          if(!priceConfirm1.checked){
            setMsg(priceModalMsg, "err", "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ú¯Ø²ÛŒÙ†Ù‡ Â«Ù‚ÛŒÙ…Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù…Â» Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
            return;
          }
          approveStep = 2;
          priceStep1.style.display = "none";
          priceStep2.style.display = "";
          priceNextBtn.textContent = "ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø§Ø¯Ø§Ù…Ù‡";
          return;
        }

        if(approveStep === 2){
          if(!priceConfirm2.checked){
            setMsg(priceModalMsg, "err", "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ú¯Ø²ÛŒÙ†Ù‡ Â«ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ù‚ÛŒÙ…ØªÂ» Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
            return;
          }

          priceNextBtn.disabled = true;
          setMsg(priceModalMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª ØªØ£ÛŒÛŒØ¯ Ù‚ÛŒÙ…Øªâ€¦");

          await approvePriceFinal();
          priceNextBtn.disabled = false;
          return;
        }
      });

      // Reject modal events (two-step)
      function resetRejectModal(){
        rejectStep = 1;
        rejectConfirm1.checked = false;
        rejectConfirm2.checked = false;
        rejectStep1.style.display = "";
        rejectStep2.style.display = "none";
        rejectNextBtn.textContent = "Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯";
        setMsg(rejectModalMsg, "", "");
      }

      rejectModalClose.addEventListener("click", () => { closeRejectModal(); });
      rejectModalBack.addEventListener("click", (e) => { if(e.target === rejectModalBack) closeRejectModal(); });
      rejectCancelBtn.addEventListener("click", () => { closeRejectModal(); });

      rejectNextBtn.addEventListener("click", async () => {
        setMsg(rejectModalMsg, "", "");

        if(!pendingReject){
          setMsg(rejectModalMsg, "err", "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.");
          return;
        }

        if(rejectStep === 1){
          if(!rejectConfirm1.checked){
            setMsg(rejectModalMsg, "err", "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ú¯Ø²ÛŒÙ†Ù‡ Â«Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ù… Ù‚ÛŒÙ…Øª Ø±Ø§ Ø±Ø¯ Ú©Ù†Ù…Â» Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
            return;
          }
          rejectStep = 2;
          rejectStep1.style.display = "none";
          rejectStep2.style.display = "";
          rejectNextBtn.textContent = "Ø±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ";
          return;
        }

        if(rejectStep === 2){
          if(!rejectConfirm2.checked){
            setMsg(rejectModalMsg, "err", "Ø¨Ø±Ø§ÛŒ Ø±Ø¯ Ù†Ù‡Ø§ÛŒÛŒØŒ Ú¯Ø²ÛŒÙ†Ù‡ Â«Ø±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ù‚ÛŒÙ…ØªÂ» Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
            return;
          }

          rejectNextBtn.disabled = true;
          setMsg(rejectModalMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø±Ø¯ Ù‚ÛŒÙ…Øªâ€¦");

          await rejectPriceFinal();

          rejectNextBtn.disabled = false;
          return;
        }
      });

      // =========================
      // Keyboard: ESC closes modals
      // =========================
      document.addEventListener("keydown", (e) => {
        if(e.key === "Escape"){
          if(nameModalBack.style.display === "flex") closeNameModal();
          if(priceModalBack.style.display === "flex") closePriceModal();
          if(rejectModalBack.style.display === "flex") closeRejectModal();
        }
      });

      // =========================
      // Ensure verify button state
      // =========================
      refreshVerifyButtonState();
    })();
  </script>
</body>
</html>
