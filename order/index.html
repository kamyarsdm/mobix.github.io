<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ | Ù…ÙˆØ¨ÛŒÚ©Ø³</title>

  <meta name="theme-color" content="#1F6AFF" />
  <link rel="icon" href="../assets/logo.png" />

  <!-- Vazirmatn -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F6F8FC;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#5B6B84;
      --line:rgba(15,23,42,.08);

      --shadow: 0 14px 36px rgba(15,23,42,.10);
      --shadow2: 0 8px 18px rgba(15,23,42,.08);

      --radius:22px;

      --primary:#1F6AFF;
      --primary2:#3B82F6;
      --success:#10B981;
      --danger:#EF4444;
      --warn:#F59E0B;

      --max:1120px;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:"Vazirmatn", system-ui, sans-serif;
      background:
        radial-gradient(1000px 500px at 80% -10%, rgba(31,106,255,.16), transparent 55%),
        radial-gradient(900px 600px at 20% 10%, rgba(59,130,246,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{text-decoration:none;color:inherit}
    img{max-width:100%;display:block}

    .container{
      max-width:var(--max);
      margin:auto;
      padding:14px 16px 70px;
    }

    /* TOP BAR */
    .topbar{
      position:sticky;top:0;z-index:50;
      padding:10px 0;
      backdrop-filter: blur(12px);
    }
    .topbar-inner{
      display:flex;align-items:center;justify-content:space-between;
      background:rgba(246,248,252,.86);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      gap:10px;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{width:74px;height:auto}
    .brand-title{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand-title b{font-weight:900;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand-title span{font-size:12.7px;color:var(--muted);font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .nav{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chip{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:900;
      font-size:13px;
      box-shadow:var(--shadow2);
      white-space:nowrap;
    }

    .btn{
      padding:10px 16px;
      border-radius:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-family:inherit;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;
      border:none;
    }
    .btn.ghost{
      background:rgba(255,255,255,.72);
    }
    .btn.danger{
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      color:#7F1D1D;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .hero{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .hero-title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    h1{
      font-size:30px;
      font-weight:900;
      margin:0;
      letter-spacing:-.3px;
      line-height:1.25;
    }
    .sub{
      color:var(--muted);
      font-size:14.2px;
      line-height:1.95;
      margin:6px 0 0;
    }

    .tabs{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      box-shadow:var(--shadow2);
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(31,106,255,.10);
      border-color:rgba(31,106,255,.22);
      color:#0B2A6A;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
    }
    .label{
      font-size:13px;
      font-weight:900;
      color:var(--muted);
    }
    .input{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:800;
      outline:none;
    }
    .textarea{
      width:100%;
      min-height:110px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:800;
      outline:none;
      resize:vertical;
      line-height:1.95;
    }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.8;
      white-space:pre-line;
    }

    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:900;
      font-size:12.8px;
      white-space:nowrap;
    }
    .status.ok{border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.08);color:#0B3A2C}
    .status.err{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:#7F1D1D}
    .status.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:#78350F}

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .divider{height:1px;background:var(--line);margin:12px 0}

    .checkrow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      box-shadow:var(--shadow2);
      margin-top:10px;
    }
    .checkrow input{
      width:18px;height:18px;
      accent-color: var(--primary);
      margin-top:2px;
    }
    .checkrow b{
      font-weight:900;
      font-size:13.5px;
    }
    .checkrow span{
      color:var(--muted);
      font-size:12.8px;
      line-height:1.75;
    }

    .quick-issues{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .qchip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.72);
      font-weight:900;
      font-size:12.8px;
      cursor:pointer;
      box-shadow:var(--shadow2);
      user-select:none;
    }

    .orders{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .order-item{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .order-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .order-top b{font-weight:900}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(31,106,255,.10);
      border:1px solid rgba(31,106,255,.18);
      color:#0B2A6A;
      font-weight:900;
      font-size:12.5px;
      white-space:nowrap;
    }
    .muted{color:var(--muted);font-size:13.2px;line-height:1.9}

    .track{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      margin-top:4px;
    }
    .track-step{
      display:flex;
      align-items:flex-start;
      gap:10px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:16px;
      padding:10px;
    }
    .track-bullet{
      width:28px;height:28px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }
    .track-step.done .track-bullet{
      background:rgba(16,185,129,.10);
      border-color:rgba(16,185,129,.25);
      color:#0B3A2C;
    }
    .track-step.active .track-bullet{
      background:rgba(31,106,255,.10);
      border-color:rgba(31,106,255,.25);
      color:#0B2A6A;
    }
    .track-step .tt b{display:block;font-weight:900}
    .track-step .tt span{display:block;color:var(--muted);font-size:13px;line-height:1.85;margin-top:3px}

    /* Chat (UI Ø¢Ù…Ø§Ø¯Ù‡ØŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ Ø¨Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„) */
    .chatbox{
      margin-top:10px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
    }
    .chat-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .chat-messages{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      min-height:120px;
      max-height:240px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .bubble{
      max-width:78%;
      border-radius:16px;
      padding:10px 12px;
      border:1px solid var(--line);
      box-shadow:var(--shadow2);
      line-height:1.85;
      font-weight:800;
      font-size:13.2px;
      background:#fff;
    }
    .bubble.me{
      margin-right:auto;
      background:rgba(31,106,255,.08);
      border-color:rgba(31,106,255,.18);
      color:#0B2A6A;
    }
    .bubble.them{
      margin-left:auto;
      background:#fff;
    }
    .chat-send{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chat-send .input{flex:1 1 240px}
    .small-note{
      margin-top:8px;
      color:var(--muted);
      font-size:12.8px;
      line-height:1.75;
    }

    /* MOBILE */
    @media (max-width: 520px){
      .container{ padding-bottom: 90px; }
      .topbar-inner{ border-radius:22px; padding:10px 10px; }
      .brand img{width:64px}
      h1{font-size:26px}
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- HEADER (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: Ø¯Ø±Ø¨Ø§Ø±Ù‡â€ŒÙ…Ø§ Ùˆ ØªÙ…Ø§Ø³ Ø­Ø°Ù Ø´Ø¯) -->
    <div class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="../index.html" aria-label="Mobix Home">
          <img src="../assets/logo.png" alt="Mobix">
          <div class="brand-title">
            <b>Ù…ÙˆØ¨ÛŒÚ©Ø³</b>
            <span>Ø³Ø±ÙˆÛŒØ³ ØªØ®ØµØµÛŒ ØªØ¹Ù…ÛŒØ± Ù…ÙˆØ¨Ø§ÛŒÙ„</span>
          </div>
        </a>

        <div class="nav">
          <button class="btn primary" type="button" id="headerOrderBtn">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
          <button class="btn ghost" type="button" id="headerMyOrdersBtn">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
          <button class="btn danger" type="button" id="headerLogoutBtn" style="display:none">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero">
      <div class="card">
        <div class="hero-title">
          <div>
            <h1>ÙˆØ±ÙˆØ¯ØŒ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</h1>
            <p class="sub">Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯ØŒ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ØŒ Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ù…Ø±Ø­Ù„Ù‡â€ŒØ¨Ù‡â€ŒÙ…Ø±Ø­Ù„Ù‡ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</p>
          </div>

          <div class="tabs" role="tablist" aria-label="tabs">
            <div class="tab active" id="tabOrder" role="tab" aria-selected="true">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</div>
            <div class="tab" id="tabMyOrders" role="tab" aria-selected="false">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid">

          <!-- AUTH CARD -->
          <div class="card" id="authCard" style="padding:16px;box-shadow:var(--shadow2)">
            <div class="row">
              <b style="font-weight:900">ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ</b>
              <span id="sessionBadge" class="status warn">ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯</span>
            </div>

            <div class="field">
              <div class="label">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
              <input id="authPhone" class="input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§ 0912xxxxxxx" />
            </div>

            <!-- (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 3) Ù‚ÙˆØ§Ù†ÛŒÙ† Ù‚Ø¨Ù„ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ -->
            <div class="checkrow" aria-label="Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³">
              <input id="acceptTerms" type="checkbox" />
              <div style="display:flex;flex-direction:column;gap:2px">
                <b>Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù…</b>
                <span>Ø¨Ø§ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø´Ù…Ø§ Ù…ÙˆØ§ÙÙ‚Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ú©Ù‡ ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§ØŒ ØªØ¹Ù…ÛŒØ± Ø´Ø±ÙˆØ¹ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒâ€ŒÙ‡Ø§ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.</span>
              </div>
            </div>

            <div class="row">
              <button id="sendOtpBtn" class="btn primary" type="button">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯</button>
              <span id="timerPill" class="status warn" style="display:none">02:00</span>
              <button id="resendBtn" class="btn ghost" type="button" disabled style="min-width:130px">Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯</button>
            </div>

            <div id="otpBox" style="display:none">
              <div class="field">
                <div class="label">Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ</div>
                <input id="authCode" class="input" inputmode="numeric" placeholder="Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ" />
              </div>

              <div class="row">
                <button id="verifyOtpBtn" class="btn primary" type="button">ØªØ§ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
              </div>
            </div>

            <!-- (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 4) Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ -->
            <div id="nameBox" style="display:none">
              <div class="divider"></div>
              <b style="font-weight:900">Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</b>
              <div class="field">
                <div class="label">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</div>
                <input id="profileFullName" class="input" placeholder="Ù…Ø«Ù„Ø§ Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ÛŒ" />
              </div>
              <div class="row">
                <button id="saveNameBtn" class="btn primary" type="button">Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ Ø§Ø¯Ø§Ù…Ù‡</button>
              </div>
            </div>

            <div id="authMsg" class="hint" aria-live="polite"></div>
          </div>

          <!-- ORDER + MY ORDERS CARD -->
          <div class="card" style="padding:16px;box-shadow:var(--shadow2)">
            <!-- (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 5) Ø³Ù„Ø§Ù… Ú©Ø§Ø±Ø¨Ø± -->
            <div class="row">
              <div>
                <b id="helloUser" style="font-weight:900">Ø³Ù„Ø§Ù… ğŸ‘‹</b>
                <div class="sub" id="helloSub" style="margin-top:4px">Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ØŒ ÙØ±Ù… Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯.</div>
              </div>

              <!-- (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 6) Ù¾ÛŒØ§Ù… Â«ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯Â» Ø¯Ø± Ø§ÛŒÙ† Ú©Ø§Ø¯Ø± Ø­Ø°Ù Ø´Ø¯ -->
              <span id="orderGate" class="status warn" style="display:none">Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</span>
            </div>

            <div id="orderPanel">
              <div class="divider"></div>

              <div id="orderFormWrap">
                <div class="field">
                  <div class="label">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</div>
                  <input id="customerName" class="input" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" />
                </div>

                <div class="field">
                  <div class="label">Ù…Ø¯Ù„ Ú¯ÙˆØ´ÛŒ</div>
                  <input id="deviceModel" class="input" placeholder="Ù…Ø«Ù„Ø§ iPhone 13 / Galaxy A52" />
                </div>

                <div class="checkrow" aria-label="Ú¯ÙˆØ´ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†">
                  <input id="replacementPhone" type="checkbox" />
                  <div style="display:flex;flex-direction:column;gap:2px">
                    <b>Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú¯ÙˆØ´ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¯Ø§Ø±Ù…</b>
                    <span>Ø§Ú¯Ø± Ø¯Ø± Ø²Ù…Ø§Ù† ØªØ¹Ù…ÛŒØ± Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.</span>
                  </div>
                </div>

                <div class="field">
                  <div class="label">Ù…Ø´Ú©Ù„ Ø¯Ø³ØªÚ¯Ø§Ù‡</div>
                  <textarea id="problemDesc" class="textarea" placeholder="Ù…Ø«Ù„Ø§ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù‡ / Ø´Ú©Ø³ØªÚ¯ÛŒ Ø§Ù„â€ŒØ³ÛŒâ€ŒØ¯ÛŒ / Ù…Ø´Ú©Ù„ Ø´Ø§Ø±Ú˜ ..."></textarea>
                  <div class="quick-issues" aria-label="Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ÛŒØ¬">
                    <div class="qchip" data-issue="Ø´Ú©Ø³ØªÚ¯ÛŒ/Ø®Ø· Ø±ÙˆÛŒ Ø§Ù„â€ŒØ³ÛŒâ€ŒØ¯ÛŒ">Ø´Ú©Ø³ØªÚ¯ÛŒ LCD</div>
                    <div class="qchip" data-issue="Ù…Ø´Ú©Ù„ Ø´Ø§Ø±Ú˜/Ø³ÙˆÚ©Øª Ø´Ø§Ø±Ú˜">Ù…Ø´Ú©Ù„ Ø´Ø§Ø±Ú˜</div>
                    <div class="qchip" data-issue="Ø¨Ø§ØªØ±ÛŒ Ø¶Ø¹ÛŒÙ/Ø²ÙˆØ¯ Ø®Ø§Ù„ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯">Ø¨Ø§ØªØ±ÛŒ</div>
                    <div class="qchip" data-issue="Ø¢Ø¨â€ŒØ®ÙˆØ±Ø¯Ú¯ÛŒ">Ø¢Ø¨â€ŒØ®ÙˆØ±Ø¯Ú¯ÛŒ</div>
                    <div class="qchip" data-issue="Ø®Ø§Ù…ÙˆØ´ÛŒ/Ø±ÛŒØ³Øª Ø´Ø¯Ù†">Ø®Ø§Ù…ÙˆØ´ÛŒ/Ø±ÛŒØ³Øª</div>
                    <div class="qchip" data-issue="Ù…Ø´Ú©Ù„ ØµØ¯Ø§/Ù…ÛŒÚ©Ø±ÙˆÙÙ†">ØµØ¯Ø§/Ù…ÛŒÚ©Ø±ÙˆÙÙ†</div>
                  </div>
                </div>

                <div class="field">
                  <div class="label">Ø¢Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§ Ù¾ÛŒÚ©</div>
                  <textarea id="address" class="textarea" placeholder="Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚ + Ù¾Ù„Ø§Ú© + ÙˆØ§Ø­Ø¯"></textarea>
                </div>

                <div class="row">
                  <div style="flex:1 1 260px">
                    <div class="label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</div>
                    <input id="altPhone" class="input" inputmode="numeric" placeholder="Ø§Ú¯Ø± Ø´Ù…Ø§Ø±Ù‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯" />
                  </div>
                  <div style="flex:1 1 260px">
                    <div class="label">Ø²Ù…Ø§Ù† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª</div>
                    <input id="pickupTime" class="input" placeholder="Ù…Ø«Ù„Ø§ Ø§Ù…Ø±ÙˆØ² Û±Û¸ ØªØ§ Û²Û° / ÙØ±Ø¯Ø§ ØµØ¨Ø­" />
                  </div>
                </div>

                <div class="row">
                  <button id="createOrderBtn" class="btn primary" type="button">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
                  <button id="refreshOrdersBtn" class="btn ghost" type="button">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                  <button id="goMyOrdersBtn" class="btn ghost" type="button">Ø±ÙØªÙ† Ø¨Ù‡ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
                </div>

                <div id="orderMsg" class="hint" aria-live="polite"></div>
              </div>

              <div class="divider"></div>

              <div class="row">
                <b style="font-weight:900">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</b>
                <span id="ordersCount" class="status">0</span>
              </div>

              <div id="ordersWrap" class="orders">
                <div class="muted">Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    (function(){
      // =========================
      // Supabase Config
      // =========================
      const SUPABASE_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyeGZoZmtubXhtZWF0bmZ6cGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTg2MjksImV4cCI6MjA4MTgzNDYyOX0.iANOG9-g9GnVl58KDYI0A-oYNwfbL3oh2NBddZ2sLLs";

      const OTP_REQUEST_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/request-otp";
      const OTP_VERIFY_URL  = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/verify-otp";

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // =========================
      // Helpers
      // =========================
      function normalizeDigits(s){
        return (s || "")
          .replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d))
          .replace(/[^\d]/g, "");
      }
      function isValidIranMobile(d){
        if(!d) return false;
        if(d.length === 11 && d.startsWith("09")) return true;
        if(d.length === 10 && d.startsWith("9")) return true;
        return false;
      }
      function to09(d){
        if(!d) return null;
        if(d.length === 11 && d.startsWith("09")) return d;
        if(d.length === 10 && d.startsWith("9")) return "0" + d;
        return null;
      }
      function fmtDate(iso){
        try{
          const dt = new Date(iso);
          if(isNaN(dt.getTime())) return iso || "";
          return dt.toLocaleString("fa-IR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        }catch(e){ return iso || ""; }
      }
      function esc(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      async function safeJson(res){
        try{ return await res.json(); }catch(e){ return null; }
      }
      function extractErrorMessage(obj){
        if(!obj) return null;
        if(typeof obj === "string") return obj;
        return obj.message || obj.error || (obj.errors && obj.errors[0] && (obj.errors[0].message || obj.errors[0])) || null;
      }

      // generate order_no: MCC-YYMMDD-XXXX
      function genOrderNo(){
        const d = new Date();
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const rand = String(Math.floor(1000 + Math.random()*9000));
        return `MCC-${yy}${mm}${dd}-${rand}`;
      }

      function formatMMSS(sec){
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
      }

      // =========================
      // UI Elements
      // =========================
      const authCard = document.getElementById("authCard");
      const sessionBadge = document.getElementById("sessionBadge");

      const authPhone = document.getElementById("authPhone");
      const authCode = document.getElementById("authCode");
      const acceptTerms = document.getElementById("acceptTerms");

      const sendOtpBtn = document.getElementById("sendOtpBtn");
      const verifyOtpBtn = document.getElementById("verifyOtpBtn");
      const resendBtn = document.getElementById("resendBtn");
      const timerPill = document.getElementById("timerPill");
      const otpBox = document.getElementById("otpBox");
      const authMsg = document.getElementById("authMsg");

      const nameBox = document.getElementById("nameBox");
      const profileFullName = document.getElementById("profileFullName");
      const saveNameBtn = document.getElementById("saveNameBtn");

      const headerOrderBtn = document.getElementById("headerOrderBtn");
      const headerMyOrdersBtn = document.getElementById("headerMyOrdersBtn");
      const headerLogoutBtn = document.getElementById("headerLogoutBtn");

      const tabOrder = document.getElementById("tabOrder");
      const tabMyOrders = document.getElementById("tabMyOrders");
      const goMyOrdersBtn = document.getElementById("goMyOrdersBtn");

      const helloUser = document.getElementById("helloUser");
      const helloSub = document.getElementById("helloSub");

      const customerName = document.getElementById("customerName");
      const deviceModel = document.getElementById("deviceModel");
      const replacementPhone = document.getElementById("replacementPhone");
      const problemDesc = document.getElementById("problemDesc");
      const address = document.getElementById("address");
      const altPhone = document.getElementById("altPhone");
      const pickupTime = document.getElementById("pickupTime");

      const createOrderBtn = document.getElementById("createOrderBtn");
      const refreshOrdersBtn = document.getElementById("refreshOrdersBtn");
      const orderMsg = document.getElementById("orderMsg");
      const ordersWrap = document.getElementById("ordersWrap");
      const ordersCount = document.getElementById("ordersCount");

      // =========================
      // State
      // =========================
      const LS_LOGIN = "mobix_order_login";
      const LS_PROFILE = "mobix_order_profile";
      const LS_DRAFT = "mobix_order_draft";

      let loginState = null; // { phone09 }
      let profile = null; // { full_name }
      let lastPhone09 = null;

      let timerId = null;
      let remaining = 0;

      // =========================
      // Status / Messages
      // =========================
      function setStatus(el, type, text){
        el.classList.remove("ok","err","warn");
        if(type) el.classList.add(type);
        el.textContent = text;
      }
      function setMsg(el, type, text){
        if(!text){
          el.textContent = "";
          el.style.color = "var(--muted)";
          return;
        }
        if(type === "ok") el.style.color = "var(--success)";
        else if(type === "err") el.style.color = "var(--danger)";
        else if(type === "warn") el.style.color = "var(--warn)";
        else el.style.color = "var(--muted)";
        el.textContent = text;
      }

      // =========================
      // Tabs
      // =========================
      function showTab(which){
        const orderActive = which === "order";
        tabOrder.classList.toggle("active", orderActive);
        tabOrder.setAttribute("aria-selected", orderActive ? "true" : "false");
        tabMyOrders.classList.toggle("active", !orderActive);
        tabMyOrders.setAttribute("aria-selected", !orderActive ? "true" : "false");

        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ù†Ø±Ù… Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ±
        if(orderActive){
          document.getElementById("orderFormWrap").scrollIntoView({ behavior:"smooth", block:"start" });
        }else{
          ordersWrap.scrollIntoView({ behavior:"smooth", block:"start" });
        }
      }

      // =========================
      // Timer
      // =========================
      function stopTimer(){
        if(timerId) clearInterval(timerId);
        timerId = null;
      }
      function startTimer(seconds){
        stopTimer();
        remaining = seconds;
        resendBtn.disabled = true;
        timerPill.style.display = "";
        setStatus(timerPill, "warn", formatMMSS(remaining));

        timerId = setInterval(() => {
          remaining -= 1;
          if(remaining <= 0){
            stopTimer();
            setStatus(timerPill, "ok", "00:00");
            resendBtn.disabled = false;
            return;
          }
          setStatus(timerPill, "warn", formatMMSS(remaining));
        }, 1000);
      }

      // =========================
      // Draft
      // =========================
      function saveDraft(){
        const d = {
          customer_name: (customerName.value || "").trim(),
          device_model: (deviceModel.value || "").trim(),
          wants_replacement_phone: !!(replacementPhone && replacementPhone.checked),
          issue: (problemDesc.value || "").trim(),
          pickup_address: (address.value || "").trim(),
          pickup_time_text: (pickupTime.value || "").trim(),
          alt_phone: (altPhone.value || "").trim(),
        };
        localStorage.setItem(LS_DRAFT, JSON.stringify(d));
      }
      function loadDraft(){
        try{
          const raw = localStorage.getItem(LS_DRAFT);
          if(!raw) return;
          const d = JSON.parse(raw);
          if(d && typeof d === "object"){
            if(d.customer_name != null) customerName.value = d.customer_name;
            if(d.device_model != null) deviceModel.value = d.device_model;
            if(d.wants_replacement_phone != null && replacementPhone) replacementPhone.checked = !!d.wants_replacement_phone;
            if(d.issue != null) problemDesc.value = d.issue;
            if(d.pickup_address != null) address.value = d.pickup_address;
            if(d.pickup_time_text != null) pickupTime.value = d.pickup_time_text;
            if(d.alt_phone != null) altPhone.value = d.alt_phone;
          }
        }catch(_e){}
      }

      // =========================
      // Auth edge calls
      // =========================
      async function requestOtpEdge(phone09){
        const res = await fetch(OTP_REQUEST_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09 })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");
        }
        return json || { ok: true, expires_in_seconds: 120 };
      }

      async function verifyOtpEdge(phone09, code){
        const res = await fetch(OTP_VERIFY_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09, code })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");
        }
        return json || { ok: true };
      }

      // =========================
      // Login state
      // =========================
      function loggedIn(){
        return !!(loginState && loginState.phone09);
      }

      function applyProfileToUI(){
        const fullName = (profile && profile.full_name) ? profile.full_name.trim() : "";
        if(fullName){
          helloUser.textContent = "Ø³Ù„Ø§Ù… " + fullName + " ğŸ‘‹";
          helloSub.textContent = "ÙØ±Ù… Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯ Ùˆ Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.";
          // Ø§Ú¯Ø± Ø§Ø³Ù… Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù‡Ø³ØªØŒ Ø¯Ø§Ø®Ù„ ÙØ±Ù… Ù‡Ù… Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø´ÙˆØ¯
          if(!customerName.value) customerName.value = fullName;
        }else{
          helloUser.textContent = "Ø³Ù„Ø§Ù… ğŸ‘‹";
          helloSub.textContent = "Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ØŒ ÙØ±Ù… Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯.";
        }
      }

      function applyLoginUI(){
        const li = loggedIn();

        if(li){
          setStatus(sessionBadge, "ok", "ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ âœ…");
          headerLogoutBtn.style.display = "";
          // (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 2) Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ú©Ø§Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¯ÛŒØ¯Ù‡ Ù†Ø´Ù‡
          authCard.style.display = "none";

          // Ø§Ú¯Ø± Ù†Ø§Ù… Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¨Ù¾Ø±Ø³
          const fullName = (profile && profile.full_name) ? profile.full_name.trim() : "";
          if(!fullName){
            // Ú©Ø§Ø¯Ø± ÙˆØ±ÙˆØ¯ Ù…Ø®ÙÛŒ Ø´Ø¯Ù‡ØŒ ÙˆÙ„ÛŒ Ø¨Ø®Ø´ Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ù‡Ù…Ø§Ù† Ú©Ø§Ø±Øª (Ø¨Ø±Ø§ÛŒ Ù‚Ø·Ø¹ Ù†Ú©Ø±Ø¯Ù† Ø¬Ø±ÛŒØ§Ù†)
            // Ú†ÙˆÙ† Ú©Ø§Ø±Øª Ù…Ø®ÙÛŒ Ø´Ø¯Ù‡ØŒ Ù…ÙˆÙ‚ØªØ§Ù‹ Ú©Ø§Ø±Øª Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù…â€ŒÚ¯ÛŒØ±ÛŒØŒ Ø³Ù¾Ø³ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…Ø®ÙÛŒ.
            authCard.style.display = "";
            otpBox.style.display = "none";
            nameBox.style.display = "";
            setMsg(authMsg, "warn", "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          }else{
            nameBox.style.display = "none";
            authCard.style.display = "none";
            setMsg(authMsg, "", "");
          }
        }else{
          setStatus(sessionBadge, "warn", "ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯");
          headerLogoutBtn.style.display = "none";
          authCard.style.display = "";
          otpBox.style.display = "none";
          nameBox.style.display = "none";
        }

        applyProfileToUI();
      }

      // =========================
      // Actions: Auth
      // =========================
      async function sendOtp(){
        setMsg(authMsg, "", "");

        // Ù‚ÙˆØ§Ù†ÛŒÙ†
        if(!acceptTerms.checked){
          setMsg(authMsg, "err", "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ÛŒØ¯ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ±ÛŒØ¯.");
          return;
        }

        const d = normalizeDigits(authPhone.value);
        if(!isValidIranMobile(d)){
          setMsg(authMsg, "err", "Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø±Ø³Øª Ù†ÛŒØ³Øª. Ù…Ø«Ù„ 0912xxxxxxx ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }
        const phone09 = to09(d);
        if(!phone09){
          setMsg(authMsg, "err", "Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø§Ø¨Ù„ ØªØ¨Ø¯ÛŒÙ„ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
          return;
        }

        sendOtpBtn.disabled = true;
        resendBtn.disabled = true;
        setMsg(authMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯â€¦");

        try{
          const out = await requestOtpEdge(phone09);
          lastPhone09 = phone09;

          otpBox.style.display = "";
          nameBox.style.display = "none";

          // Ù¾ÛŒØ§Ù… Ø­Ø±ÙÙ‡â€ŒØ§ÛŒâ€ŒØªØ± Ø¨Ø±Ø§ÛŒ OTP
          setMsg(authMsg, "ok", "Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ… (ÙÙ‚Ø· Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù…Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯)");

          const secs = Number(out?.expires_in_seconds ?? 120);
          startTimer(Number.isFinite(secs) ? secs : 120);

          authCode.focus();
        }catch(err){
          setMsg(authMsg, "err", "Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (err?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
          otpBox.style.display = "none";
          stopTimer();
          timerPill.style.display = "none";
        }finally{
          sendOtpBtn.disabled = false;
        }
      }

      async function verifyOtp(){
        setMsg(authMsg, "", "");

        // Ù‚ÙˆØ§Ù†ÛŒÙ†
        if(!acceptTerms.checked){
          setMsg(authMsg, "err", "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ÛŒØ¯ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ±ÛŒØ¯.");
          return;
        }

        const code = normalizeDigits(authCode.value);

        if(!lastPhone09){
          setMsg(authMsg, "err", "Ø§ÙˆÙ„ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ú©Ø¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.");
          return;
        }
        if(!code || code.length < 4){
          setMsg(authMsg, "err", "Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }

        verifyOtpBtn.disabled = true;
        setMsg(authMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ú©Ø¯â€¦");

        try{
          await verifyOtpEdge(lastPhone09, code);

          loginState = { phone09: lastPhone09 };
          localStorage.setItem(LS_LOGIN, JSON.stringify(loginState));

          authCode.value = "";
          setMsg(authMsg, "ok", "ÙˆØ±ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…");

          // Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯: Ø§Ú¯Ø± Ù†Ø§Ù… Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù…â€ŒÚ¯ÛŒØ±ÛŒ
          const fullName = (profile && profile.full_name) ? profile.full_name.trim() : "";
          if(!fullName){
            otpBox.style.display = "none";
            nameBox.style.display = "";
            profileFullName.focus();
          }else{
            authCard.style.display = "none";
            nameBox.style.display = "none";
          }

          applyLoginUI();
          loadDraft();
          await loadOrders();
        }catch(err){
          // Ù¾ÛŒØ§Ù… Ø­Ø±ÙÙ‡â€ŒØ§ÛŒâ€ŒØªØ±
          const msg = (err?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ");
          setMsg(authMsg, "err", "Ø§ÛŒÙ† Ú©Ø¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ø§Ú¯Ø± Ú†Ù†Ø¯ Ø¨Ø§Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŒ Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù…Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          console.warn("OTP verify error:", msg);
        }finally{
          verifyOtpBtn.disabled = false;
        }
      }

      async function resend(){
        if(resendBtn.disabled) return;
        if(!lastPhone09){
          setMsg(authMsg, "err", "Ø§ÙˆÙ„ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }
        authPhone.value = lastPhone09;
        await sendOtp();
      }

      function logout(){
        setMsg(authMsg, "", "");
        loginState = null;
        localStorage.removeItem(LS_LOGIN);
        lastPhone09 = null;
        stopTimer();
        timerPill.style.display = "none";
        otpBox.style.display = "none";
        nameBox.style.display = "none";
        authPhone.value = "";
        authCode.value = "";
        setMsg(authMsg, "ok", "Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.");
        applyLoginUI();

        ordersWrap.innerHTML = '<div class="muted">Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>';
        ordersCount.textContent = "0";
      }

      function saveProfileName(){
        const fullName = (profileFullName.value || "").trim();
        if(fullName.length < 3){
          setMsg(authMsg, "err", "Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }
        profile = { full_name: fullName };
        localStorage.setItem(LS_PROFILE, JSON.stringify(profile));

        // Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ±: Ø§Ø³Ù… Ø¯Ø§Ø®Ù„ ÙØ±Ù… Ù‡Ù… Ø³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯
        if(!customerName.value) customerName.value = fullName;

        setMsg(authMsg, "ok", "Ø«Ø¨Øª Ø´Ø¯ âœ…");
        nameBox.style.display = "none";
        authCard.style.display = "none";
        applyLoginUI();
      }

      // =========================
      // Orders UI mapping
      // =========================
      const TRACK_STEPS = [
        { key:"requested", title:"Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª", desc:"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³Øª." },
        { key:"picked_up", title:"Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§ Ù¾ÛŒÚ©", desc:"Ù¾ÛŒÚ© Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯." },
        { key:"quoted", title:"Ø§Ø¹Ù„Ø§Ù…/ØªØ£ÛŒÛŒØ¯ Ù‡Ø²ÛŒÙ†Ù‡", desc:"Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø¹Ù„Ø§Ù… Ø´Ø¯ Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§Ø³Øª." },
        { key:"repairing", title:"Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±", desc:"ØªÚ©Ù†Ø³ÛŒÙ† Ù…ÙˆØ¨ÛŒÚ©Ø³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… ØªØ¹Ù…ÛŒØ± Ø§Ø³Øª." },
        { key:"delivering", title:"Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ ØªØ­ÙˆÛŒÙ„", desc:"Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ù…Ø³ÛŒØ± ØªØ­ÙˆÛŒÙ„ Ø§Ø³Øª." },
        { key:"delivered", title:"ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ø´Ù…Ø§", desc:"Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ âœ…" }
      ];

      function normalizeStatus(raw){
        const s = (raw || "").toString().trim().toLowerCase();
        if(["new","created","request","requested","pending"].includes(s)) return "requested";
        if(["pickup","pickedup","picked_up","courier_pickup"].includes(s)) return "picked_up";
        if(["quote","quoted","price","awaiting_approval","approved_pending"].includes(s)) return "quoted";
        if(["repair","repairing","in_repair","fixing"].includes(s)) return "repairing";
        if(["deliver","delivering","shipping","on_the_way"].includes(s)) return "delivering";
        if(["done","delivered","completed","complete"].includes(s)) return "delivered";
        return s || "requested";
      }

      // (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 7) ÙØ§Ø±Ø³ÛŒâ€ŒØ³Ø§Ø²ÛŒ ÙˆØ¶Ø¹ÛŒØª
      function statusLabel(key){
        const k = normalizeStatus(key);
        const m = {
          requested: "Ø«Ø¨Øª Ø´Ø¯",
          picked_up: "Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§ Ù¾ÛŒÚ©",
          quoted: "Ø§Ø¹Ù„Ø§Ù… Ù‡Ø²ÛŒÙ†Ù‡",
          repairing: "Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±",
          delivering: "Ø¯Ø± Ù…Ø³ÛŒØ± ØªØ­ÙˆÛŒÙ„",
          delivered: "ØªØ­ÙˆÛŒÙ„ Ø´Ø¯"
        };
        return m[k] || k;
      }

      function stepIndex(key){
        const idx = TRACK_STEPS.findIndex(x => x.key === key);
        return idx < 0 ? 0 : idx;
      }

      function renderTrack(statusKey){
        const norm = normalizeStatus(statusKey);
        const activeIdx = stepIndex(norm);
        return `
          <div class="track">
            ${TRACK_STEPS.map((s, i) => {
              const cls = i < activeIdx ? "done" : (i === activeIdx ? "active" : "");
              const bullet = i < activeIdx ? "âœ“" : (i === activeIdx ? "â€¢" : (i+1));
              return `
                <div class="track-step ${cls}">
                  <div class="track-bullet">${bullet}</div>
                  <div class="tt">
                    <b>${esc(s.title)}</b>
                    <span>${esc(s.desc)}</span>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }

      // =========================
      // Build issue extra
      // =========================
      function buildIssueWithExtras(baseIssue){
        const wants = !!(replacementPhone && replacementPhone.checked);
        if(!wants) return baseIssue;
        const suffix = "Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú¯ÙˆØ´ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: Ø¨Ù„Ù‡";
        const cur = (baseIssue || "").trim();
        if(!cur) return suffix;
        if(cur.includes(suffix)) return cur;
        return cur + (cur.endsWith("ØŒ") || cur.endsWith(",") ? " " : "ØŒ ") + suffix;
      }

      // =========================
      // Create order
      // =========================
      async function createOrder(){
        setMsg(orderMsg, "", "");

        const cn = (customerName.value || "").trim();
        const dm = (deviceModel.value || "").trim();
        const issueRaw = (problemDesc.value || "").trim();
        const issue = buildIssueWithExtras(issueRaw);
        const addr = (address.value || "").trim();
        const pt = (pickupTime.value || "").trim();
        const ap = (altPhone.value || "").trim();

        if(!cn || !dm || !issue || !addr){
          setMsg(orderMsg, "err", "Ù†Ø§Ù…ØŒ Ù…Ø¯Ù„ Ú¯ÙˆØ´ÛŒØŒ Ù…Ø´Ú©Ù„ Ùˆ Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
        }

        if(!loggedIn()){
          setMsg(orderMsg, "warn", "Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø³ÙØ§Ø±Ø´ØŒ Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
          authCard.style.display = "";
          acceptTerms.scrollIntoView({ behavior:"smooth", block:"center" });
          return;
        }

        // Ø§Ú¯Ø± Ù†Ø§Ù… Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ù…Ø¬Ø¨ÙˆØ±Ø´ Ú©Ù† Ù‚Ø¨Ù„ Ø§Ø² Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ ÙˆØ§Ø±Ø¯ Ú©Ù†Ø¯
        const fullName = (profile && profile.full_name) ? profile.full_name.trim() : "";
        if(!fullName){
          setMsg(orderMsg, "warn", "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.");
          authCard.style.display = "";
          nameBox.style.display = "";
          profileFullName.focus();
          return;
        }

        createOrderBtn.disabled = true;
        setMsg(orderMsg, "warn", "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´â€¦");

        // ÙÙ‚Ø· Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¯Ø§Ø±ÛŒÙ… Ùˆ Ù…Ù†Ø·Ù‚ÛŒ Ù‡Ø³ØªÙ†Ø¯
        const payload = {
          order_no: genOrderNo(),
          customer_phone: loginState.phone09,
          customer_name: cn,
          device_model: dm,
          issue: issue,
          pickup_address: addr,
          pickup_time_text: pt || null,
          delivery_method: "courier",
          needs_issue_photo: false,
          stage: "requested",
          quoted_price_toman: 0,
          price_approved: false
        };

        // Ø§Ú¯Ø± Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø³ØªÙˆÙ†ÛŒ Ù…Ø«Ù„ alt_phone Ø¯Ø§Ø´ØªÛŒØ¯ØŒ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…Ø› ÙØ¹Ù„Ø§Ù‹ Ø­Ø°Ù Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø®Ø·Ø§ Ù†Ø¯Ù‡.
        // (Ú†ÙˆÙ† Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÛŒÙ… Ø¬Ø¯ÙˆÙ„ Ø´Ù…Ø§ alt_phone Ø¯Ø§Ø±Ø¯ ÛŒØ§ Ù†Ù‡)

        try{
          const { data, error } = await supabase
            .from("orders")
            .insert(payload)
            .select("*")
            .single();

          if(error){
            console.error("Insert error:", error);
            setMsg(orderMsg, "err", "Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (error.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
            return;
          }

          setMsg(orderMsg, "ok", "Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯ âœ…");

          // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† ÙØ±Ù…
          deviceModel.value = "";
          if(replacementPhone) replacementPhone.checked = false;
          problemDesc.value = "";
          address.value = "";
          pickupTime.value = "";
          altPhone.value = "";
          localStorage.removeItem(LS_DRAFT);

          await loadOrders();
          showTab("myorders");
        }catch(e){
          console.error("Create order exception:", e);
          setMsg(orderMsg, "err", "Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: " + (e?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
        }finally{
          createOrderBtn.disabled = false;
        }
      }

      // =========================
      // Load orders
      // =========================
      function pickDashboardMessage(o){
        // (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 7) Ù¾ÛŒØ§Ù… Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯/Ø§Ø¯Ù…ÛŒÙ† Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        // Ø§ÛŒÙ†Ø¬Ø§ Ú†Ù†Ø¯ Ù†Ø§Ù… Ø±Ø§ÛŒØ¬ Ø±Ø§ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…Ø› Ø§Ú¯Ø± Ø¬Ø¯ÙˆÙ„ Ø´Ù…Ø§ ÛŒÚ©ÛŒ Ø§Ø² Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        return o.status_note ?? o.stage_note ?? o.dashboard_note ?? o.admin_note ?? o.note ?? "";
      }

      async function loadOrders(){
        if(!loggedIn()){
          ordersCount.textContent = "0";
          return;
        }

        ordersWrap.innerHTML = '<div class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§â€¦</div>';

        const { data, error } = await supabase
          .from("orders")
          .select("*")
          .eq("customer_phone", loginState.phone09)
          .order("created_at", { ascending:false });

        if(error){
          console.error("Load orders error:", error);
          ordersWrap.innerHTML = `
            <div class="status err">Ø®ÙˆØ§Ù†Ø¯Ù† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</div>
            <div class="hint" style="color:var(--danger)">${esc(error.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ")}</div>
          `;
          ordersCount.textContent = "0";
          return;
        }

        const list = data || [];
        ordersCount.textContent = String(list.length);

        if(list.length === 0){
          ordersWrap.innerHTML = '<div class="muted">Ù‡Ù†ÙˆØ² Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</div>';
          return;
        }

        ordersWrap.innerHTML = list.map(o => {
          const id = o.order_no ?? o.id ?? "";
          const created = o.created_at ? fmtDate(o.created_at) : "";
          const st = o.stage ?? o.status ?? o.state ?? "requested";
          const dm = o.device_model ?? o.model ?? "";
          const pr = o.issue ?? o.problem ?? "";
          const ad = o.pickup_address ?? o.address ?? "";
          const pt = o.pickup_time_text ?? o.pickup_time ?? "";
          const msg = (pickDashboardMessage(o) || "").toString().trim();

          // Ø§Ú¯Ø± Ù‚ÛŒÙ…Øª Ø§Ø¹Ù„Ø§Ù… Ø´Ø¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ø®ØªØµØ±
          const quoted = Number(o.quoted_price_toman ?? 0);
          const hasQuote = Number.isFinite(quoted) && quoted > 0;

          return `
            <div class="order-item" data-order="${esc(id)}">
              <div class="order-top">
                <b>Ø³ÙØ§Ø±Ø´ #${esc(id)}</b>
                <span class="pill">ÙˆØ¶Ø¹ÛŒØª: ${esc(statusLabel(st))}</span>
              </div>

              <div class="muted">
                <b>Ù…Ø¯Ù„:</b> ${esc(dm)}<br>
                <b>Ù…Ø´Ú©Ù„:</b> ${esc(pr)}<br>
                <b>Ø¢Ø¯Ø±Ø³:</b> ${esc(ad)}
                ${pt ? `<br><b>Ø²Ù…Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª:</b> ${esc(pt)}` : ""}
                ${created ? `<br><b>Ø«Ø¨Øª:</b> ${esc(created)}` : ""}
                ${hasQuote ? `<br><b>Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡:</b> ${esc(quoted.toLocaleString("fa-IR"))} ØªÙˆÙ…Ø§Ù†` : ""}
                ${msg ? `<br><b>Ù¾ÛŒØ§Ù… Ù…ÙˆØ¨ÛŒÚ©Ø³:</b> ${esc(msg)}` : ""}
              </div>

              ${renderTrack(st)}

              <!-- Chat UI (ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· UIØ› ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯) -->
              <div class="chatbox">
                <div class="chat-head">
                  <b style="font-weight:900">Ú†Øª Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´</b>
                  <span class="status warn">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</span>
                </div>
                <div class="chat-messages">
                  <div class="bubble them">Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ú†ØªØŒ Ø¨Ø§ÛŒØ¯ Ø¬Ø¯ÙˆÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± Supabase Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯.</div>
                  <div class="bubble me">Ø¨Ø¹Ø¯ Ø§Ø² Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
                </div>
                <div class="chat-send">
                  <input class="input" disabled placeholder="ÙØ¹Ù„Ø§Ù‹ ØºÛŒØ±ÙØ¹Ø§Ù„ (Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)" />
                  <button class="btn primary" disabled type="button">Ø§Ø±Ø³Ø§Ù„</button>
                </div>
                <div class="small-note">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯: Ú†Øª Ø±Ø§ ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù…ØªØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ú¯ØŒ Ø¨Ø§ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§).</div>
              </div>
            </div>
          `;
        }).join("");
      }

      // =========================
      // Init storage
      // =========================
      try{
        const raw = localStorage.getItem(LS_LOGIN);
        loginState = raw ? JSON.parse(raw) : null;
      }catch(_e){ loginState = null; }

      try{
        const rawP = localStorage.getItem(LS_PROFILE);
        profile = rawP ? JSON.parse(rawP) : null;
      }catch(_e){ profile = null; }

      // =========================
      // Events
      // =========================
      sendOtpBtn.addEventListener("click", sendOtp);
      verifyOtpBtn.addEventListener("click", verifyOtp);
      resendBtn.addEventListener("click", resend);
      saveNameBtn.addEventListener("click", saveProfileName);

      headerLogoutBtn.addEventListener("click", logout);

      createOrderBtn.addEventListener("click", createOrder);
      refreshOrdersBtn.addEventListener("click", loadOrders);

      headerOrderBtn.addEventListener("click", () => showTab("order"));
      headerMyOrdersBtn.addEventListener("click", () => showTab("myorders"));
      tabOrder.addEventListener("click", () => showTab("order"));
      tabMyOrders.addEventListener("click", () => showTab("myorders"));
      goMyOrdersBtn.addEventListener("click", () => showTab("myorders"));

      // Quick issue chips -> append
      document.querySelectorAll(".qchip").forEach(btn => {
        btn.addEventListener("click", () => {
          const val = (btn.getAttribute("data-issue") || "").trim();
          if(!val) return;
          const cur = (problemDesc.value || "").trim();
          const next = cur ? (cur + (cur.endsWith("ØŒ") || cur.endsWith(",") ? " " : "ØŒ ") + val) : val;
          problemDesc.value = next;
          problemDesc.focus();
          saveDraft();
        });
      });

      // Save draft on input changes
      [customerName, deviceModel, problemDesc, address, pickupTime, altPhone, replacementPhone].forEach(el => {
        if(!el) return;
        el.addEventListener("input", () => saveDraft());
        el.addEventListener("change", () => saveDraft());
      });

      // Pre-fill name in form if profile exists
      if(profile && profile.full_name && !customerName.value){
        customerName.value = profile.full_name;
      }

      // Apply initial UI
      applyLoginUI();
      loadDraft();

      if(loggedIn()){
        loadOrders();
      }
    })();
  </script>
</body>
</html>
