<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobix | ثبت سفارش و پیگیری</title>

  <meta name="description" content="موبیکس؛ ثبت سفارش تعمیر موبایل، پیگیری مرحله‌ای، اعلام قیمت و تأیید دو مرحله‌ای." />
  <meta name="theme-color" content="#1F6AFF" />
  <link rel="icon" href="../assets/logo.png" />

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://fastly.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://fastly.jsdelivr.net">

  <style>
    @font-face {
      font-family: 'Peyda';
      src: url('https://cdn.jsdelivr.net/gh/MHgh0st/Assets@main/fonts/Peyda/PeydaWeb-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Peyda';
      src: url('https://cdn.jsdelivr.net/gh/MHgh0st/Assets@main/fonts/Peyda/PeydaWeb-Bold.woff2') format('woff2');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Peyda';
      src: url('https://cdn.jsdelivr.net/gh/MHgh0st/Assets@main/fonts/Peyda/PeydaWeb-Black.woff2') format('woff2');
      font-weight: 900;
      font-style: normal;
      font-display: swap;
    }
  </style>

  <style>
    :root{
      --bg:#F6F8FC;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#5B6B84;
      --line:rgba(15,23,42,.08);

      --shadow: 0 14px 36px rgba(15,23,42,.10);
      --shadow2: 0 8px 18px rgba(15,23,42,.08);
      --shadow3: 0 10px 24px rgba(15,23,42,.07);

      --radius:20px;

      --primary:#1F6AFF;
      --primary2:#3B82F6;
      --success:#10B981;
      --danger:#EF4444;
      --warn:#F59E0B;

      --max:1160px;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:"Peyda", system-ui, sans-serif;
      background:
        radial-gradient(1000px 500px at 80% -10%, rgba(31,106,255,.16), transparent 55%),
        radial-gradient(900px 600px at 20% 10%, rgba(59,130,246,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{text-decoration:none;color:inherit}
    img{max-width:100%;display:block}

    .container{
      max-width:var(--max);
      margin:auto;
      padding:14px 16px 56px;
    }

    .topbar{
      position:sticky;top:0;z-index:50;
      padding:10px 0;
      backdrop-filter: blur(12px);
    }
    .topbar-inner{
      display:flex;align-items:center;justify-content:space-between;
      background:rgba(246,248,252,.86);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      gap:10px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{width:72px;height:auto}
    .brand-title{
      display:flex;flex-direction:column;gap:2px;min-width:0
    }
    .brand-title b{
      font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .brand-title span{
      font-weight:700;font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }

    .nav{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      padding:10px 16px;
      border-radius:14px;
      font-weight:700;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-family:inherit;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;
      border:none;
      font-weight:700;
    }
    .btn.ghost{
      background:rgba(255,255,255,.72);
    }
    .btn.danger{
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      color:#7F1D1D;
    }
    .btn.warn{
      background:rgba(245,158,11,.12);
      border:1px solid rgba(245,158,11,.28);
      color:#78350F;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .hero{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:980px){.hero{grid-template-columns:1fr}}

    h1{
      font-size:38px;
      font-weight:900;
      margin:0 0 6px;
      letter-spacing:-.3px;
      line-height:1.25;
    }
    @media(max-width:520px){h1{font-size:30px}}

    .sub{
      color:var(--muted);
      font-size:15px;
      line-height:1.9;
      margin:0;
    }

    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:900;
      font-size:12.8px;
      white-space:nowrap;
    }
    .status.ok{border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.08);color:#0B3A2C}
    .status.err{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:#7F1D1D}
    .status.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:#78350F}

    .divider{height:1px;background:var(--line);margin:12px 0}

    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media(max-width:980px){.grid-2{grid-template-columns:1fr}}

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
    }
    .label{
      font-size:13px;
      font-weight:900;
      color:var(--muted);
    }
    .input{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:700;
      outline:none;
    }
    .textarea{
      width:100%;
      min-height:110px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      font-family:inherit;
      font-weight:700;
      outline:none;
      resize:vertical;
      line-height:1.9;
    }
    .formrow{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
    }
    @media(max-width:520px){.formrow{grid-template-columns:1fr}}

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.75;
      white-space:pre-line;
    }

    .otp-box{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      box-shadow:var(--shadow2);
    }
    .timerbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-top:8px;
    }

    .checkrow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      box-shadow:var(--shadow2);
      margin-top:10px;
    }
    .checkrow input{
      margin-top:2px;
      width:18px;height:18px;
      accent-color: var(--primary);
      flex:0 0 auto;
    }
    .checkrow b{
      font-weight:900;
      font-size:13.5px;
      display:block;
      margin-bottom:2px;
    }
    .checkrow span{
      color:var(--muted);
      font-size:12.8px;
      line-height:1.7;
      display:block;
    }

    .quick-issues{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .qchip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.72);
      font-weight:900;
      font-size:12.8px;
      cursor:pointer;
      box-shadow:var(--shadow2);
      user-select:none;
    }

    .pick-wrap{
      margin-top:8px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      font-weight:900;
      font-size:12.8px;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(15,23,42,.04);
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip.on{
      background:rgba(31,106,255,.10);
      border-color:rgba(31,106,255,.25);
      color:#0B2A6A;
    }
    .chip.subtle{
      background:rgba(255,255,255,.72);
    }
    .pick-other{
      display:none;
    }

    .replacement-note{
      margin-top:8px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(245,158,11,.25);
      background:rgba(245,158,11,.10);
      color:#78350F;
      font-weight:900;
      line-height:1.8;
    }

    .orders{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .order-item{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .order-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .order-top b{font-weight:900}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(31,106,255,.10);
      border:1px solid rgba(31,106,255,.18);
      color:#0B2A6A;
      font-weight:900;
      font-size:12.5px;
      white-space:nowrap;
    }
    .pill.warn{
      background:rgba(245,158,11,.10);
      border-color:rgba(245,158,11,.22);
      color:#78350F;
    }
    .pill.ok{
      background:rgba(16,185,129,.08);
      border-color:rgba(16,185,129,.22);
      color:#0B3A2C;
    }
    .pill.err{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.22);
      color:#7F1D1D;
    }

    .muted{color:var(--muted);font-size:13.2px;line-height:1.9}

    .track{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      margin-top:4px;
    }
    .track-step{
      display:flex;
      align-items:flex-start;
      gap:10px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:16px;
      padding:10px;
    }
    .track-bullet{
      width:28px;height:28px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }
    .track-step.done .track-bullet{
      background:rgba(16,185,129,.10);
      border-color:rgba(16,185,129,.25);
      color:#0B3A2C;
    }
    .track-step.active .track-bullet{
      background:rgba(31,106,255,.10);
      border-color:rgba(31,106,255,.25);
      color:#0B2A6A;
    }
    .track-step .tt b{display:block;font-weight:900}
    .track-step .tt span{display:block;color:var(--muted);font-size:13px;line-height:1.85;margin-top:3px}

    .price-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
      margin-top:10px;
    }

    .dash-note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,106,255,.18);
      background:rgba(31,106,255,.06);
      color:#0B2A6A;
      box-shadow:var(--shadow2);
      line-height:1.9;
      font-weight:700;
      font-size:13px;
      white-space:pre-line;
    }
    .dash-note .dash-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .dash-note .dash-title b{
      font-weight:900;
      font-size:13.2px;
    }
    .dash-note .dash-time{
      font-weight:900;
      font-size:12px;
      color:rgba(11,42,106,.78);
      background:rgba(255,255,255,.7);
      border:1px solid rgba(31,106,255,.18);
      padding:6px 8px;
      border-radius:999px;
    }

    details.chat-details{
      margin-top:10px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:18px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
    }
    details.chat-details > summary{
      cursor:pointer;
      font-weight:900;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.chat-details > summary::-webkit-details-marker{display:none}
    .chat-wrap{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chat-messages{
      max-height:260px;
      overflow:auto;
      padding:10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chat-msg{
      display:flex;
      flex-direction:column;
      gap:4px;
      max-width:90%;
    }
    .chat-msg .bubble{
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.72);
      line-height:1.85;
      font-weight:700;
      font-size:13.2px;
      white-space:pre-line;
      word-break:break-word;
    }
    .chat-msg .meta{
      font-size:11.5px;
      color:var(--muted);
      font-weight:700;
    }
    .chat-msg.me{
      align-self:flex-end;
      text-align:right;
    }
    .chat-msg.me .bubble{
      background:rgba(31,106,255,.10);
      border-color:rgba(31,106,255,.20);
      color:#0B2A6A;
    }
    .chat-msg.other{
      align-self:flex-start;
      text-align:right;
    }
    .chat-input-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    @media(max-width:520px){
      .chat-input-row{grid-template-columns:1fr}
    }

    .review-box{
      margin-top:10px;
      border:1px solid rgba(16,185,129,.22);
      background:rgba(16,185,129,.06);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
    }
    .review-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .review-top b{
      font-weight:900;
      font-size:13.6px;
      color:#0B3A2C;
    }
    .stars{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    .star-btn{
      width:36px;
      height:36px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      box-shadow:0 10px 18px rgba(15,23,42,.04);
      cursor:pointer;
      font-weight:900;
      font-size:18px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(11,18,32,.45);
      user-select:none;
    }
    .star-btn.on{
      color:var(--primary);
      border-color:rgba(31,106,255,.25);
      background:rgba(31,106,255,.06);
    }
    .review-options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:520px){
      .review-options{grid-template-columns:1fr}
    }
    .review-options .checkrow{
      margin-top:0;
      background:rgba(255,255,255,.78);
    }
    .review-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .review-msg{
      margin-top:8px;
      font-size:12.8px;
      font-weight:700;
      color:var(--muted);
      white-space:pre-line;
    }
    .review-done{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(16,185,129,.22);
      background:rgba(16,185,129,.06);
      color:#0B3A2C;
      font-weight:900;
      line-height:1.9;
      box-shadow:var(--shadow2);
    }
    .review-stars-static{
      display:inline-flex;
      gap:4px;
      align-items:center;
      font-size:15px;
      color:var(--primary);
      margin-right:6px;
    }
    .review-stars-static span.off{
      color:rgba(11,18,32,.28);
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(11,18,32,.45);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(640px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: 0 22px 60px rgba(15,23,42,.22);
      padding:16px;
    }
    .modal h2{
      margin:0;
      font-size:18px;
      font-weight:900;
      line-height:1.6;
    }
    .modal .modal-sub{
      margin:6px 0 0;
      color:var(--muted);
      line-height:1.9;
      font-size:13.5px;
    }
    .modal .modal-box{
      margin-top:12px;
      border:1px solid var(--line);
      background:rgba(246,248,252,.55);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
    }
    .modal .modal-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .modal .modal-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .modal .close-x{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      box-shadow:var(--shadow2);
    }

    footer{margin-top:22px}

    .footer-card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.08);
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .footer-card:before{
      content:"";
      position:absolute;
      inset:-140px -140px auto auto;
      width:280px;height:280px;border-radius:999px;
      background:rgba(31,106,255,.06);
      transform:rotate(12deg);
      pointer-events:none;
    }

    .footer-grid{
      display:grid;
      grid-template-columns: 1.25fr .9fr 1.25fr;
      gap:16px;
      align-items:start;
      position:relative;
    }
    @media(max-width:980px){.footer-grid{grid-template-columns:1fr}}

    .f-title{
      font-weight:900;
      letter-spacing:-.2px;
      margin:0;
      font-size:15px;
    }
    .f-muted{color:var(--muted);font-size:13.4px;line-height:1.9;margin-top:8px}

    .f-links{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .f-links a{
      color:var(--text);
      font-weight:700;
      font-size:13.6px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.08);
      background:rgba(246,248,252,.55);
      box-shadow:0 10px 18px rgba(15,23,42,.04);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .f-links a:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 30px rgba(15,23,42,.08);
    }

    .f-stack{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .fk{
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      background:#fff;
      box-shadow:0 10px 18px rgba(15,23,42,.05);
      padding:12px;
    }
    .fk b{display:block;font-weight:900;font-size:13px}
    .fk span{display:block;color:var(--muted);font-size:12.8px;line-height:1.7;margin-top:6px}

    .enamad-wrap{
      margin-top:10px;
      display:flex;
      align-items:flex-end;
      justify-content:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .enamad img{
      width:96px;
      height:auto;
      cursor:pointer;
      display:block;
      opacity:.95;
      filter:saturate(.96);
    }
    .bitpay img{
      width:96px;
      height:auto;
      cursor:pointer;
      display:block;
      opacity:.95;
      filter:saturate(.96);
    }

    .footer-bottom{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid rgba(15,23,42,.08);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12.8px;
      position:relative;
    }

    /* ✅ بنر وضعیت پرداخت */
    .pay-banner{
      margin-top:12px;
      border-radius:22px;
      border:1px solid rgba(16,185,129,.22);
      background:rgba(16,185,129,.10);
      box-shadow:var(--shadow2);
      padding:14px 16px;
      display:none;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .pay-banner.err{
      border-color:rgba(239,68,68,.22);
      background:rgba(239,68,68,.10);
    }
    .pay-banner .bb{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .pay-banner .bb b{
      font-weight:900;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pay-banner .bb span{
      font-weight:700;
      color:rgba(11,18,32,.72);
      font-size:13px;
      line-height:1.8;
      white-space:pre-line;
    }
    .pay-banner .close-x2{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      box-shadow:var(--shadow2);
      flex:0 0 auto;
    }

    @media (max-width: 520px){
      .topbar-inner{border-radius:22px;padding:10px 10px}
      .brand img{width:60px}
      h1{font-size:28px}
      .card{padding:14px}
      .container{padding-bottom:40px}
      .footer-card{padding:14px}
      .enamad img{width:92px}
      .bitpay img{width:92px}
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="../">
          <img src="../assets/logo.png" alt="Mobix">
          <div class="brand-title">
            <b>موبیکس</b>
            <span>سرویس تخصصی تعمیر موبایل</span>
          </div>
        </a>

        <div class="nav">
          <a class="btn primary" href="./" id="navOrderBtn">ثبت سفارش</a>
          <button class="btn danger" type="button" id="navLogoutBtn" style="display:none">خروج</button>
        </div>
      </div>
    </div>

    <!-- ✅ بنر پرداخت در همان صفحه /order/ -->
    <div id="payBanner" class="pay-banner" role="status" aria-live="polite">
      <div class="bb">
        <b id="payBannerTitle">پرداخت</b>
        <span id="payBannerText"></span>
      </div>
      <button id="payBannerClose" class="close-x2" type="button">بستن</button>
    </div>

    <section class="hero">
      <div class="card">
        <h1>ورود، ثبت سفارش و پیگیری</h1>
        <p class="sub">با کد پیامکی وارد شوید و وضعیت سفارش را مرحله‌به‌مرحله ببینید.</p>
        <div class="divider"></div>
        <div id="sessionBadge" class="status warn">وارد نشده‌اید</div>
      </div>

      <div class="card" id="guideCard">
        <h1 style="font-size:22px;margin:0 0 6px;font-weight:900">راهنما</h1>
        <p class="sub" style="margin-top:6px">
          ورود با کد پیامکی، ثبت درخواست، پیگیری مرحله‌ای، اعلام قیمت و تأیید دو مرحله‌ای.
        </p>
        <div class="divider"></div>
        <div class="muted">
          • بعد از ورود، نام شما یک‌بار ثبت می‌شود و برای سفارش‌های بعدی نیاز نیست دوباره وارد کنید.<br>
          • هر زمان قیمت اعلام شود، داخل همین صفحه در سفارش‌های شما نمایش داده می‌شود.<br>
          • بعد از اعلام قیمت، تایید/رد قیمت همینجا انجام می‌شود (دو مرحله‌ای).<br>
          • پیام/توضیحی که اپراتور در داشبورد ثبت می‌کند، کنار وضعیت نمایش داده می‌شود.<br>
          • امکان چت درباره هر سفارش فعال است.<br>
          • بعد از تایید قیمت، دکمه «پرداخت» فعال می‌شود.
        </div>
      </div>
    </section>

    <div class="grid-2">

      <div class="card" id="authCard">
        <h1 style="font-size:20px;margin:0 0 6px;font-weight:900">ورود با کد پیامکی</h1>
        <p class="sub" style="font-size:14.5px">کد یکبار مصرف ارسال می‌شود.</p>

        <div class="field">
          <div class="label">شماره موبایل</div>
          <input id="authPhone" class="input" inputmode="numeric" placeholder="مثلاً 0912xxxxxxx" />
        </div>

        <div class="checkrow">
          <input id="termsAccepted" type="checkbox" />
          <div>
            <b>قوانین موبیکس پذیرفته می‌شود</b>
            <span>با ارسال کد، قوانین و شرایط سرویس موبیکس را می‌پذیرید.</span>
          </div>
        </div>

        <div class="formrow">
          <button id="sendOtpBtn" class="btn primary" type="button">ارسال کد</button>
          <button id="logoutBtn" class="btn danger" type="button" style="display:none">خروج</button>
        </div>

        <div id="otpWrap" class="otp-box" style="display:none">
          <div class="field" style="margin-top:0">
            <div class="label">کد پیامکی</div>
            <input id="authCode" class="input" inputmode="numeric" placeholder="کد ۶ رقمی" />
          </div>

          <div class="timerbar">
            <div id="timerPill" class="status warn">02:00</div>
            <button id="resendBtn" class="btn ghost" type="button" disabled>ارسال مجدد</button>
          </div>

          <div class="formrow">
            <button id="verifyOtpBtn" class="btn primary" type="button">تایید و ورود</button>
            <span class="status" id="otpHint" style="justify-self:start">پس از ورود، نام شما پرسیده می‌شود</span>
          </div>
        </div>

        <div id="authMsg" class="hint" aria-live="polite"></div>
      </div>

      <div class="card" id="mainCard">
        <div class="order-top">
          <h1 style="font-size:20px;margin:0;font-weight:900">ثبت سفارش</h1>
          <div id="helloBadge" class="status" style="display:none"></div>
        </div>
        <p class="sub" style="margin-top:6px">بعد از ورود، سفارش ثبت کنید و سفارش‌های قبلی را ببینید.</p>

        <div class="divider"></div>

        <div id="profileCard" style="display:none">
          <div class="order-top">
            <b style="font-weight:900">تکمیل مشخصات</b>
            <span class="status warn">یک‌بار برای همیشه</span>
          </div>

          <div class="field">
            <div class="label">نام و نام خانوادگی</div>
            <input id="fullName" class="input" placeholder="نام و نام خانوادگی" value="" />
          </div>

          <div class="formrow">
            <button id="saveProfileBtn" class="btn primary" type="button">ذخیره</button>
            <span class="status" id="profileMsg" style="display:none"></span>
          </div>

          <div class="divider"></div>
        </div>

        <div id="orderFormWrap">
          <div class="order-top">
            <b style="font-weight:900">اطلاعات سفارش</b>
            <span id="orderGate" class="status warn">برای ارسال نهایی باید وارد شوید</span>
          </div>

          <div class="field">
            <div class="label">مدل گوشی</div>
            <input id="deviceModel" class="input" placeholder="مثلاً iPhone 13 / Galaxy A52" />
          </div>

          <div class="checkrow" aria-label="گوشی جایگزین">
            <input id="replacementPhone" type="checkbox" />
            <div>
              <b>نیاز به گوشی جایگزین دارم</b>
              <span>اگر در زمان تعمیر نیاز دارید، این گزینه را فعال کنید.</span>
            </div>
          </div>

          <div class="field">
            <div class="label">مشکل دستگاه</div>
            <textarea id="problemDesc" class="textarea" placeholder="مثلاً شکستگی ال‌سی‌دی / مشکل شارژ / خاموشی ..."></textarea>
            <div class="quick-issues" aria-label="مشکلات رایج">
              <div class="qchip" data-issue="شکستگی/خط روی ال‌سی‌دی">شکستگی LCD</div>
              <div class="qchip" data-issue="مشکل شارژ/سوکت شارژ">مشکل شارژ</div>
              <div class="qchip" data-issue="باتری ضعیف/زود خالی می‌کند">باتری</div>
              <div class="qchip" data-issue="آب‌خوردگی">آب‌خوردگی</div>
              <div class="qchip" data-issue="خاموشی/ریست شدن">خاموشی/ریست</div>
              <div class="qchip" data-issue="مشکل صدا/میکروفن">صدا/میکروفن</div>
            </div>
          </div>

          <div class="field">
            <div class="label">آدرس برای دریافت با پیک</div>
            <textarea id="address" class="textarea" placeholder="آدرس دقیق + پلاک + واحد"></textarea>
          </div>

          <div class="field">
            <div class="label">زمان پیشنهادی برای دریافت</div>

            <div class="pick-wrap" aria-label="انتخاب زمان دریافت">
              <div class="label" style="margin-top:0">روز</div>
              <div class="seg" role="group" aria-label="انتخاب روز">
                <button type="button" class="chip" id="pickDayToday" data-pick-day="today">امروز</button>
                <button type="button" class="chip" id="pickDayTomorrow" data-pick-day="tomorrow">فردا</button>
                <button type="button" class="chip subtle" id="pickDayOther" data-pick-day="other">زمان دیگر</button>
              </div>

              <div id="pickSlotsWrap">
                <div class="label" style="margin-top:0">بازه</div>
                <div class="seg" role="group" aria-label="انتخاب بازه">
                  <button type="button" class="chip" data-pick-slot="9-12">۹–۱۲</button>
                  <button type="button" class="chip" data-pick-slot="12-15">۱۲–۱۵</button>
                  <button type="button" class="chip" data-pick-slot="15-18">۱۵–۱۸</button>
                  <button type="button" class="chip" data-pick-slot="18-21">۱۸–۲۱</button>
                </div>
              </div>

              <div class="field pick-other" id="pickOtherWrap" style="margin-top:0">
                <div class="label">زمان دیگر (اختیاری)</div>
                <input id="pickupTimeOther" class="input" placeholder="مثلاً پس‌فردا ساعت ۱۱" />
              </div>

              <input id="pickupTime" class="input" style="display:none" />
              <div class="hint" id="pickupTimePreview" style="margin-top:0"></div>
            </div>
          </div>

          <div class="formrow">
            <button id="createOrderBtn" class="btn primary" type="button">ثبت سفارش</button>
            <button id="refreshOrdersBtn" class="btn ghost" type="button">به‌روزرسانی</button>
          </div>

          <div id="orderMsg" class="hint" aria-live="polite"></div>

          <div class="divider"></div>
        </div>

        <div class="order-top">
          <b style="font-weight:900">سفارش‌های من</b>
          <span id="ordersCount" class="status">0</span>
        </div>

        <div id="ordersWrap" class="orders">
          <div class="muted">بعد از ورود، سفارش‌های شما اینجا نمایش داده می‌شود.</div>
        </div>

      </div>
    </div>

    <footer aria-label="Footer">
      <div class="footer-card">
        <div class="footer-grid">

          <div>
            <div style="display:flex;align-items:center;gap:10px">
              <img src="../assets/logo.png" alt="موبیکس" style="width:58px;height:auto">
              <div>
                <div class="f-title">موبیکس</div>
                <div class="f-muted" style="margin-top:4px">سرویس تخصصی تعمیر موبایل</div>
              </div>
            </div>

            <div class="f-stack" aria-label="Footer highlights">
              <div class="fk">
                <b>قیمت قبل از اقدام</b>
                <span>قبل از هر تعمیر، هزینه با شما هماهنگ می‌شود.</span>
              </div>

              <div class="fk">
                <b>پیگیری مرحله‌ای</b>
                <span>وضعیت سفارش همیشه شفاف و قابل پیگیری است.</span>
              </div>

              <div class="fk">
                <b>پیک موبیکس</b>
                <span>زمان و مکان دریافت/تحویل را شما تعیین می‌کنید.</span>
              </div>
            </div>
          </div>

          <div>
            <div class="f-title">دسترسی سریع</div>
            <div class="f-links" aria-label="Footer links">
              <a href="../contact/">تماس با ما</a>
              <a href="../order/">ثبت سفارش</a>
              <a href="../support/">پشتیبانی</a>
              <a href="../terms/">قوانین و شرایط</a>
              <a href="../privacy/">حریم خصوصی</a>
            </div>
          </div>

          <div>
            <div class="f-title">اعتماد و مجوزها</div>
            <div class="f-muted">اطلاعات و مجوزها برای اطمینان شما.</div>

            <div class="enamad-wrap" aria-label="اینماد و بیت‌پی">
              <div class="enamad">
                <a referrerpolicy='origin' target='_blank' href='https://trustseal.enamad.ir/?id=5414923&Code=DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf'>
                  <img referrerpolicy='origin' src='https://trustseal.enamad.ir/logo.aspx?id=5414923&Code=DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf' alt='' style='cursor:pointer' code='DiznrIm0BJGpnPrtdWijxsgtOlPs8Aqf'>
                </a>
              </div>

              <div class="bitpay">
                <a href="https://bitpay.ir/certificate-579080-mobixfix.ir" target="_blank"><img src="https://bitpay.ir/theme/public/images/trusted-logo.svg"/></a>
              </div>
            </div>
          </div>

        </div>

        <div class="footer-bottom">
          <span>© Mobix — همه حقوق محفوظ است</span>
          <span>سریع • شفاف • قابل پیگیری</span>
        </div>
      </div>
    </footer>

  </div>

  <div class="modal-backdrop" id="priceModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="priceModalTitle">
      <div class="order-top">
        <h2 id="priceModalTitle">تایید قیمت (مرحله ۲)</h2>
        <button class="close-x" type="button" id="priceModalClose">بستن</button>
      </div>
      <p class="modal-sub" id="priceModalSub">
        قبل از تایید نهایی، قیمت و جزئیات را یک‌بار دیگر بررسی کنید.
      </p>

      <div class="modal-box">
        <div class="modal-row">
          <span class="status" id="priceModalOrderNo">سفارش: -</span>
          <span class="status ok" id="priceModalPrice">-</span>
        </div>
        <div class="divider"></div>
        <div class="muted" id="priceModalHint">
          • با تایید نهایی، دکمه «پرداخت» برای این سفارش فعال می‌شود.<br>
          • اگر قیمت را نمی‌پذیرید، «رد قیمت» را بزنید.
        </div>

        <div class="checkrow" style="margin-top:12px">
          <input id="priceFinalCheck" type="checkbox" />
          <div>
            <b>تایید می‌کنم</b>
            <span>قیمت اعلام‌شده را بررسی کردم و تایید می‌کنم.</span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn primary" id="priceFinalApproveBtn" type="button" disabled>تایید نهایی</button>
        <button class="btn danger" id="priceFinalRejectBtn" type="button">رد قیمت</button>
        <button class="btn ghost" id="priceModalCancel" type="button">انصراف</button>
      </div>

      <div class="hint" id="priceModalMsg" aria-live="polite"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>

  <script>
    (function(){
      const SUPABASE_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyeGZoZmtubXhtZWF0bmZ6cGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTg2MjksImV4cCI6MjA4MTgzNDYyOX0.iANOG9-g9GnVl58KDYI0A-oYNwfbL3oh2NBddZ2sLLs";

      const OTP_REQUEST_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/request-otp";
      const OTP_VERIFY_URL  = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/verify-otp";

      // ✅ بیت‌پی (Edge Function)
      const BITPAY_CREATE_URL = "https://vrxfhfknmxmeatnfzpcg.supabase.co/functions/v1/bitpay-create-payment";

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function normalizeDigits(s){
        return (s || "")
          .replace(/[۰-۹]/g, d => "۰۱۲۳۴۵۶۷۸۹".indexOf(d))
          .replace(/[^\d]/g, "");
      }
      function isValidIranMobile(d){
        if(!d) return false;
        if(d.length === 11 && d.startsWith("09")) return true;
        if(d.length === 10 && d.startsWith("9")) return true;
        return false;
      }
      function to09(d){
        if(!d) return null;
        if(d.length === 11 && d.startsWith("09")) return d;
        if(d.length === 10 && d.startsWith("9")) return "0" + d;
        return null;
      }
      function fmtDate(iso){
        try{
          const dt = new Date(iso);
          if(isNaN(dt.getTime())) return iso || "";
          return dt.toLocaleString("fa-IR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        }catch(e){ return iso || ""; }
      }
      function esc(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      async function safeJson(res){
        try{ return await res.json(); }catch(e){ return null; }
      }
      function extractErrorMessage(obj){
        if(!obj) return null;
        if(typeof obj === "string") return obj;
        return obj.message || obj.error || (obj.errors && obj.errors[0] && (obj.errors[0].message || obj.errors[0])) || null;
      }
      function formatToman(n){
        const x = Number(n || 0);
        if(!Number.isFinite(x) || x <= 0) return null;
        return x.toLocaleString("fa-IR") + " تومان";
      }

      function genOrderNo(){
        const d = new Date();
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const rand = String(Math.floor(1000 + Math.random()*9000));
        return `MCC-${yy}${mm}${dd}-${rand}`;
      }

      // ✅ آدرس بازگشت از درگاه
      function buildPayReturnUrl(orderNo){
        const base = window.location.origin;
        return base + "/order/pay-result/?order_no=" + encodeURIComponent(orderNo || "");
      }

      const sessionBadge = document.getElementById("sessionBadge");
      const guideCard = document.getElementById("guideCard");

      const authCard = document.getElementById("authCard");
      const authPhone = document.getElementById("authPhone");
      const authCode = document.getElementById("authCode");
      const termsAccepted = document.getElementById("termsAccepted");
      const sendOtpBtn = document.getElementById("sendOtpBtn");
      const verifyOtpBtn = document.getElementById("verifyOtpBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const resendBtn = document.getElementById("resendBtn");
      const otpWrap = document.getElementById("otpWrap");
      const authMsg = document.getElementById("authMsg");
      const timerPill = document.getElementById("timerPill");

      const navLogoutBtn = document.getElementById("navLogoutBtn");

      const profileCard = document.getElementById("profileCard");
      const fullName = document.getElementById("fullName");
      const saveProfileBtn = document.getElementById("saveProfileBtn");
      const profileMsg = document.getElementById("profileMsg");
      const helloBadge = document.getElementById("helloBadge");

      const orderGate = document.getElementById("orderGate");
      const deviceModel = document.getElementById("deviceModel");
      const replacementPhone = document.getElementById("replacementPhone");
      const problemDesc = document.getElementById("problemDesc");
      const address = document.getElementById("address");
      const pickupTime = document.getElementById("pickupTime");
      const pickupTimePreview = document.getElementById("pickupTimePreview");
      const pickSlotsWrap = document.getElementById("pickSlotsWrap");
      const pickOtherWrap = document.getElementById("pickOtherWrap");
      const pickupTimeOther = document.getElementById("pickupTimeOther");
      const createOrderBtn = document.getElementById("createOrderBtn");
      const refreshOrdersBtn = document.getElementById("refreshOrdersBtn");
      const orderMsg = document.getElementById("orderMsg");

      const ordersWrap = document.getElementById("ordersWrap");
      const ordersCount = document.getElementById("ordersCount");

      const priceModalBackdrop = document.getElementById("priceModalBackdrop");
      const priceModalClose = document.getElementById("priceModalClose");
      const priceModalCancel = document.getElementById("priceModalCancel");
      const priceFinalCheck = document.getElementById("priceFinalCheck");
      const priceFinalApproveBtn = document.getElementById("priceFinalApproveBtn");
      const priceFinalRejectBtn = document.getElementById("priceFinalRejectBtn");
      const priceModalOrderNo = document.getElementById("priceModalOrderNo");
      const priceModalPrice = document.getElementById("priceModalPrice");
      const priceModalMsg = document.getElementById("priceModalMsg");

      // ✅ بنر پرداخت
      const payBanner = document.getElementById("payBanner");
      const payBannerTitle = document.getElementById("payBannerTitle");
      const payBannerText = document.getElementById("payBannerText");
      const payBannerClose = document.getElementById("payBannerClose");

      const LS_LOGIN = "mobix_site_login";
      const LS_PROFILE = "mobix_site_profile";
      const DRAFT_KEY = "mobix_site_order_draft";

      const PENDING_PAY_KEY = "mobix_pending_payment_result"; // sessionStorage

      let loginState = null;
      let profileState = null;

      let lastPhone09 = null;
      let timerId = null;
      let remaining = 0;

      let realtimeChannel = null;
      let pollTimer = null;

      let updatesRealtimeChannel = null;
      let chatRealtimeChannel = null;

      let modalOrder = null;

      const lastKnownOrders = new Map();
      const lastKnownUpdates = new Map();
      const lastKnownChats = new Map();
      const lastKnownReviews = new Map();

      let pickupDay = null;
      let pickupSlot = null;

      // ✅ جلوگیری از رندر/رفرش زیاد (debounce + skip duplicate render)
      const LOAD_MIN_GAP_MS = 2500;
      let __loadInFlight = false;
      let __loadPending = false;
      let __lastLoadAt = 0;
      let __lastRenderKey = "";

      function setStatus(el, type, text){
        el.classList.remove("ok","err","warn");
        if(type) el.classList.add(type);
        el.textContent = text;
      }
      function setMsg(el, type, text){
        if(!text){
          el.textContent = "";
          el.style.color = "var(--muted)";
          return;
        }
        if(type === "ok") el.style.color = "var(--success)";
        else if(type === "err") el.style.color = "var(--danger)";
        else if(type === "warn") el.style.color = "var(--warn)";
        else el.style.color = "var(--muted)";
        el.textContent = text;
      }

      function loggedIn(){
        return !!(loginState && loginState.phone09);
      }
      function hasProfileName(){
        const n = (profileState && profileState.full_name) ? String(profileState.full_name).trim() : "";
        return n.length >= 2;
      }

      function showPayBanner(type, title, text){
        if(!payBanner) return;
        payBanner.classList.remove("err");
        if(type === "err") payBanner.classList.add("err");

        if(payBannerTitle) payBannerTitle.textContent = title || "پرداخت";
        if(payBannerText) payBannerText.textContent = text || "";
        payBanner.style.display = "flex";
      }
      function hidePayBanner(){
        if(!payBanner) return;
        payBanner.style.display = "none";
        if(payBannerText) payBannerText.textContent = "";
      }

      function cleanPaymentQueryFromUrl(){
        try{
          const url = new URL(window.location.href);
          let changed = false;
          ["payment_status","order_no","invoice_id","invoice","status","msg","message","trans_id","id_get"].forEach(k => {
            if(url.searchParams.has(k)){
              url.searchParams.delete(k);
              changed = true;
            }
          });
          if(changed){
            const next = url.pathname + (url.search ? url.search : "") + (url.hash ? url.hash : "");
            history.replaceState({}, "", next);
          }
        }catch(_e){}
      }

      async function markOrderPaid(orderNo){
        const on = (orderNo || "").trim();
        if(!on) return { ok:false, error:"شماره سفارش نامعتبر است." };

        if(!loggedIn()){
          return { ok:false, error:"برای ثبت پرداخت باید وارد شوید." };
        }

        try{
          const payload = {
            payment_status: "paid"
          };

          const { error } = await supabase
            .from("orders")
            .update(payload)
            .eq("order_no", on)
            .eq("customer_phone", loginState.phone09);

          if(error){
            return { ok:false, error: error.message || "خطای نامشخص" };
          }

          return { ok:true };
        }catch(e){
          return { ok:false, error: (e?.message || "خطای نامشخص") };
        }
      }

      async function handlePaymentReturnIfAny(){
        let qsStatus = "";
        let qsOrderNo = "";

        try{
          const url = new URL(window.location.href);
          qsStatus = (url.searchParams.get("payment_status") || "").trim().toLowerCase();
          qsOrderNo = (url.searchParams.get("order_no") || "").trim();
        }catch(_e){}

        if(qsStatus || qsOrderNo){
          sessionStorage.setItem(PENDING_PAY_KEY, JSON.stringify({
            payment_status: qsStatus || "",
            order_no: qsOrderNo || ""
          }));
          cleanPaymentQueryFromUrl();
        }

        let pend = null;
        try{
          const raw = sessionStorage.getItem(PENDING_PAY_KEY);
          pend = raw ? JSON.parse(raw) : null;
        }catch(_e){ pend = null; }

        const status = (pend?.payment_status || "").toString().trim().toLowerCase();
        const orderNo = (pend?.order_no || "").toString().trim();

        if(!status && !orderNo){
          return;
        }

        if(status === "success"){
          showPayBanner(
            "ok",
            "پرداخت موفق ✅",
            (orderNo ? ("پرداخت شما با موفقیت انجام شد.\nشماره سفارش: " + orderNo) : "پرداخت شما با موفقیت انجام شد.")
          );

          if(loggedIn() && orderNo){
            const out = await markOrderPaid(orderNo);
            if(out.ok){
              sessionStorage.removeItem(PENDING_PAY_KEY);
              try{ await scheduleLoadOrders({ silent:true, reason:"pay-success" }); }catch(_e){}
            }else{
              // فقط پیام را نشان می‌دهیم
            }
          }

          return;
        }

        if(status === "failed" || status === "error" || status === "cancel" || status === "canceled"){
          showPayBanner(
            "err",
            "پرداخت ناموفق ❌",
            (orderNo ? ("پرداخت ناموفق بود یا لغو شد.\nشماره سفارش: " + orderNo) : "پرداخت ناموفق بود یا لغو شد.")
          );
          sessionStorage.removeItem(PENDING_PAY_KEY);
          return;
        }

        showPayBanner(
          "warn",
          "وضعیت پرداخت",
          (orderNo ? ("وضعیت پرداخت دریافت شد.\nشماره سفارش: " + orderNo) : "وضعیت پرداخت دریافت شد.")
        );
        sessionStorage.removeItem(PENDING_PAY_KEY);
      }

      function faDayLabel(day){
        if(day === "today") return "امروز";
        if(day === "tomorrow") return "فردا";
        return "زمان دیگر";
      }
      function faSlotLabel(slot){
        if(slot === "9-12") return "۹ تا ۱۲";
        if(slot === "12-15") return "۱۲ تا ۱۵";
        if(slot === "15-18") return "۱۵ تا ۱۸";
        if(slot === "18-21") return "۱۸ تا ۲۱";
        return "";
      }
      function clearChipGroup(selector){
        document.querySelectorAll(selector).forEach(el => el.classList.remove("on"));
      }
      function setDay(day){
        pickupDay = day;
        clearChipGroup("[data-pick-day]");
        const btn = document.querySelector(`[data-pick-day="${CSS.escape(day)}"]`);
        if(btn) btn.classList.add("on");

        if(day === "other"){
          if(pickSlotsWrap) pickSlotsWrap.style.display = "none";
          if(pickOtherWrap) pickOtherWrap.style.display = "";
          pickupSlot = null;
          clearChipGroup("[data-pick-slot]");
          if(pickupTimeOther) pickupTimeOther.focus();
        }else{
          if(pickSlotsWrap) pickSlotsWrap.style.display = "";
          if(pickOtherWrap) pickOtherWrap.style.display = "none";
          if(pickupTimeOther) pickupTimeOther.value = "";
        }

        syncPickupTimeText();
      }
      function setSlot(slot){
        pickupSlot = slot;
        clearChipGroup("[data-pick-slot]");
        const btn = document.querySelector(`[data-pick-slot="${CSS.escape(slot)}"]`);
        if(btn) btn.classList.add("on");
        syncPickupTimeText();
      }
      function syncPickupTimeText(){
        let out = "";

        if(pickupDay === "other"){
          const t = (pickupTimeOther?.value || "").trim();
          out = t ? ("زمان دیگر: " + t) : "";
        }else if(pickupDay === "today" || pickupDay === "tomorrow"){
          const dayFa = faDayLabel(pickupDay);
          const slotFa = faSlotLabel(pickupSlot);
          if(dayFa && slotFa){
            out = dayFa + " - " + slotFa;
          }else if(dayFa){
            out = "";
          }
        }

        if(pickupTime) pickupTime.value = out;

        if(pickupTimePreview){
          if(out){
            pickupTimePreview.textContent = "خروجی ذخیره می‌شود: " + out;
            pickupTimePreview.style.color = "var(--muted)";
          }else{
            pickupTimePreview.textContent = "برای سرعت بیشتر، روز و بازه را انتخاب کنید (یا «زمان دیگر»).";
            pickupTimePreview.style.color = "var(--muted)";
          }
        }

        saveDraft();
      }
      function resetPickupUI(){
        pickupDay = null;
        pickupSlot = null;
        clearChipGroup("[data-pick-day]");
        clearChipGroup("[data-pick-slot]");
        if(pickSlotsWrap) pickSlotsWrap.style.display = "";
        if(pickOtherWrap) pickOtherWrap.style.display = "none";
        if(pickupTimeOther) pickupTimeOther.value = "";
        if(pickupTime) pickupTime.value = "";
        if(pickupTimePreview){
          pickupTimePreview.textContent = "برای سرعت بیشتر، روز و بازه را انتخاب کنید (یا «زمان دیگر»).";
          pickupTimePreview.style.color = "var(--muted)";
        }
      }

      function saveDraft(){
        const draft = {
          device_model: (deviceModel.value || "").trim(),
          wants_replacement_phone: !!(replacementPhone && replacementPhone.checked),
          issue: (problemDesc.value || "").trim(),
          pickup_address: (address.value || "").trim(),
          pickup_time_text: (pickupTime.value || "").trim()
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      }

      function loadDraft(){
        try{
          const raw = localStorage.getItem(DRAFT_KEY);
          if(!raw) {
            resetPickupUI();
            return;
          }
          const d = JSON.parse(raw);
          if(d && typeof d === "object"){
            if(d.device_model != null) deviceModel.value = d.device_model;
            if(d.wants_replacement_phone != null && replacementPhone) replacementPhone.checked = !!d.wants_replacement_phone;
            if(d.issue != null) problemDesc.value = d.issue;
            if(d.pickup_address != null) address.value = d.pickup_address;

            if(d.pickup_time_text != null){
              const txt = String(d.pickup_time_text || "").trim();
              if(pickupTime) pickupTime.value = txt;

              if(txt.startsWith("زمان دیگر:")){
                setDay("other");
                const rest = txt.replace(/^زمان دیگر:\s*/,"");
                if(pickupTimeOther) pickupTimeOther.value = rest;
                syncPickupTimeText();
              }else if(txt.startsWith("امروز")){
                setDay("today");
                if(txt.includes("۹") && txt.includes("۱۲")) setSlot("9-12");
                else if(txt.includes("۱۲") && txt.includes("۱۵")) setSlot("12-15");
                else if(txt.includes("۱۵") && txt.includes("۱۸")) setSlot("15-18");
                else if(txt.includes("۱۸") && txt.includes("۲۱")) setSlot("18-21");
                else syncPickupTimeText();
              }else if(txt.startsWith("فردا")){
                setDay("tomorrow");
                if(txt.includes("۹") && txt.includes("۱۲")) setSlot("9-12");
                else if(txt.includes("۱۲") && txt.includes("۱۵")) setSlot("12-15");
                else if(txt.includes("۱۵") && txt.includes("۱۸")) setSlot("15-18");
                else if(txt.includes("۱۸") && txt.includes("۲۱")) setSlot("18-21");
                else syncPickupTimeText();
              }else{
                resetPickupUI();
                if(txt){
                  setDay("other");
                  if(pickupTimeOther) pickupTimeOther.value = txt;
                  syncPickupTimeText();
                }else{
                  resetPickupUI();
                }
              }
            }else{
              resetPickupUI();
            }
          }else{
            resetPickupUI();
          }
        }catch(_e){
          resetPickupUI();
        }
      }

      function formatMMSS(sec){
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
      }
      function stopTimer(){
        if(timerId) clearInterval(timerId);
        timerId = null;
      }
      function startTimer(seconds){
        stopTimer();
        remaining = seconds;
        resendBtn.disabled = true;
        setStatus(timerPill, "warn", formatMMSS(remaining));

        timerId = setInterval(() => {
          remaining -= 1;
          if(remaining <= 0){
            stopTimer();
            setStatus(timerPill, "ok", "00:00");
            resendBtn.disabled = false;
            return;
          }
          setStatus(timerPill, "warn", formatMMSS(remaining));
        }, 1000);
      }

      async function requestOtpEdge(phone09){
        const res = await fetch(OTP_REQUEST_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09 })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "ارسال کد ناموفق بود");
        }
        return json || { ok: true, expires_in_seconds: 120 };
      }

      async function verifyOtpEdge(phone09, code){
        const res = await fetch(OTP_VERIFY_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ phone: phone09, code })
        });
        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "ورود ناموفق بود");
        }
        return json || { ok: true };
      }

      // ✅ ساخت پرداخت (BitPay)
      async function createBitpayPayment(order){
        if(!order) throw new Error("سفارش نامعتبر است.");

        const orderNo = (order.order_no != null) ? String(order.order_no).trim() : "";
        const orderId = order.id;
        const amountToman = Number(order.quoted_price_toman || 0);

        if(!orderNo) throw new Error("شماره سفارش پیدا نشد.");
        if(!Number.isFinite(amountToman) || amountToman <= 0) throw new Error("مبلغ سفارش معتبر نیست.");

        const payload = {
          order_id: orderId ?? null,
          order_no: orderNo,

          // ✅ FIX: درگاه مبلغ را ریال می‌خواهد (تومان × ۱۰)
          amount: Math.round(amountToman * 10),

          customer_phone: loginState?.phone09 ?? null,
          return_url: buildPayReturnUrl(orderNo)
        };

        const res = await fetch(BITPAY_CREATE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify(payload)
        });

        const json = await safeJson(res);
        if(!res.ok){
          const msg = extractErrorMessage(json) || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if(json && json.ok === false){
          throw new Error(extractErrorMessage(json) || "ساخت پرداخت ناموفق بود");
        }

        const payUrl =
          json?.payment_url ||
          json?.pay_url ||
          json?.url ||
          json?.data?.payment_url ||
          json?.data?.url ||
          null;

        const invoiceId =
          json?.invoice_id ||
          json?.invoice ||
          json?.id ||
          json?.data?.invoice_id ||
          null;

        if(!payUrl || typeof payUrl !== "string"){
          throw new Error("لینک پرداخت از سرور برنگشت.");
        }

        // تلاش برای ذخیره وضعیت پرداخت داخل orders (اگر ستون‌ها وجود داشته باشند)
        try{
          await supabase
            .from("orders")
            .update({
              payment_status: "pending",
              payment_invoice_id: invoiceId ?? null
            })
            .eq("id", orderId);
        }catch(_e){}

        return { payUrl, invoiceId };
      }

      const STATUS_FA = {
        requested: "ثبت شده",
        received: "دریافت شده",
        picked_up: "دریافت با پیک",
        courier_pickup: "دریافت با پیک",
        quoted: "اعلام قیمت",
        repairing: "در حال تعمیر",
        delivering: "در مسیر تحویل",
        delivered: "تحویل شده",
        rejected: "رد شده",
        canceled: "لغو شده"
      };

      const TRACK_STEPS = [
        { key:"requested", title:"ثبت درخواست", desc:"درخواست شما ثبت شد و در حال بررسی است." },
        { key:"picked_up", title:"دریافت با پیک", desc:"پیک موبیکس دستگاه را دریافت کرد." },
        { key:"quoted", title:"اعلام/تأیید هزینه", desc:"هزینه اعلام شد و منتظر تایید شماست." },
        { key:"repairing", title:"در حال تعمیر", desc:"تکنسین موبیکس در حال انجام تعمیر است." },
        { key:"delivering", title:"ارسال برای تحویل", desc:"دستگاه آماده شده و در مسیر تحویل است." },
        { key:"delivered", title:"تحویل به شما", desc:"دستگاه تحویل داده شد ✅" }
      ];

      function normalizeStatus(raw){
        const s0 = (raw || "").toString().trim();
        const s = s0.toLowerCase();

        if(s0.includes("تحویل")) return "delivered";
        if(s0.includes("در مسیر تحویل")) return "delivering";
        if(s0.includes("در حال تعمیر")) return "repairing";
        if(s0.includes("اعلام قیمت") || s0.includes("اعلام/تأیید") || s0.includes("اعلام/تایید")) return "quoted";
        if(s0.includes("دریافت") || s0.includes("پیک")) return "picked_up";
        if(s0.includes("ثبت")) return "requested";
        if(s0.includes("لغو")) return "canceled";
        if(s0.includes("رد")) return "rejected";

        if(["price_quoted","pricequoted","price-quoted"].includes(s)) return "quoted";
        if(["quoted","quote","price","awaiting_approval","approved_pending"].includes(s)) return "quoted";

        if(["new","created","request","requested","pending"].includes(s)) return "requested";

        if(["pickup","pickedup","picked_up","courier_pickup","received"].includes(s)){
          return "picked_up";
        }

        if(["repair","repairing","in_repair","fixing"].includes(s)) return "repairing";
        if(["deliver","delivering","shipping","on_the_way"].includes(s)) return "delivering";
        if(["done","delivered","completed","complete"].includes(s)) return "delivered";
        if(["reject","rejected","declined"].includes(s)) return "rejected";
        if(["cancel","canceled","cancelled"].includes(s)) return "canceled";

        return s || "requested";
      }

      function statusLabelFa(raw){
        const k = normalizeStatus(raw);
        return STATUS_FA[k] || k;
      }

      function stepIndex(key){
        const idx = TRACK_STEPS.findIndex(x => x.key === key);
        return idx < 0 ? 0 : idx;
      }

      function renderTrack(statusKey){
        const norm = normalizeStatus(statusKey);
        const activeIdx = stepIndex(norm);
        return `
          <div class="track">
            ${TRACK_STEPS.map((s, i) => {
              const cls = i < activeIdx ? "done" : (i === activeIdx ? "active" : "");
              const bullet = i < activeIdx ? "✓" : (i === activeIdx ? "•" : (i+1));
              return `
                <div class="track-step ${cls}">
                  <div class="track-bullet">${bullet}</div>
                  <div class="tt">
                    <b>${esc(s.title)}</b>
                    <span>${esc(s.desc)}</span>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }

      function approvalStateFromOrder(o){
        const pa = (o && o.price_approval != null) ? String(o.price_approval).trim().toLowerCase() : "";
        if(pa === "approved") return "approved";
        if(pa === "rejected") return "rejected";
        if(pa === "not_needed") return "not_needed";
        if(pa === "pending") return "pending";
        if(o && o.price_approved === true) return "approved";
        return pa || "pending";
      }

      function approvalLabelFa(state){
        const s = (state || "").toLowerCase();
        if(s === "approved") return "تایید شده";
        if(s === "rejected") return "رد شده";
        if(s === "not_needed") return "نیازی نیست";
        if(s === "pending") return "در انتظار تایید شما";
        return "در انتظار تایید شما";
      }

      function approvalPillClass(state){
        const s = (state || "").toLowerCase();
        if(s === "approved") return "pill ok";
        if(s === "rejected") return "pill err";
        return "pill warn";
      }

      function shouldShowPriceActions(o){
        const stageNorm = normalizeStatus(o?.stage ?? o?.status ?? "");
        const appr = approvalStateFromOrder(o);
        const hasPrice = Number(o?.quoted_price_toman || 0) > 0;
        return hasPrice && stageNorm === "quoted" && appr === "pending";
      }

      function paymentStateFromOrder(o){
        const ps = (o && o.payment_status != null) ? String(o.payment_status).trim().toLowerCase() : "";
        if(ps === "paid" || ps === "success" || ps === "done") return "paid";
        if(ps === "pending" || ps === "created") return "pending";
        if(ps === "failed" || ps === "error") return "failed";
        return ps || "";
      }
      function shouldShowPayButton(o){
        const stageNorm = normalizeStatus(o?.stage ?? o?.status ?? "");
        const appr = approvalStateFromOrder(o);
        const hasPrice = Number(o?.quoted_price_toman || 0) > 0;
        const payState = paymentStateFromOrder(o);

        if(!hasPrice) return false;
        if(appr !== "approved") return false;
        if(payState === "paid") return false;

        if(stageNorm === "quoted" || stageNorm === "repairing" || stageNorm === "picked_up" || stageNorm === "requested"){
          return true;
        }
        return true;
      }

      function openPriceModal(order){
        modalOrder = order || null;
        priceFinalCheck.checked = false;
        priceFinalApproveBtn.disabled = true;
        setMsg(priceModalMsg, "", "");

        const orderNo = modalOrder?.order_no ?? modalOrder?.id ?? "-";
        const priceText = formatToman(modalOrder?.quoted_price_toman) || "—";

        priceModalOrderNo.textContent = "سفارش: " + orderNo;
        priceModalPrice.textContent = priceText;
        priceModalPrice.className = "status ok";

        priceModalBackdrop.style.display = "flex";
        priceModalBackdrop.setAttribute("aria-hidden", "false");
      }

      function closePriceModal(){
        priceModalBackdrop.style.display = "none";
        priceModalBackdrop.setAttribute("aria-hidden", "true");
        modalOrder = null;
        priceFinalCheck.checked = false;
        priceFinalApproveBtn.disabled = true;
        setMsg(priceModalMsg, "", "");
      }

      // ✅ loadOrders امن و کم‌پرش
      async function scheduleLoadOrders(opts){
        const silent = !!opts?.silent;
        if(!loggedIn()) return;

        if(__loadInFlight){
          __loadPending = true;
          return;
        }

        const now = Date.now();
        const delta = now - __lastLoadAt;
        const wait = Math.max(0, LOAD_MIN_GAP_MS - delta);

        if(wait > 0){
          if(__loadPending) return;
          __loadPending = true;
          setTimeout(() => {
            __loadPending = false;
            scheduleLoadOrders({ silent:true, reason:"debounced" });
          }, wait);
          return;
        }

        __loadInFlight = true;
        __lastLoadAt = Date.now();
        try{
          await loadOrders({ silent: silent });
        }finally{
          __loadInFlight = false;
          if(__loadPending){
            __loadPending = false;
            scheduleLoadOrders({ silent:true, reason:"pending" });
          }
        }
      }

      function applyLoginUI(){
        const li = loggedIn();

        if(li){
          setStatus(sessionBadge, "ok", "وارد شده‌اید ✅");
          if(authCard) authCard.style.display = "none";
          if(navLogoutBtn) navLogoutBtn.style.display = "";
          setStatus(orderGate, "ok", "می‌توانید سفارش را ارسال کنید");

          if(guideCard){
            guideCard.style.display = "none";
          }

          if(hasProfileName()){
            helloBadge.style.display = "";
            helloBadge.className = "status ok";
            helloBadge.textContent = "سلام، " + profileState.full_name;
          }else{
            helloBadge.style.display = "none";
          }

          profileCard.style.display = hasProfileName() ? "none" : "";

          handlePaymentReturnIfAny();
        }else{
          setStatus(sessionBadge, "warn", "وارد نشده‌اید");
          if(authCard) authCard.style.display = "";
          if(navLogoutBtn) navLogoutBtn.style.display = "none";
          setStatus(orderGate, "warn", "برای ارسال نهایی باید وارد شوید");

          if(guideCard){
            guideCard.style.display = "";
          }

          profileCard.style.display = "none";
          helloBadge.style.display = "none";

          ordersWrap.innerHTML = '<div class="muted">بعد از ورود، سفارش‌های شما اینجا نمایش داده می‌شود.</div>';
          ordersCount.textContent = "0";
        }
      }

      function stopRealtime(){
        try{
          if(realtimeChannel){
            supabase.removeChannel(realtimeChannel);
            realtimeChannel = null;
          }
        }catch(_e){}
      }
      function stopRealtimeUpdates(){
        try{
          if(updatesRealtimeChannel){
            supabase.removeChannel(updatesRealtimeChannel);
            updatesRealtimeChannel = null;
          }
        }catch(_e){}
      }
      function stopRealtimeChat(){
        try{
          if(chatRealtimeChannel){
            supabase.removeChannel(chatRealtimeChannel);
            chatRealtimeChannel = null;
          }
        }catch(_e){}
      }
      function stopPolling(){
        if(pollTimer) clearInterval(pollTimer);
        pollTimer = null;
      }
      function startPolling(){
        stopPolling();
        // ✅ کندتر (fallback) برای جلوگیری از پرش
        pollTimer = setInterval(() => {
          if(loggedIn()) scheduleLoadOrders({ silent:true, reason:"poll" });
        }, 60000);
      }

      function startRealtime(){
        stopRealtime();
        if(!loggedIn()) return;

        try{
          realtimeChannel = supabase.channel("mobix-orders-realtime")
            .on(
              "postgres_changes",
              {
                event: "*",
                schema: "public",
                table: "orders",
                filter: "customer_phone=eq." + loginState.phone09
              },
              (_payload) => {
                scheduleLoadOrders({ silent:true, reason:"rt-orders" });
              }
            )
            .subscribe((_status) => {});
        }catch(_e){}
      }

      function startRealtimeForUpdatesAndChat(orderNos){
        stopRealtimeUpdates();
        stopRealtimeChat();

        if(!loggedIn()) return;

        const list = (orderNos || []).filter(Boolean);
        if(list.length === 0) return;

        const quoted = list.map(x => '"' + String(x).replaceAll('"','') + '"').join(",");
        const filterIn = "order_no=in.(" + quoted + ")";

        try{
          updatesRealtimeChannel = supabase.channel("mobix-order-updates-rt")
            .on(
              "postgres_changes",
              { event:"*", schema:"public", table:"order_updates", filter: filterIn },
              (_payload) => { scheduleLoadOrders({ silent:true, reason:"rt-updates" }); }
            )
            .subscribe((_status) => {});
        }catch(_e){}

        try{
          chatRealtimeChannel = supabase.channel("mobix-chat-rt")
            .on(
              "postgres_changes",
              { event:"*", schema:"public", table:"chat_messages", filter: filterIn },
              (_payload) => { scheduleLoadOrders({ silent:true, reason:"rt-chat" }); }
            )
            .subscribe((_status) => {});
        }catch(_e){}
      }

      async function sendOtp(){
        setMsg(authMsg, "", "");

        if(!termsAccepted.checked){
          setMsg(authMsg, "err", "برای ادامه، باید قوانین موبیکس را بپذیرید.");
          return;
        }

        const d = normalizeDigits(authPhone.value);
        if(!isValidIranMobile(d)){
          setMsg(authMsg, "err", "شماره موبایل درست نیست. مثل 0912xxxxxxx وارد کنید.");
          return;
        }
        const phone09 = to09(d);
        if(!phone09){
          setMsg(authMsg, "err", "شماره قابل تبدیل نیست. لطفاً دوباره تلاش کنید.");
          return;
        }

        sendOtpBtn.disabled = true;
        resendBtn.disabled = true;
        setMsg(authMsg, "warn", "در حال ارسال کد…");

        try{
          const out = await requestOtpEdge(phone09);
          lastPhone09 = phone09;

          otpWrap.style.display = "";
          setMsg(authMsg, "ok", "کد ارسال شد ✅");

          const secs = Number(out?.expires_in_seconds ?? 120);
          startTimer(Number.isFinite(secs) ? secs : 120);

          authCode.focus();
        }catch(err){
          setMsg(authMsg, "err", "ارسال کد ناموفق بود: " + (err?.message || "خطای نامشخص"));
          otpWrap.style.display = "none";
          stopTimer();
        }finally{
          sendOtpBtn.disabled = false;
        }
      }

      async function verifyOtp(){
        setMsg(authMsg, "", "");
        const code = normalizeDigits(authCode.value);

        if(!lastPhone09){
          setMsg(authMsg, "err", "اول شماره را وارد کنید و کد را ارسال کنید.");
          return;
        }
        if(!code || code.length < 4){
          setMsg(authMsg, "err", "کد پیامکی را درست وارد کنید.");
          return;
        }

        verifyOtpBtn.disabled = true;
        setMsg(authMsg, "warn", "در حال تایید کد…");

        try{
          await verifyOtpEdge(lastPhone09, code);

          loginState = { phone09: lastPhone09 };
          localStorage.setItem(LS_LOGIN, JSON.stringify(loginState));

          authCode.value = "";
          setMsg(authMsg, "ok", "ورود انجام شد ✅");

          applyLoginUI();
          loadDraft();

          startRealtime();
          startPolling();

          await scheduleLoadOrders({ silent:false, reason:"login" });
        }catch(err){
          setMsg(authMsg, "err", "ورود ناموفق بود: " + (err?.message || "خطای نامشخص"));
        }finally{
          verifyOtpBtn.disabled = false;
        }
      }

      async function resend(){
        if(resendBtn.disabled) return;
        if(!lastPhone09){
          setMsg(authMsg, "err", "اول شماره را وارد کنید.");
          return;
        }
        authPhone.value = lastPhone09;
        await sendOtp();
      }

      function logout(){
        setMsg(authMsg, "", "");
        loginState = null;
        localStorage.removeItem(LS_LOGIN);
        lastPhone09 = null;

        otpWrap.style.display = "none";
        stopTimer();

        stopRealtime();
        stopRealtimeUpdates();
        stopRealtimeChat();
        stopPolling();

        setMsg(authMsg, "ok", "خارج شدید.");
        applyLoginUI();
      }

      function loadProfile(){
        try{
          const raw = localStorage.getItem(LS_PROFILE);
          profileState = raw ? JSON.parse(raw) : null;
          if(!profileState || typeof profileState !== "object") profileState = null;
        }catch(_e){
          profileState = null;
        }
      }

      function saveProfile(){
        const n = (fullName.value || "").trim();
        if(n.length < 2){
          profileMsg.style.display = "";
          profileMsg.className = "status err";
          profileMsg.textContent = "نام و نام خانوادگی را درست وارد کنید.";
          return false;
        }
        profileState = { full_name: n };
        localStorage.setItem(LS_PROFILE, JSON.stringify(profileState));

        profileMsg.style.display = "";
        profileMsg.className = "status ok";
        profileMsg.textContent = "ذخیره شد ✅";

        helloBadge.style.display = "";
        helloBadge.className = "status ok";
        helloBadge.textContent = "سلام، " + profileState.full_name;

        profileCard.style.display = "none";
        return true;
      }

      function buildIssueWithExtras(baseIssue){
        const wants = !!(replacementPhone && replacementPhone.checked);
        if(!wants) return baseIssue;
        const suffix = "نیاز به گوشی جایگزین: بله";
        const cur = (baseIssue || "").trim();
        if(!cur) return suffix;
        if(cur.includes(suffix)) return cur;
        return cur + (cur.endsWith("،") || cur.endsWith(",") ? " " : "، ") + suffix;
      }

      async function createOrder(){
        setMsg(orderMsg, "", "");

        const dm = (deviceModel.value || "").trim();
        const issueRaw = (problemDesc.value || "").trim();
        const issue = buildIssueWithExtras(issueRaw);
        const addr = (address.value || "").trim();
        const pt = (pickupTime.value || "").trim();

        if(!loggedIn()){
          setMsg(orderMsg, "warn", "برای ارسال نهایی باید وارد شوید.");
          return;
        }
        if(!hasProfileName()){
          setMsg(orderMsg, "warn", "اول نام و نام خانوادگی را ذخیره کنید.");
          profileCard.style.display = "";
          fullName.focus();
          return;
        }

        if(!dm || !issue || !addr){
          setMsg(orderMsg, "err", "مدل گوشی، مشکل و آدرس را کامل وارد کنید.");
          return;
        }

        createOrderBtn.disabled = true;
        setMsg(orderMsg, "warn", "در حال ثبت سفارش…");

        const payload = {
          order_no: genOrderNo(),
          customer_phone: loginState.phone09,
          customer_name: profileState.full_name,
          device_model: dm,
          issue: issue,
          pickup_address: addr,
          pickup_time_text: pt || null,
          delivery_method: "courier",
          needs_issue_photo: false,
          stage: "requested",
          quoted_price_toman: 0,
          price_approved: false,
          price_approval: "not_needed",
          needs_loaner_phone: !!(replacementPhone && replacementPhone.checked),

          payment_status: null,
          payment_invoice_id: null
        };

        try{
          const { data, error } = await supabase
            .from("orders")
            .insert(payload)
            .select("*")
            .single();

          if(error){
            setMsg(orderMsg, "err", "ثبت سفارش ناموفق بود: " + (error.message || "خطای نامشخص"));
            return;
          }

          if(!data){
            setMsg(orderMsg, "warn", "سفارش ثبت شد ولی پاسخی برنگشت. لطفاً «به‌روزرسانی» را بزنید.");
          }else{
            setMsg(orderMsg, "ok", "سفارش ثبت شد ✅");
          }

          deviceModel.value = "";
          if(replacementPhone) replacementPhone.checked = false;
          problemDesc.value = "";
          address.value = "";
          resetPickupUI();
          localStorage.removeItem(DRAFT_KEY);

          await scheduleLoadOrders({ silent:true, reason:"create-order" });
        }catch(e){
          setMsg(orderMsg, "err", "ثبت سفارش ناموفق بود: " + (e?.message || "خطای نامشخص"));
        }finally{
          createOrderBtn.disabled = false;
        }
      }

      async function updatePriceApproval(order, action){
        if(!order) return;

        const id = order.id;

        if(!id){
          setMsg(priceModalMsg, "err", "شناسه سفارش پیدا نشد.");
          return;
        }

        priceFinalApproveBtn.disabled = true;
        priceFinalRejectBtn.disabled = true;
        setMsg(priceModalMsg, "warn", "در حال ثبت نتیجه…");

        try{
          if(action === "approve"){
            const { error } = await supabase
              .from("orders")
              .update({
                price_approved: true,
                price_approval: "approved"
              })
              .eq("id", id);

            if(error){
              setMsg(priceModalMsg, "err", "ثبت تایید ناموفق بود: " + (error.message || "خطای نامشخص"));
              return;
            }

            setMsg(priceModalMsg, "ok", "قیمت تایید شد ✅ حالا دکمه «پرداخت» فعال است.");
            setTimeout(() => {
              closePriceModal();
              scheduleLoadOrders({ silent:true, reason:"approve-price" });
            }, 900);
          }else if(action === "reject"){
            const { error } = await supabase
              .from("orders")
              .update({
                price_approved: false,
                price_approval: "rejected"
              })
              .eq("id", id);

            if(error){
              setMsg(priceModalMsg, "err", "ثبت رد ناموفق بود: " + (error.message || "خطای نامشخص"));
              return;
            }

            setMsg(priceModalMsg, "ok", "قیمت رد شد ✅");
            setTimeout(() => {
              closePriceModal();
              scheduleLoadOrders({ silent:true, reason:"reject-price" });
            }, 900);
          }else{
            setMsg(priceModalMsg, "err", "عملیات نامعتبر است.");
          }
        }catch(e){
          setMsg(priceModalMsg, "err", "خطا: " + (e?.message || "خطای نامشخص"));
        }finally{
          if(priceModalBackdrop.style.display === "flex"){
            priceFinalRejectBtn.disabled = false;
            priceFinalApproveBtn.disabled = !priceFinalCheck.checked;
          }
        }
      }

      function pickLatestUpdateForOrder(orderNo){
        if(!orderNo) return null;
        return lastKnownUpdates.get(String(orderNo)) || null;
      }

      function normalizeSender(s){
        const x = (s || "").toString().trim().toLowerCase();
        if(["customer","client","user","me","you","مشتری"].includes(x)) return "customer";
        if(["mobix","admin","operator","support","staff","team","پشتیبانی","اپراتور"].includes(x)) return "mobix";
        return x || "mobix";
      }

      function senderLabelFa(s){
        const x = normalizeSender(s);
        if(x === "customer") return "شما";
        if(x === "mobix") return "موبیکس";
        return "موبیکس";
      }

      async function sendChatMessage(orderNo, text){
        const t = (text || "").trim();
        const on = (orderNo || "").trim();
        if(!on) return false;
        if(t.length < 1) return false;

        try{
          const payload = {
            order_no: on,
            sender: "customer",
            text: t
          };

          const { error } = await supabase
            .from("chat_messages")
            .insert(payload);

          if(error){
            alert("ارسال پیام ناموفق بود: " + (error.message || "خطای نامشخص"));
            return false;
          }

          return true;
        }catch(e){
          alert("ارسال پیام ناموفق بود: " + (e?.message || "خطای نامشخص"));
          return false;
        }
      }

      function starsStaticHtml(rating){
        const r = Math.max(0, Math.min(5, Number(rating || 0)));
        return `
          <span class="review-stars-static" aria-label="امتیاز">
            ${[1,2,3,4,5].map(i => i <= r ? `<span>★</span>` : `<span class="off">★</span>`).join("")}
          </span>
        `;
      }

      function computeRenderKey(list){
        try{
          const ordersKey = (list || []).map(o => ({
            id: o?.id ?? null,
            order_no: o?.order_no ?? null,
            stage: o?.stage ?? o?.status ?? null,
            quoted: o?.quoted_price_toman ?? null,
            appr: o?.price_approval ?? (o?.price_approved ? "approved" : null),
            pay: o?.payment_status ?? null,
            inv: o?.payment_invoice_id ?? null,
            ua: o?.updated_at ?? null,
            ca: o?.created_at ?? null
          }));
          const updKey = Array.from(lastKnownUpdates.values()).map(u => ({
            order_no: u?.order_no ?? null,
            message: u?.message ?? null,
            created_at: u?.created_at ?? null,
            stage: u?.stage ?? null
          }));
          const chatKey = Array.from(lastKnownChats.entries()).map(([on, rows]) => {
            const last = (rows && rows.length) ? rows[rows.length-1] : null;
            return {
              order_no: on,
              count: rows ? rows.length : 0,
              last_id: last?.id ?? null,
              last_at: last?.created_at ?? null
            };
          });
          const revKey = Array.from(lastKnownReviews.entries()).map(([oid, r]) => ({
            order_id: oid,
            rating: r?.rating ?? null,
            created_at: r?.created_at ?? null
          }));
          return JSON.stringify({ ordersKey, updKey, chatKey, revKey });
        }catch(_e){
          return String(Date.now());
        }
      }

      async function loadOrders(opts){
        const silent = !!opts?.silent;

        if(!loggedIn()){
          ordersCount.textContent = "0";
          return;
        }

        // ✅ فقط در حالت غیرسایلنت پیام لودینگ بگذار (تا صفحه نپرد)
        if(!silent){
          ordersWrap.innerHTML = '<div class="muted">در حال دریافت سفارش‌ها…</div>';
        }

        const { data, error } = await supabase
          .from("orders")
          .select("*")
          .eq("customer_phone", loginState.phone09)
          .order("created_at", { ascending:false });

        if(error){
          if(!silent){
            ordersWrap.innerHTML = `
              <div class="status err">خواندن سفارش‌ها ناموفق بود</div>
              <div class="hint" style="color:var(--danger)">${esc(error.message || "خطای نامشخص")}</div>
            `;
          }
          ordersCount.textContent = "0";
          return;
        }

        const list = data || [];
        ordersCount.textContent = String(list.length);

        lastKnownOrders.clear();
        list.forEach(o => {
          if(o && Number.isFinite(Number(o.id))){
            lastKnownOrders.set(Number(o.id), o);
          }
        });

        const orderIds = list
          .map(o => Number(o?.id))
          .filter(x => Number.isFinite(x));

        try{
          lastKnownReviews.clear();
          if(orderIds.length > 0){
            const { data: revData, error: revErr } = await supabase
              .from("order_reviews")
              .select("order_id, rating, comment, courier_behavior, repair_quality, service_speed, price_transparency, created_at")
              .in("order_id", orderIds);

            if(!revErr){
              (revData || []).forEach(r => {
                const oid = Number(r?.order_id);
                if(Number.isFinite(oid) && !lastKnownReviews.has(oid)){
                  lastKnownReviews.set(oid, r);
                }
              });
            }
          }
        }catch(_e){}

        if(list.length === 0){
          if(!silent){
            ordersWrap.innerHTML = '<div class="muted">هنوز سفارشی ثبت نکرده‌اید.</div>';
          }
          lastKnownUpdates.clear();
          lastKnownChats.clear();
          stopRealtimeUpdates();
          stopRealtimeChat();
          __lastRenderKey = "";
          return;
        }

        const orderNos = list
          .map(o => (o && o.order_no != null) ? String(o.order_no).trim() : "")
          .filter(x => x.length > 0);

        try{
          if(orderNos.length > 0){
            const { data: updData, error: updErr } = await supabase
              .from("order_updates")
              .select("order_no, stage, message, created_at")
              .in("order_no", orderNos)
              .order("created_at", { ascending:false });

            if(!updErr){
              lastKnownUpdates.clear();
              const rows = updData || [];
              for(const r of rows){
                const on = (r && r.order_no != null) ? String(r.order_no).trim() : "";
                if(!on) continue;
                if(!lastKnownUpdates.has(on)){
                  lastKnownUpdates.set(on, {
                    order_no: on,
                    stage: r.stage ?? null,
                    message: r.message ?? null,
                    created_at: r.created_at ?? null
                  });
                }
              }
            }
          }
        }catch(_e){}

        try{
          if(orderNos.length > 0){
            const { data: chatData, error: chatErr } = await supabase
              .from("chat_messages")
              .select("id, order_no, sender, text, created_at")
              .in("order_no", orderNos)
              .order("created_at", { ascending:true });

            if(!chatErr){
              lastKnownChats.clear();
              const rows = chatData || [];
              for(const r of rows){
                const on = (r && r.order_no != null) ? String(r.order_no).trim() : "";
                if(!on) continue;
                if(!lastKnownChats.has(on)) lastKnownChats.set(on, []);
                lastKnownChats.get(on).push(r);
              }
            }
          }
        }catch(_e){}

        startRealtimeForUpdatesAndChat(orderNos);

        // ✅ اگر داده‌ها تغییر نکرده، رندر نکن (برای جلوگیری از پرش)
        const rk = computeRenderKey(list);
        if(rk === __lastRenderKey){
          return;
        }
        __lastRenderKey = rk;

        ordersWrap.innerHTML = list.map(o => {
          const id = o.order_no ?? o.id ?? "";
          const created = o.created_at ? fmtDate(o.created_at) : "";

          const rawStage = (o.stage != null && String(o.stage).trim() !== "") ? o.stage : (o.status ?? o.state ?? "requested");
          const stNorm = normalizeStatus(rawStage);

          const dm = o.device_model ?? o.model ?? "";
          const pr = o.issue ?? o.problem ?? "";
          const ad = o.pickup_address ?? o.address ?? "";
          const pt = o.pickup_time_text ?? o.pickup_time ?? "";

          const priceText = formatToman(o.quoted_price_toman);
          const hasPrice = !!priceText;

          const appr = approvalStateFromOrder(o);
          const apprLabel = approvalLabelFa(appr);

          const needsLoaner = !!(o.needs_loaner_phone);

          const showActions = shouldShowPriceActions(o);
          const showPay = shouldShowPayButton(o);

          const actionsHtml = showActions ? `
            <div class="price-actions">
              <button class="btn warn" type="button"
                data-act="open-approve"
                data-order-id="${esc(String(o.id ?? ""))}">
                تایید قیمت
              </button>
              <button class="btn danger" type="button"
                data-act="reject-direct"
                data-order-id="${esc(String(o.id ?? ""))}">
                رد قیمت
              </button>
              <span class="status warn">تایید دو مرحله‌ای است</span>
            </div>
          ` : "";

          const payHtml = showPay ? `
            <div class="price-actions">
              <button class="btn primary" type="button"
                data-act="pay-now"
                data-order-id="${esc(String(o.id ?? ""))}">
                پرداخت
              </button>
              <span class="status">درگاه بیت‌پی</span>
            </div>
          ` : "";

          const priceHeaderRight = hasPrice
            ? `<span class="status ok">${esc(priceText)}</span>`
            : `<span class="status warn">در انتظار اعلام قیمت</span>`;

          const apprPill = (stNorm === "quoted" && hasPrice)
            ? `<span class="${approvalPillClass(appr)}">وضعیت قیمت: ${esc(apprLabel)}</span>`
            : (hasPrice ? `<span class="${approvalPillClass(appr)}">وضعیت قیمت: ${esc(apprLabel)}</span>` : "");

          const on = (o.order_no != null) ? String(o.order_no).trim() : "";
          const upd = pickLatestUpdateForOrder(on);
          const updMsg = (upd && upd.message != null) ? String(upd.message).trim() : "";
          const updTime = (upd && upd.created_at) ? fmtDate(upd.created_at) : "";
          const dashHtml = updMsg ? `
            <div class="dash-note">
              <div class="dash-title">
                <b>پیام موبیکس</b>
                ${updTime ? `<span class="dash-time">${esc(updTime)}</span>` : `<span class="dash-time">—</span>`}
              </div>
              ${esc(updMsg)}
            </div>
          ` : "";

          const orderIdNum = Number(o.id);
          const hasReview = Number.isFinite(orderIdNum) && lastKnownReviews.has(orderIdNum);
          const reviewObj = hasReview ? lastKnownReviews.get(orderIdNum) : null;

          const reviewHtml = (stNorm === "delivered")
            ? (hasReview
              ? `
                <div class="review-done">
                  ${starsStaticHtml(reviewObj?.rating)}
                  نظر شما ثبت شد ✅
                </div>
              `
              : `
                <div class="review-box" data-review-box="1" data-order-id="${esc(String(o.id ?? ""))}">
                  <div class="review-top">
                    <b>امتیازدهی و ثبت نظر</b>
                    <span class="status ok">سفارش تحویل شد</span>
                  </div>

                  <div class="muted" style="margin-top:2px">لطفاً تجربه خود را ثبت کنید.</div>

                  <div class="divider"></div>

                  <div class="label" style="margin-top:0">امتیاز</div>
                  <div class="stars" data-stars="1" data-order-id="${esc(String(o.id ?? ""))}">
                    ${[1,2,3,4,5].map(i => `
                      <button class="star-btn" type="button" data-act="set-star" data-order-id="${esc(String(o.id ?? ""))}" data-star="${i}">★</button>
                    `).join("")}
                  </div>
                  <input type="hidden" data-review-rating="1" data-order-id="${esc(String(o.id ?? ""))}" value="0" />

                  <div class="review-options" aria-label="گزینه‌های نظر">
                    <label class="checkrow">
                      <input type="checkbox" data-review-flag="courier_behavior" data-order-id="${esc(String(o.id ?? ""))}" />
                      <div>
                        <b>رفتار پیک</b>
                        <span>برخورد و هماهنگی مناسب</span>
                      </div>
                    </label>

                    <label class="checkrow">
                      <input type="checkbox" data-review-flag="repair_quality" data-order-id="${esc(String(o.id ?? ""))}" />
                      <div>
                        <b>کیفیت تعمیر</b>
                        <span>نتیجه تعمیر رضایت‌بخش</span>
                      </div>
                    </label>

                    <label class="checkrow">
                      <input type="checkbox" data-review-flag="service_speed" data-order-id="${esc(String(o.id ?? ""))}" />
                      <div>
                        <b>سرعت انجام</b>
                        <span>زمان‌بندی مناسب</span>
                      </div>
                    </label>

                    <label class="checkrow">
                      <input type="checkbox" data-review-flag="price_transparency" data-order-id="${esc(String(o.id ?? ""))}" />
                      <div>
                        <b>شفافیت قیمت</b>
                        <span>هزینه واضح و قابل درک</span>
                      </div>
                    </label>
                  </div>

                  <div class="field">
                    <div class="label">نظر شما (اختیاری)</div>
                    <textarea class="textarea" data-review-comment="1" data-order-id="${esc(String(o.id ?? ""))}" placeholder="اگر نکته‌ای هست بنویسید…"></textarea>
                  </div>

                  <div class="review-actions">
                    <button class="btn primary" type="button" data-act="submit-review" data-order-id="${esc(String(o.id ?? ""))}">ثبت نظر</button>
                    <span class="status" data-review-pill="1" data-order-id="${esc(String(o.id ?? ""))}">آماده ثبت</span>
                  </div>

                  <div class="review-msg" data-review-msg="1" data-order-id="${esc(String(o.id ?? ""))}"></div>
                </div>
              `
            )
            : "";

          const chatRows = lastKnownChats.get(on) || [];
          const chatHtml = `
            <details class="chat-details">
              <summary>
                <span>چت درباره این سفارش</span>
                <span class="status">${chatRows.length ? (chatRows.length.toLocaleString("fa-IR") + " پیام") : "بدون پیام"}</span>
              </summary>

              <div class="chat-wrap">
                <div class="chat-messages" data-chat-box="1" data-order-no="${esc(on)}">
                  ${chatRows.length ? chatRows.slice(-50).map(m => {
                    const who = senderLabelFa(m.sender);
                    const isMe = normalizeSender(m.sender) === "customer";
                    const cls = isMe ? "chat-msg me" : "chat-msg other";
                    const when = m.created_at ? fmtDate(m.created_at) : "";
                    const txt = (m.text != null) ? String(m.text) : "";
                    return `
                      <div class="${cls}">
                        <div class="bubble">${esc(txt)}</div>
                        <div class="meta">${esc(who)}${when ? (" • " + esc(when)) : ""}</div>
                      </div>
                    `;
                  }).join("") : `<div class="muted">هنوز پیامی برای این سفارش ثبت نشده است.</div>`}
                </div>

                <div class="chat-input-row">
                  <input class="input" type="text"
                         placeholder="پیام خود را بنویسید…"
                         data-chat-input="1"
                         data-order-no="${esc(on)}" />
                  <button class="btn primary"
                          type="button"
                          data-act="send-chat"
                          data-order-no="${esc(on)}">
                    ارسال پیام
                  </button>
                </div>

                <div class="hint" data-chat-msg="1" data-order-no="${esc(on)}"></div>
              </div>
            </details>
          `;

          const payState = paymentStateFromOrder(o);
          const payPill = payState === "paid"
            ? `<span class="pill ok">پرداخت: انجام شد</span>`
            : (payState === "pending"
              ? `<span class="pill warn">پرداخت: در انتظار تکمیل</span>`
              : (payState === "failed"
                ? `<span class="pill err">پرداخت: ناموفق</span>`
                : ""));

          return `
            <div class="order-item" data-order-row="1" data-order-id="${esc(String(o.id ?? ""))}" data-order-no="${esc(on)}">
              <div class="order-top">
                <b>سفارش #${esc(id)}</b>
                <span class="pill">وضعیت: ${esc(statusLabelFa(stNorm))}</span>
              </div>

              ${payPill ? `<div class="order-top">${payPill}</div>` : ""}

              ${needsLoaner ? `<div class="replacement-note">نیاز به گوشی جایگزین: بله</div>` : ""}

              <div class="muted">
                <b>مدل:</b> ${esc(dm)}<br>
                <b>مشکل:</b> ${esc(pr)}<br>
                <b>آدرس:</b> ${esc(ad)}
                ${pt ? `<br><b>زمان دریافت:</b> ${esc(pt)}` : ""}
                ${created ? `<br><b>ثبت:</b> ${esc(created)}` : ""}
              </div>

              ${dashHtml}

              <div class="divider"></div>

              <div class="order-top">
                <b style="font-weight:900">قیمت</b>
                ${priceHeaderRight}
              </div>

              ${apprPill ? `<div class="order-top">${apprPill}</div>` : ""}

              ${actionsHtml}

              ${payHtml}

              ${renderTrack(stNorm)}

              ${reviewHtml}

              ${chatHtml}
            </div>
          `;
        }).join("");

        try{
          document.querySelectorAll('[data-chat-box="1"]').forEach(box => {
            box.scrollTop = box.scrollHeight;
          });
        }catch(_e){}

        bindOrdersDelegationOnce();
      }

      function setStarUI(orderId, rating){
        const oid = String(orderId || "");
        const r = Math.max(0, Math.min(5, Number(rating || 0)));

        const hidden = ordersWrap.querySelector(`input[data-review-rating="1"][data-order-id="${CSS.escape(oid)}"]`);
        if(hidden) hidden.value = String(r);

        const stars = ordersWrap.querySelectorAll(`button[data-act="set-star"][data-order-id="${CSS.escape(oid)}"]`);
        stars.forEach(btn => {
          const v = Number(btn.getAttribute("data-star") || "0");
          if(v <= r) btn.classList.add("on");
          else btn.classList.remove("on");
        });

        const pill = ordersWrap.querySelector(`span[data-review-pill="1"][data-order-id="${CSS.escape(oid)}"]`);
        if(pill){
          if(r >= 1){
            pill.className = "status ok";
            pill.textContent = "امتیاز انتخاب شد";
          }else{
            pill.className = "status";
            pill.textContent = "آماده ثبت";
          }
        }
      }

      async function submitReview(orderId){
        const oidNum = Number(orderId);
        if(!Number.isFinite(oidNum)) return;

        const oid = String(orderId);

        const msgEl = ordersWrap.querySelector(`div[data-review-msg="1"][data-order-id="${CSS.escape(oid)}"]`);
        const pill = ordersWrap.querySelector(`span[data-review-pill="1"][data-order-id="${CSS.escape(oid)}"]`);
        const hidden = ordersWrap.querySelector(`input[data-review-rating="1"][data-order-id="${CSS.escape(oid)}"]`);
        const commentEl = ordersWrap.querySelector(`textarea[data-review-comment="1"][data-order-id="${CSS.escape(oid)}"]`);

        const rating = Math.max(0, Math.min(5, Number(hidden ? hidden.value : 0)));
        const comment = (commentEl ? commentEl.value : "").trim();

        const courier_behavior = !!ordersWrap.querySelector(`input[data-review-flag="courier_behavior"][data-order-id="${CSS.escape(oid)}"]`)?.checked;
        const repair_quality = !!ordersWrap.querySelector(`input[data-review-flag="repair_quality"][data-order-id="${CSS.escape(oid)}"]`)?.checked;
        const service_speed = !!ordersWrap.querySelector(`input[data-review-flag="service_speed"][data-order-id="${CSS.escape(oid)}"]`)?.checked;
        const price_transparency = !!ordersWrap.querySelector(`input[data-review-flag="price_transparency"][data-order-id="${CSS.escape(oid)}"]`)?.checked;

        if(msgEl){
          msgEl.textContent = "";
          msgEl.style.color = "var(--muted)";
        }

        if(rating < 1){
          if(pill){
            pill.className = "status warn";
            pill.textContent = "امتیاز را انتخاب کنید";
          }
          if(msgEl){
            msgEl.style.color = "var(--danger)";
            msgEl.textContent = "برای ثبت نظر، ابتدا امتیاز را انتخاب کنید.";
          }
          return;
        }

        if(pill){
          pill.className = "status warn";
          pill.textContent = "در حال ثبت…";
        }

        try{
          const payload = {
            order_id: oidNum,
            rating: rating,
            comment: comment || null,
            courier_behavior: courier_behavior,
            repair_quality: repair_quality,
            service_speed: service_speed,
            price_transparency: price_transparency
          };

          const { error } = await supabase
            .from("order_reviews")
            .insert(payload);

          if(error){
            if(pill){
              pill.className = "status err";
              pill.textContent = "ناموفق";
            }
            if(msgEl){
              msgEl.style.color = "var(--danger)";
              msgEl.textContent = "ثبت نظر ناموفق بود: " + (error.message || "خطای نامشخص");
            }
            return;
          }

          if(pill){
            pill.className = "status ok";
            pill.textContent = "ثبت شد ✅";
          }
          if(msgEl){
            msgEl.style.color = "var(--success)";
            msgEl.textContent = "نظر شما ثبت شد ✅";
          }

          setTimeout(() => scheduleLoadOrders({ silent:true, reason:"review" }), 600);
        }catch(e){
          if(pill){
            pill.className = "status err";
            pill.textContent = "ناموفق";
          }
          if(msgEl){
            msgEl.style.color = "var(--danger)";
            msgEl.textContent = "خطا: " + (e?.message || "خطای نامشخص");
          }
        }
      }

      async function handlePayNow(order){
        if(!order) return;

        const amount = Number(order.quoted_price_toman || 0);
        if(!Number.isFinite(amount) || amount <= 0){
          alert("مبلغ سفارش مشخص نیست.");
          return;
        }

        const ok = confirm("انتقال به درگاه پرداخت؟");
        if(!ok) return;

        try{
          const { payUrl } = await createBitpayPayment(order);
          window.location.href = payUrl;
        }catch(e){
          alert("ساخت پرداخت ناموفق بود: " + (e?.message || "خطای نامشخص"));
        }
      }

      function bindOrdersDelegationOnce(){
        if(ordersWrap.__mobixDelegationAttached) return;

        ordersWrap.addEventListener("click", async (e) => {
          const target = e.target;
          if(!target) return;

          const btnStar = target.closest("button[data-act='set-star']");
          if(btnStar){
            const oid = btnStar.getAttribute("data-order-id");
            const v = Number(btnStar.getAttribute("data-star") || "0");
            if(!oid) return;
            setStarUI(oid, v);
            return;
          }

          const btn = target.closest("button[data-act]");
          if(!btn) return;

          const act = btn.getAttribute("data-act");

          if(act === "open-approve" || act === "reject-direct" || act === "pay-now"){
            const idStr = btn.getAttribute("data-order-id");
            const orderId = Number(idStr);

            if(!Number.isFinite(orderId)) return;
            const order = lastKnownOrders.get(orderId);
            if(!order) return;

            if(act === "open-approve"){
              openPriceModal(order);
              return;
            }

            if(act === "reject-direct"){
              const ok = confirm("قیمت را رد می‌کنید؟ این کار قابل بازگشت نیست.");
              if(!ok) return;

              try{
                btn.disabled = true;
                const { error } = await supabase
                  .from("orders")
                  .update({
                    price_approved: false,
                    price_approval: "rejected"
                  })
                  .eq("id", orderId);

                if(error){
                  alert("ثبت رد ناموفق بود: " + (error.message || "خطای نامشخص"));
                  btn.disabled = false;
                  return;
                }

                await scheduleLoadOrders({ silent:true, reason:"reject-direct" });
              }catch(ex){
                alert("خطا: " + (ex?.message || "خطای نامشخص"));
              }finally{
                btn.disabled = false;
              }
              return;
            }

            if(act === "pay-now"){
              btn.disabled = true;
              try{
                await handlePayNow(order);
              }finally{
                btn.disabled = false;
              }
              return;
            }
          }

          if(act === "send-chat"){
            const orderNo = (btn.getAttribute("data-order-no") || "").trim();
            if(!orderNo) return;

            const input = ordersWrap.querySelector(`input[data-chat-input="1"][data-order-no="${CSS.escape(orderNo)}"]`);
            const msgEl = ordersWrap.querySelector(`div[data-chat-msg="1"][data-order-no="${CSS.escape(orderNo)}"]`);
            const text = input ? input.value : "";

            if(msgEl){
              msgEl.textContent = "";
              msgEl.style.color = "var(--muted)";
            }

            if(!text || !text.trim()){
              return;
            }

            btn.disabled = true;
            if(msgEl){
              msgEl.style.color = "var(--warn)";
              msgEl.textContent = "در حال ارسال پیام…";
            }

            const ok = await sendChatMessage(orderNo, text);

            if(ok){
              if(input) input.value = "";
              if(msgEl){
                msgEl.style.color = "var(--success)";
                msgEl.textContent = "ارسال شد ✅";
              }
              await scheduleLoadOrders({ silent:true, reason:"chat-send" });
            }else{
              if(msgEl){
                msgEl.style.color = "var(--danger)";
                msgEl.textContent = "ارسال ناموفق بود.";
              }
            }

            btn.disabled = false;
            return;
          }

          if(act === "submit-review"){
            const oid = btn.getAttribute("data-order-id");
            if(!oid) return;
            btn.disabled = true;
            await submitReview(oid);
            btn.disabled = false;
            return;
          }
        });

        ordersWrap.addEventListener("keydown", async (e) => {
          const target = e.target;
          if(!target) return;

          const inp = target.closest('input[data-chat-input="1"]');
          if(!inp) return;

          if(e.key === "Enter"){
            e.preventDefault();
            const orderNo = (inp.getAttribute("data-order-no") || "").trim();
            if(!orderNo) return;

            const sendBtn = ordersWrap.querySelector(`button[data-act="send-chat"][data-order-no="${CSS.escape(orderNo)}"]`);
            if(sendBtn && !sendBtn.disabled){
              sendBtn.click();
            }
          }
        });

        ordersWrap.__mobixDelegationAttached = true;
      }

      try{
        const raw = localStorage.getItem(LS_LOGIN);
        loginState = raw ? JSON.parse(raw) : null;
      }catch(_e){
        loginState = null;
      }

      loadProfile();

      if(fullName){
        fullName.value = hasProfileName() ? String(profileState.full_name) : "";
        fullName.setAttribute("placeholder", "نام و نام خانوادگی");
      }

      handlePaymentReturnIfAny();

      applyLoginUI();
      loadDraft();

      if(loggedIn()){
        startRealtime();
        startPolling();
        scheduleLoadOrders({ silent:false, reason:"init" });
      }else{
        stopRealtime();
        stopRealtimeUpdates();
        stopRealtimeChat();
        stopPolling();
      }

      document.querySelectorAll("[data-pick-day]").forEach(btn => {
        btn.addEventListener("click", () => {
          const day = btn.getAttribute("data-pick-day");
          if(!day) return;
          setDay(day);
        });
      });
      document.querySelectorAll("[data-pick-slot]").forEach(btn => {
        btn.addEventListener("click", () => {
          const slot = btn.getAttribute("data-pick-slot");
          if(!slot) return;
          if(pickupDay !== "today" && pickupDay !== "tomorrow"){
            setDay("today");
          }
          setSlot(slot);
        });
      });
      if(pickupTimeOther){
        pickupTimeOther.addEventListener("input", () => syncPickupTimeText());
        pickupTimeOther.addEventListener("change", () => syncPickupTimeText());
      }
      if(pickupTimePreview && !pickupTimePreview.textContent){
        pickupTimePreview.textContent = "برای سرعت بیشتر، روز و بازه را انتخاب کنید (یا «زمان دیگر»).";
      }

      sendOtpBtn.addEventListener("click", sendOtp);
      verifyOtpBtn.addEventListener("click", verifyOtp);
      resendBtn.addEventListener("click", resend);

      if(navLogoutBtn) navLogoutBtn.addEventListener("click", logout);
      if(logoutBtn) logoutBtn.addEventListener("click", logout);

      if(saveProfileBtn) saveProfileBtn.addEventListener("click", () => {
        const ok = saveProfile();
        if(ok){
          applyLoginUI();
        }
      });

      createOrderBtn.addEventListener("click", createOrder);
      refreshOrdersBtn.addEventListener("click", () => scheduleLoadOrders({ silent:false, reason:"manual-refresh" }));

      [deviceModel, problemDesc, address, replacementPhone].forEach(el => {
        if(!el) return;
        el.addEventListener("input", () => saveDraft());
        el.addEventListener("change", () => saveDraft());
      });

      document.querySelectorAll(".qchip").forEach(btn => {
        btn.addEventListener("click", () => {
          const val = (btn.getAttribute("data-issue") || "").trim();
          if(!val) return;
          const cur = (problemDesc.value || "").trim();
          const next = cur ? (cur + (cur.endsWith("،") || cur.endsWith(",") ? " " : "، ") + val) : val;
          problemDesc.value = next;
          problemDesc.focus();
          saveDraft();
        });
      });

      function closeByBackdrop(e){
        if(e.target === priceModalBackdrop) closePriceModal();
      }
      priceModalBackdrop.addEventListener("click", closeByBackdrop);

      priceModalClose.addEventListener("click", closePriceModal);
      priceModalCancel.addEventListener("click", closePriceModal);

      priceFinalCheck.addEventListener("change", () => {
        priceFinalApproveBtn.disabled = !priceFinalCheck.checked;
      });

      priceFinalApproveBtn.addEventListener("click", async () => {
        if(!modalOrder) return;
        if(!priceFinalCheck.checked) return;
        await updatePriceApproval(modalOrder, "approve");
      });

      priceFinalRejectBtn.addEventListener("click", async () => {
        if(!modalOrder) return;
        const ok = confirm("قیمت را رد می‌کنید؟");
        if(!ok) return;
        await updatePriceApproval(modalOrder, "reject");
      });

      if(payBannerClose){
        payBannerClose.addEventListener("click", () => hidePayBanner());
      }

    })();
  </script>
</body>
</html>
