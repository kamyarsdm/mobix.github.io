<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mobix | نتیجه پرداخت</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#1F6AFF" />
  <style>
    :root{--bg:#F6F8FC;--card:#fff;--text:#0B1220;--muted:#5B6B84;--line:rgba(15,23,42,.08);--primary:#1F6AFF}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 500px at 80% -10%, rgba(31,106,255,.16), transparent 55%),
                  radial-gradient(900px 600px at 20% 10%, rgba(59,130,246,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:720px;margin:0 auto;padding:22px 16px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      padding:18px;
      box-shadow: 0 14px 36px rgba(15,23,42,.10);
    }
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0;color:var(--muted);line-height:1.9}
    .row{margin-top:14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:800;font-size:13px;
      color:var(--muted);
    }
    .pill.ok{border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.08);color:#0B3A2C}
    .pill.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:#78350F}
    .pill.err{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:#7F1D1D}
    .btn{
      margin-top:14px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{background:linear-gradient(135deg,var(--primary),#3B82F6);color:#fff;border:none}
    .muted{color:var(--muted);font-size:13px;margin-top:10px;white-space:pre-line;line-height:1.9}
    .small{font-size:12.5px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">در حال انتقال به صفحه سفارش…</h1>
      <p id="subtitle">چند لحظه صبر کنید. اگر منتقل نشدید، روی دکمه زیر بزنید.</p>

      <div class="row">
        <span id="pill" class="pill warn">در حال پردازش</span>
        <span id="orderPill" class="pill">سفارش: —</span>
      </div>

      <button id="goBtn" class="btn primary" type="button">رفتن به صفحه سفارش</button>

      <div id="dbg" class="muted small"></div>
    </div>
  </div>

  <script>
    (function(){
      const PENDING_PAY_KEY = "mobix_pending_payment_result";

      function qs(){
        try{ return new URL(window.location.href).searchParams; }
        catch(e){ return new URLSearchParams(); }
      }

      function norm(s){
        return (s || "").toString().trim().toLowerCase();
      }

      function detectStatus(sp){
        const s1 = norm(sp.get("payment_status"));
        const s2 = norm(sp.get("status"));
        const s3 = norm(sp.get("result"));
        const s4 = norm(sp.get("res"));
        const s5 = norm(sp.get("ok"));
        const msg = norm(sp.get("msg") || sp.get("message"));

        const combined = [s1,s2,s3,s4,s5,msg].filter(Boolean).join("|");

        // اگر همزمان مثبت و منفی بود، منفی اولویت دارد
        const hasNeg =
          combined.includes("cancel") ||
          combined.includes("canceled") ||
          combined.includes("cancelled") ||
          combined.includes("fail") ||
          combined.includes("failed") ||
          combined.includes("error") ||
          combined.includes("انصراف") ||
          combined.includes("لغو") ||
          combined.includes("ناموفق");

        const hasPos =
          combined.includes("success") ||
          combined.includes("succeed") ||
          combined.includes("paid") ||
          combined.includes("ok=true") ||
          combined.includes("ok=1") ||
          combined.includes("پرداخت موفق") ||
          combined.includes("موفق");

        if(hasNeg) return "failed";
        if(hasPos) return "success";
        return "unknown";
      }

      const sp = qs();
      const orderNo = (sp.get("order_no") || "").trim();

      const transId = (sp.get("trans_id") || "").trim();
      const idGet   = (sp.get("id_get") || "").trim();
      const invoice = (sp.get("invoice_id") || sp.get("invoice") || "").trim();

      const pill = document.getElementById("pill");
      const orderPill = document.getElementById("orderPill");
      const dbg = document.getElementById("dbg");
      const goBtn = document.getElementById("goBtn");
      const title = document.getElementById("title");
      const subtitle = document.getElementById("subtitle");

      if(orderPill){
        orderPill.textContent = orderNo ? ("سفارش: " + orderNo) : "سفارش: —";
      }

      const status = detectStatus(sp);

      let displayText = "";
      if(status === "success"){
        if(pill){
          pill.className = "pill ok";
          pill.textContent = "پرداخت موفق ✅";
        }
        if(title) title.textContent = "پرداخت با موفقیت انجام شد ✅";
        if(subtitle) subtitle.textContent = "در حال بازگشت به صفحه سفارش…";
        displayText = "success";
      }else if(status === "failed"){
        if(pill){
          pill.className = "pill err";
          pill.textContent = "پرداخت ناموفق / لغو شد ❌";
        }
        if(title) title.textContent = "پرداخت ناموفق یا لغو شد ❌";
        if(subtitle) subtitle.textContent = "در حال بازگشت به صفحه سفارش…";
        displayText = "failed";
      }else{
        if(pill){
          pill.className = "pill warn";
          pill.textContent = "وضعیت پرداخت نامشخص";
        }
        if(title) title.textContent = "وضعیت پرداخت نامشخص";
        if(subtitle) subtitle.textContent = "ممکن است پرداخت لغو شده باشد یا هنوز تأیید نشده باشد. در صفحه سفارش وضعیت را بررسی کنید.";
        displayText = "unknown";
      }

      try{
        sessionStorage.setItem(PENDING_PAY_KEY, JSON.stringify({
          payment_status: displayText,
          order_no: orderNo || ""
        }));
      }catch(_e){}

      if(dbg){
        const lines = [];
        lines.push("detected_status: " + displayText);
        if(orderNo) lines.push("order_no: " + orderNo);
        if(transId) lines.push("trans_id: " + transId);
        if(idGet) lines.push("id_get: " + idGet);
        if(invoice) lines.push("invoice: " + invoice);

        const ps = (sp.get("payment_status") || "");
        const st = (sp.get("status") || "");
        const rs = (sp.get("result") || "");
        const mg = (sp.get("msg") || sp.get("message") || "");

        if(ps) lines.push("payment_status(qs): " + ps);
        if(st) lines.push("status(qs): " + st);
        if(rs) lines.push("result(qs): " + rs);
        if(mg) lines.push("msg(qs): " + mg);

        dbg.textContent = lines.join("\n");
      }

      const target = window.location.origin + "/order/";

      function go(){
        window.location.replace(target);
      }

      if(goBtn){
        goBtn.addEventListener("click", go);
      }

      setTimeout(go, 900);
    })();
  </script>
</body>
</html>
